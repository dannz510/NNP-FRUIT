<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NNP|FRUITü•ù</title>
    <link rel="icon" type="image/x-icon" href="NNP.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F7F4; /* Light mode default */
            display: flex; /* Ensure body is flex for main layout */
            min-height: 100vh; /* Full viewport height */
            color: #333; /* Default text color for light mode */
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body.dark-mode {
            background-color: #1a202c; /* Dark mode background */
            color: #e2e8f0; /* Dark mode text color */
        }
        .dark-mode .bg-white {
            background-color: #2d3748; /* Darker background for cards */
        }
        .dark-mode .bg-gray-50 {
            background-color: #4a5568; /* Darker background for gray sections */
        }
        .dark-mode .text-gray-800 {
            color: #e2e8f0;
        }
        .dark-mode .text-gray-700 {
            color: #cbd5e0;
        }
        .dark-mode .text-gray-600 {
            color: #a0aec0;
        }
        .dark-mode .border {
            border-color: #4a5568;
        }
        .dark-mode .nav-item {
            color: #e2e8f0;
        }
        .dark-mode .nav-item.active {
            background-color: #4CAF50;
            color: white;
        }
        .dark-mode .nav-item:hover {
            background-color: #4a5568;
        }
        .dark-mode table th {
            background-color: #2d3748;
            color: #e2e8f0;
        }
        .dark-mode table td {
            border-color: #4a5568;
        }
        .dark-mode input, .dark-mode select {
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #616e7f;
        }
        .dark-mode input:focus, .dark-mode select:focus {
            border-color: #63b3ed;
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.5);
        }

        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .nav-item.active {
            background-color: #4CAF50;
            color: white;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .low-stock-alert {
            background-color: #ffe0b2; /* Light orange */
            color: #e65100; /* Darker orange */
            font-weight: 500;
        }
        .expiry-warning {
            background-color: #ffccbc; /* Light red-orange */
            color: #d84315; /* Darker red-orange */
            font-weight: 500;
        }
        .kpi-not-met {
            background-color: #ffcdd2; /* Light red */
            color: #c62828; /* Darker red */
            font-weight: 500;
        }
        .kpi-met {
            background-color: #c8e6c9; /* Light green */
            color: #2e7d32; /* Darker green */
            font-weight: 500;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 500px;
            text-align: center;
        }
        .dark-mode .modal-content {
            background-color: #2d3748;
        }
        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 16px;
            margin-top: 20px;
        }

        /* Toast Styles */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1001;
            display: flex;
            flex-direction: column-reverse; /* New toasts appear at the bottom */
            gap: 10px;
        }
        .toast {
            background-color: #333;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            font-size: 0.9rem;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            min-width: 200px;
            text-align: center;
        }
        .toast.show {
            opacity: 1;
        }
        .toast.success {
            background-color: #4CAF50;
        }
        .toast.error {
            background-color: #f44336;
        }
        .toast.info {
            background-color: #2196F3;
        }

    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">
    <!-- Thanh ƒêi·ªÅu H∆∞·ªõng B√™n Tr√°i -->
    <nav class="w-full md:w-64 bg-white p-6 shadow-lg rounded-xl m-4 flex-shrink-0">
        <div class="text-xl font-bold text-gray-800 mb-6">Qu·∫£n l√Ω Kinh doanh</div>
        <ul class="space-y-2">
            <li>
                <button id="nav-tongquan" class="nav-item nav-section-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700 active">
                    T·ªïng quan
                </button>
            </li>
            <li>
                <button id="nav-khachhang" class="nav-item nav-section-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Kh√°ch h√†ng
                </button>
            </li>
            <li>
                <button id="nav-thucphamkho" class="nav-item nav-section-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Th·ª±c ph·∫©m & Kho
                </button>
            </li>
            <li>
                <button id="nav-taichinh" class="nav-item nav-section-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    T√†i ch√≠nh
                </button>
            </li>
            <li>
                <button id="nav-quanlymathang" class="nav-item nav-section-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Qu·∫£n l√Ω M·∫∑t h√†ng
                </button>
            </li>
            <li>
                <button id="nav-quanlykhuyenmai" class="nav-item nav-section-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Qu·∫£n l√Ω Khuy·∫øn m√£i
                </button>
            </li>
            <li>
                <button id="nav-quanlydulieu" class="nav-item nav-section-btn w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Qu·∫£n l√Ω D·ªØ li·ªáu
                </button>
            </li>
            <li class="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button id="theme-toggle" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition duration-200 ease-in-out font-medium text-gray-700 dark:text-gray-200">
                    Ch·∫ø ƒë·ªô <span id="current-theme">S√°ng ‚òÄÔ∏è</span>
                </button>
            </li>
        </ul>
    </nav>

    <!-- Khu V·ª±c N·ªôi Dung Ch√≠nh -->
    <main class="flex-grow p-4 md:p-8">
        <!-- T·ªïng quan Section -->
        <section id="section-tongquan" class="content-section active bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">T·ªïng quan</h2>
            <p class="text-gray-600 mb-6">Ph·∫ßn n√†y cung c·∫•p m·ªôt c√°i nh√¨n t·ªïng th·ªÉ v·ªÅ hi·ªáu su·∫•t kinh doanh c·ªßa b·∫°n, bao g·ªìm c√°c ch·ªâ s·ªë ch√≠nh v√† xu h∆∞·ªõng quan tr·ªçng. B·∫°n c√≥ th·ªÉ ch·ªçn kho·∫£ng th·ªùi gian ƒë·ªÉ xem c√°c ch·ªâ s·ªë.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="start-date-filter" class="block text-sm font-medium text-gray-700">T·ª´ ng√†y</label>
                    <input type="date" id="start-date-filter" class="mt-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                </div>
                <div>
                    <label for="end-date-filter" class="block text-sm font-medium text-gray-700">ƒê·∫øn ng√†y</label>
                    <input type="date" id="end-date-filter" class="mt-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">T·ªïng thu nh·∫≠p</div>
                    <div id="total-income-range" class="text-3xl font-bold text-blue-600">0 VNƒê</div>
                </div>
                <div class="bg-green-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Kh√°ch h√†ng t∆∞∆°ng t√°c</div>
                    <div id="customers-in-range" class="text-3xl font-bold text-green-600">0</div>
                </div>
                <div class="bg-red-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">L·ª£i nhu·∫≠n ∆∞·ªõc t√≠nh</div>
                    <div id="profit-in-range" class="text-3xl font-bold text-red-600">0 VNƒê</div>
                </div>
                 <div class="bg-purple-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">T·ªïng s·ªë kh√°ch h√†ng</div>
                    <div id="total-customers-kpi" class="text-3xl font-bold text-purple-600">0</div>
                </div>
                <div class="bg-yellow-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">T·ªïng s·ªë m·∫∑t h√†ng</div>
                    <div id="total-products-kpi" class="text-3xl font-bold text-yellow-600">0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div id="daily-income-chart-card" class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Xu h∆∞·ªõng Thu nh·∫≠p (7 ng√†y qua)</h3>
                        <button class="toggle-chart-visibility bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 px-3 py-1 rounded-md text-sm" data-target="daily-income-chart-card">·∫®n</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="dailyIncomeChart"></canvas>
                    </div>
                </div>
                <div id="profit-by-food-chart-card" class="bg-white p-4 rounded-lg shadow-md">
                     <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">L·ª£i nhu·∫≠n theo Th·ª±c ph·∫©m (Top 5)</h3>
                        <button class="toggle-chart-visibility bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 px-3 py-1 rounded-md text-sm" data-target="profit-by-food-chart-card">·∫®n</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="profitByFoodChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="daily-kpi-card" class="bg-gray-50 p-4 rounded-lg shadow-sm">
                 <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-700">Hi·ªáu su·∫•t KPI h√†ng ng√†y</h3>
                    <button class="toggle-chart-visibility bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 px-3 py-1 rounded-md text-sm" data-target="daily-kpi-card">·∫®n</button>
                </div>
                <div class="mb-4">
                    <label for="kpi-target-percentage" class="block text-sm font-medium text-gray-700 mb-1">Ng∆∞·ª°ng ƒë·∫°t ch·ªâ ti√™u KPI (%):</label>
                    <input type="number" id="kpi-target-percentage" value="80" min="0" max="100" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-1/2">
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden">
                        <thead>
                            <tr>
                                <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg">M·∫∑t h√†ng</th>
                                <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider">M·ª•c ti√™u h√†ng ng√†y</th>
                                <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider">Th·ª±c b√°n h√¥m nay</th>
                                <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider">KPI (%)</th>
                                <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="daily-kpi-table-body">
                            <!-- Daily KPI data will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <button id="update-kpi-targets-btn" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 ease-in-out w-full">C·∫≠p nh·∫≠t ch·ªâ ti√™u KPI cho ng√†y ti·∫øp theo</button>
            </div>
        </section>

        <!-- Kh√°ch h√†ng Section -->
        <section id="section-khachhang" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Qu·∫£n l√Ω Kh√°ch h√†ng</h2>
            <p class="text-gray-600 mb-6">Theo d√µi th√¥ng tin v√† l·ªãch s·ª≠ t∆∞∆°ng t√°c v·ªõi kh√°ch h√†ng c·ªßa b·∫°n ƒë·ªÉ ƒë·∫£m b·∫£o vi·ªác theo d√µi hi·ªáu qu·∫£.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Th√™m kh√°ch h√†ng m·ªõi / L·ªãch theo d√µi</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="customer-name" placeholder="T√™n kh√°ch h√†ng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="customer-phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="date" id="customer-last-contact" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="date" id="customer-next-followup" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <select id="customer-status" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="ƒêang theo d√µi">ƒêang theo d√µi</option>
                        <option value="ƒê√£ li√™n h·ªá">ƒê√£ li√™n h·ªá</option>
                        <option value="ƒê√£ ho√†n th√†nh">ƒê√£ ho√†n th√†nh</option>
                        <option value="T·∫°m d·ª´ng">T·∫°m d·ª´ng</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="customer-tier" class="block text-sm font-medium text-gray-700 mb-1">H·∫°ng kh√°ch h√†ng:</label>
                    <select id="customer-tier" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="Th√†nh vi√™n">Th√†nh vi√™n</option>
                        <option value="B·∫°c">B·∫°c</option>
                        <option value="V√†ng">V√†ng</option>
                        <option value="Kim c∆∞∆°ng">Kim c∆∞∆°ng</option>
                    </select>
                </div>
                <button id="add-customer-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Th√™m kh√°ch h√†ng</button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">T√™n Kh√°ch h√†ng &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="phoneNumber">S·ªë ƒëi·ªán tho·∫°i &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="lastContact">Ng√†y t∆∞∆°ng t√°c cu·ªëi &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="nextFollowup">Ng√†y theo d√µi ti·∫øp &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="status">Tr·∫°ng th√°i &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="purchaseCount">L∆∞·ª£t mua &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="loyaltyPoints">ƒêi·ªÉm t√≠ch l≈©y &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="tier">H·∫°ng &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="customer-table-body">
                        <!-- Customer data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-customers-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xu·∫•t CSV Kh√°ch h√†ng</button>
            </div>
        </section>

        <!-- Th·ª±c ph·∫©m & Kho Section -->
        <section id="section-thucphamkho" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Qu·∫£n l√Ω Th·ª±c ph·∫©m & Kho</h2>
            <p class="text-gray-600 mb-6">Gi√°m s√°t t·ªìn kho th·ª±c ph·∫©m, theo d√µi chi ph√≠ mua h√†ng v√† qu·∫£n l√Ω c√°c bi·∫øn ph√≠ li√™n quan ƒë·∫øn v·∫≠n h√†nh.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- T·ªìn kho th·ª±c ph·∫©m -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">T·ªìn kho th·ª±c ph·∫©m</h3>
                    <div class="mb-4">
                        <label for="low-stock-threshold" class="block text-sm font-medium text-gray-700 mb-1">Ng∆∞·ª°ng t·ªìn kho th·∫•p:</label>
                        <input type="number" id="low-stock-threshold" value="10" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 w-full">
                    </div>
                     <div class="mb-4">
                        <label for="min-days-before-expiry-warning" class="block text-sm font-medium text-gray-700 mb-1">C·∫£nh b√°o h·∫øt h·∫°n (Ng√†y):</label>
                        <input type="number" id="min-days-before-expiry-warning" value="14" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 w-full">
                    </div>
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <input type="text" id="food-item-name" list="product-names-list" placeholder="T√™n th·ª±c ph·∫©m" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <datalist id="product-names-list"></datalist>
                        <div class="flex gap-2">
                            <input type="number" id="food-item-quantity" placeholder="S·ªë l∆∞·ª£ng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                            <input type="text" id="food-item-unit" placeholder="ƒê∆°n v·ªã (kg, l√≠t, c√°i...)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                        </div>
                    </div>
                    <button id="add-food-item-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Th√™m/C·∫≠p nh·∫≠t t·ªìn kho</button>
                    <div class="overflow-x-auto mt-4 rounded-lg shadow-md">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">T√™n Th·ª±c ph·∫©m &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="quantity">S·ªë l∆∞·ª£ng &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="unit">ƒê∆°n v·ªã &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="expiryDate">Ng√†y h·∫øt h·∫°n &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">H√†nh ƒë·ªông</th>
                                </tr>
                            </thead>
                            <tbody id="food-inventory-table-body">
                                <!-- Food inventory data will be inserted here -->
                            </tbody>
                        </table>
                        <button id="export-food-inventory-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xu·∫•t CSV T·ªìn kho</button>
                    </div>
                </div>

                <!-- Mua h√†ng & Bi·∫øn ph√≠ -->
                <div class="grid grid-cols-1 gap-6">
                    <!-- Th√™m Giao d·ªãch Mua h√†ng -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Th√™m Giao d·ªãch Mua h√†ng</h3>
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <input type="text" id="purchase-item-name" list="product-names-list" placeholder="T√™n m·∫∑t h√†ng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="purchase-quantity" placeholder="S·ªë l∆∞·ª£ng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="text" id="purchase-unit" placeholder="ƒê∆°n v·ªã (kg, l√≠t, c√°i...)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="purchase-price-per-unit" placeholder="Gi√° mua m·ªói ƒë∆°n v·ªã (VNƒê)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="date" id="purchase-date" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <button id="add-purchase-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Th√™m Giao d·ªãch Mua</button>
                        <div class="overflow-x-auto mt-4 rounded-lg shadow-md">
                            <h3 class="text-md font-semibold text-gray-800 mb-2 p-2">L·ªãch s·ª≠ Mua h√†ng</h3>
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead>
                                    <tr>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="itemName">M·∫∑t h√†ng &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="quantity">SL &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="purchasePrice">Gi√°/ƒê∆°n v·ªã &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="totalCost">T·ªïng chi ph√≠ &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="date">Ng√†y &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="purchase-history-table-body">
                                    <!-- Purchase history data will be inserted here -->
                                </tbody>
                            </table>
                            <button id="export-purchase-history-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xu·∫•t CSV L·ªãch s·ª≠ Mua h√†ng</button>
                        </div>
                    </div>

                    <!-- Bi·∫øn ph√≠ kh√°c -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Th√™m Bi·∫øn ph√≠ kh√°c</h3>
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <input type="text" id="other-expense-description" placeholder="M√¥ t·∫£ (v√≠ d·ª•: Ti·ªÅn ƒëi·ªán, Ti·∫øp th·ªã)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="other-expense-amount" placeholder="S·ªë ti·ªÅn (VNƒê)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="date" id="other-expense-date" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <button id="add-other-expense-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Th√™m Bi·∫øn ph√≠</button>
                        <div class="overflow-x-auto mt-4 rounded-lg shadow-md">
                             <h3 class="text-md font-semibold text-gray-800 mb-2 p-2">L·ªãch s·ª≠ Bi·∫øn ph√≠ kh√°c</h3>
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead>
                                    <tr>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="description">M√¥ t·∫£ &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="amount">S·ªë ti·ªÅn (VNƒê) &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="date">Ng√†y &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">H√†nh ƒë·ªông</th>
                                    </tr>
                                </thead>
                                <tbody id="other-expense-table-body">
                                    <!-- Other expense data will be inserted here -->
                                </tbody>
                            </table>
                             <button id="export-other-expenses-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xu·∫•t CSV Bi·∫øn ph√≠ kh√°c</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- T√†i ch√≠nh Section -->
        <section id="section-taichinh" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Qu·∫£n l√Ω T√†i ch√≠nh</h2>
            <p class="text-gray-600 mb-6">Ph√¢n t√≠ch chi ti·∫øt doanh thu, chi ph√≠ v√† l·ª£i nhu·∫≠n c·ªßa b·∫°n ƒë·ªÉ ƒë∆∞a ra c√°c quy·∫øt ƒë·ªãnh t√†i ch√≠nh s√°ng su·ªët.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Th√™m giao d·ªãch b√°n h√†ng</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="sale-item-name" list="product-names-list" placeholder="T√™n s·∫£n ph·∫©m/d·ªãch v·ª•" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="sale-quantity" placeholder="S·ªë l∆∞·ª£ng b√°n" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="sale-price" placeholder="Doanh thu (VNƒê)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <input type="text" id="sale-customer-phone" placeholder="SƒêT kh√°ch h√†ng (ƒë·ªÉ gi·∫£m gi√°)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                     <span id="discount-applied-text" class="p-2 text-sm text-blue-700 bg-blue-100 rounded-md flex items-center justify-center">Ch∆∞a √°p d·ª•ng gi·∫£m gi√°</span>
                </div>
                <input type="date" id="sale-date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 mb-4">
                <button id="add-sale-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Th√™m giao d·ªãch</button>
            </div>

            <div class="overflow-x-auto mb-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-2 p-2">Doanh thu chi ti·∫øt</h3>
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="date">Ng√†y &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="itemName">S·∫£n ph·∫©m/D·ªãch v·ª• &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="quantity">S·ªë l∆∞·ª£ng &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="originalPrice">Gi√° g·ªëc (VNƒê) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="price">Gi√° b√°n (VNƒê) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="discountApplied">Gi·∫£m gi√° (%) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body">
                        <!-- Sales data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-sales-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xu·∫•t CSV Doanh thu</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div id="monthly-financial-chart-card" class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Xu h∆∞·ªõng Doanh thu & L·ª£i nhu·∫≠n h√†ng th√°ng</h3>
                        <button class="toggle-chart-visibility bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 px-3 py-1 rounded-md text-sm" data-target="monthly-financial-chart-card">·∫®n</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyFinancialChart"></canvas>
                    </div>
                </div>
                <div id="profit-by-customer-chart-card" class="bg-white p-4 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">L·ª£i nhu·∫≠n theo Kh√°ch h√†ng (Top 5)</h3>
                        <button class="toggle-chart-visibility bg-gray-200 hover:bg-gray-300 dark:bg-gray-700 dark:hover:bg-gray-600 px-3 py-1 rounded-md text-sm" data-target="profit-by-customer-chart-card">·∫®n</button>
                    </div>
                    <div class="chart-container">
                        <canvas id="profitByCustomerChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Qu·∫£n l√Ω M·∫∑t h√†ng Section -->
        <section id="section-quanlymathang" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Qu·∫£n l√Ω M·∫∑t h√†ng</h2>
            <p class="text-gray-600 mb-6">ƒê·ªãnh nghƒ©a v√† qu·∫£n l√Ω danh s√°ch c√°c m·∫∑t h√†ng/s·∫£n ph·∫©m c√≥ s·∫µn trong c·ª≠a h√†ng c·ªßa b·∫°n. Danh s√°ch n√†y s·∫Ω ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ nh·∫≠p li·ªáu trong c√°c ph·∫ßn kh√°c.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Th√™m M·∫∑t h√†ng m·ªõi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="product-item-name" placeholder="T√™n m·∫∑t h√†ng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="product-item-default-unit" placeholder="ƒê∆°n v·ªã m·∫∑c ƒë·ªãnh (v√≠ d·ª•: kg, l√≠t, c√°i)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="product-item-default-selling-price" placeholder="Gi√° b√°n m·∫∑c ƒë·ªãnh (VNƒê)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="product-item-shelf-life-days" placeholder="Th·ªùi gian b·∫£o qu·∫£n (Ng√†y)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="product-item-daily-target-quantity" placeholder="SL m·ª•c ti√™u h√†ng ng√†y" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="product-item-daily-target-unit" placeholder="ƒê∆°n v·ªã m·ª•c ti√™u (kg, l√≠t...)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <button id="add-product-item-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Th√™m M·∫∑t h√†ng</button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">T√™n M·∫∑t h√†ng &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="defaultUnit">ƒê∆°n v·ªã m·∫∑c ƒë·ªãnh &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="defaultSellingPrice">Gi√° b√°n m·∫∑c ƒë·ªãnh &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="shelfLifeDays">Th·ªùi gian b·∫£o qu·∫£n (Ng√†y) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="dailyTargetQuantity">SL m·ª•c ti√™u h√†ng ng√†y &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="dailyTargetUnit">ƒê∆°n v·ªã m·ª•c ti√™u &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="product-items-table-body">
                        <!-- Product items data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-product-items-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xu·∫•t CSV M·∫∑t h√†ng</button>
            </div>
        </section>

        <!-- Qu·∫£n l√Ω Khuy·∫øn m√£i Section -->
        <section id="section-quanlykhuyenmai" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Qu·∫£n l√Ω Khuy·∫øn m√£i</h2>
            <p class="text-gray-600 mb-6">T·∫°o v√† qu·∫£n l√Ω c√°c ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i, gi·∫£m gi√° cho kh√°ch h√†ng th√¢n thi·∫øt.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Th√™m Khuy·∫øn m√£i m·ªõi</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="promo-name" placeholder="T√™n khuy·∫øn m√£i" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="promo-discount-percentage" placeholder="Gi·∫£m gi√° (%)" min="0" max="100" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="date" id="promo-start-date" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="date" id="promo-end-date" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="add-promo-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 ease-in-out w-full">Th√™m Khuy·∫øn m√£i</button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">T√™n Khuy·∫øn m√£i &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="discountPercentage">Gi·∫£m gi√° (%) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="startDate">Ng√†y b·∫Øt ƒë·∫ßu &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="endDate">Ng√†y k·∫øt th√∫c &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Tr·∫°ng th√°i</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider">H√†nh ƒë·ªông</th>
                        </tr>
                    </thead>
                    <tbody id="promotions-table-body">
                        <!-- Promotions data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-promotions-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xu·∫•t CSV Khuy·∫øn m√£i</button>
            </div>
        </section>

        <!-- Qu·∫£n l√Ω D·ªØ li·ªáu Section -->
        <section id="section-quanlydulieu" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Qu·∫£n l√Ω D·ªØ li·ªáu</h2>
            <p class="text-gray-600 mb-6">S·ª≠ d·ª•ng c√°c c√¥ng c·ª• d∆∞·ªõi ƒë√¢y ƒë·ªÉ sao l∆∞u ho·∫∑c kh√¥i ph·ª•c d·ªØ li·ªáu kinh doanh c·ªßa b·∫°n. D·ªØ li·ªáu ƒë∆∞·ª£c l∆∞u tr·ªØ d∆∞·ªõi ƒë·ªãnh d·∫°ng JSON.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Xu·∫•t / Nh·∫≠p To√†n B·ªô D·ªØ li·ªáu</h3>
                <button id="export-all-data-json-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 ease-in-out w-full mb-4">
                    Xu·∫•t T·∫•t C·∫£ D·ªØ li·ªáu (JSON)
                </button>
                 <button id="export-summary-csv-btn" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition duration-200 ease-in-out w-full mb-4">
                    Export Overall Summary (CSV)
                </button>
                <input type="file" id="import-data-file" accept=".json" class="hidden">
                <button id="import-data-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition duration-200 ease-in-out w-full">
                    Nh·∫≠p D·ªØ li·ªáu T·ª´ File (JSON)
                </button>
            </div>
        </section>
    </main>

    <!-- Custom Modal for Alerts and Confirms -->
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-semibold text-gray-800 mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-6"></p>
            <div class="modal-buttons">
                <button id="modal-confirm-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 ease-in-out hidden">X√°c nh·∫≠n</button>
                <button id="modal-cancel-btn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition duration-200 ease-in-out hidden">H·ªßy</button>
                <button id="modal-ok-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out hidden">OK</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container"></div>


    <script>
        // Modified: Select only actual section navigation buttons
        const navSectionButtons = document.querySelectorAll('.nav-item.nav-section-btn');
        const contentSections = document.querySelectorAll('.content-section');

        const totalIncomeRangeElement = document.getElementById('total-income-range');
        const customersInRangeElement = document.getElementById('customers-in-range');
        const profitInRangeElement = document.getElementById('profit-in-range');
        const totalCustomersKPIElement = document.getElementById('total-customers-kpi');
        const totalProductsKPIElement = document.getElementById('total-products-kpi');

        const startDateFilter = document.getElementById('start-date-filter');
        const endDateFilter = document.getElementById('end-date-filter');
        const lowStockThresholdInput = document.getElementById('low-stock-threshold');
        const minDaysBeforeExpiryWarningInput = document.getElementById('min-days-before-expiry-warning');
        const kpiTargetPercentageInput = document.getElementById('kpi-target-percentage');

        let salesData = JSON.parse(localStorage.getItem('salesData')) || [];
        let otherExpensesData = JSON.parse(localStorage.getItem('otherExpensesData')) || [];
        let customersData = JSON.parse(localStorage.getItem('customersData')) || [];
        let foodInventoryData = JSON.parse(localStorage.getItem('foodInventoryData')) || [];
        let productItemsData = JSON.parse(localStorage.getItem('productItemsData')) || [];
        let purchaseHistoryData = JSON.parse(localStorage.getItem('purchaseHistoryData')) || [];
        let promotionsData = JSON.parse(localStorage.getItem('promotionsData')) || [];

        let dailyIncomeChartInstance;
        let profitByFoodChartInstance;
        let monthlyFinancialChartInstance;
        let profitByCustomerChartInstance;

        let editingCustomerUUID = null;
        let editingFoodInventoryUUID = null;
        let editingOtherExpenseUUID = null;
        let editingSaleUUID = null;
        let editingProductItemUUID = null;
        let editingPurchaseHistoryUUID = null;
        let editingPromoUUID = null;

        const MIN_LOYALTY_PURCHASES = 3;
        const LOYALTY_POINTS_PER_PURCHASE = 1;

        // Custom Modal Elements
        const customModal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const toastContainer = document.getElementById('toast-container');


        /**
         * Shows a custom modal dialog.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message to display in the modal.
         * @param {string} type - 'alert' or 'confirm'.
         * @returns {Promise<boolean>} - Resolves to true for 'OK'/'Confirm', false for 'Cancel'.
         */
        function showCustomModal(title, message, type = 'alert') {
            modalTitle.textContent = title;
            modalMessage.textContent = message;

            modalConfirmBtn.classList.add('hidden');
            modalCancelBtn.classList.add('hidden');
            modalOkBtn.classList.add('hidden');

            return new Promise((resolve) => {
                if (type === 'confirm') {
                    modalConfirmBtn.classList.remove('hidden');
                    modalCancelBtn.classList.remove('hidden');
                    modalConfirmBtn.onclick = () => {
                        customModal.classList.add('hidden');
                        resolve(true);
                    };
                    modalCancelBtn.onclick = () => {
                        customModal.classList.add('hidden');
                        resolve(false);
                    };
                } else { // type === 'alert'
                    modalOkBtn.classList.remove('hidden');
                    modalOkBtn.onclick = () => {
                        customModal.classList.add('hidden');
                        resolve(true);
                    };
                }
                customModal.classList.remove('hidden');
            });
        }

        /**
         * Shows a toast notification.
         * @param {string} message - The message to display.
         * @param {string} type - 'success', 'error', 'info' (default).
         * @param {number} duration - How long the toast should be visible in milliseconds.
         */
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);

            // Show the toast
            setTimeout(() => toast.classList.add('show'), 10);

            // Hide and remove after duration
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        function showSection(sectionId) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active');
            });

            // Added robustness check for targetSection
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('active');
            } else {
                console.error(`Section with ID ${sectionId} not found.`);
                return; // Exit if section not found
            }

            // Modified: Use navSectionButtons
            navSectionButtons.forEach(item => {
                item.classList.remove('active');
            });

            // Added robustness check for targetNavElement
            const navElementId = `nav-${sectionId.replace('section-', '')}`;
            const targetNavElement = document.getElementById(navElementId);
            if (targetNavElement) {
                targetNavElement.classList.add('active');
            } else {
                console.error(`Navigation item with ID ${navElementId} not found.`);
            }


            updateAllTables();
            updateProductDatalist();
            updateCharts();
            updateSummaryKPIs();
            if (sectionId === 'section-tongquan') {
                const today = new Date().toISOString().slice(0, 10);
                if (!startDateFilter.value) startDateFilter.value = today;
                if (!endDateFilter.value) endDateFilter.value = today;
                calculateSummaryForDateRange();
                updateDailyKpiTable();
            }
             // Reset discount text when changing sections
            document.getElementById('discount-applied-text').textContent = 'Ch∆∞a √°p d·ª•ng gi·∫£m gi√°';
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${day}/${month}/${year}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function calculateSummaryForDateRange() {
            const start = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const end = endDateFilter.value ? new Date(endDateFilter.value) : null;

            let filteredSales = salesData;
            let filteredOtherExpenses = otherExpensesData;
            let filteredPurchases = purchaseHistoryData;
            let filteredCustomers = customersData;

            if (start && end) {
                filteredSales = salesData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= start && saleDate <= end;
                });
                filteredOtherExpenses = otherExpensesData.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });
                filteredPurchases = purchaseHistoryData.filter(purchase => {
                    const purchaseDate = new Date(purchase.date);
                    return purchaseDate >= start && purchaseDate <= end;
                });
                filteredCustomers = customersData.filter(customer => {
                    const lastContactDate = new Date(customer.lastContact);
                    return lastContactDate >= start && lastContactDate <= end;
                });
            } else if (start && !end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) >= start);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) >= start);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) >= start);
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) >= start);
            } else if (!start && end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) <= end);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) <= end);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) <= end);
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) <= end);
            }


            const totalIncome = filteredSales.reduce((sum, sale) => sum + sale.price, 0);
            const totalOtherExpense = filteredOtherExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalPurchaseCost = filteredPurchases.reduce((sum, purchase) => sum + purchase.totalCost, 0);
            const estimatedProfit = totalIncome - totalOtherExpense - totalPurchaseCost;

            const uniqueCustomers = new Set(filteredCustomers.map(c => c.name)).size;

            totalIncomeRangeElement.textContent = formatCurrency(totalIncome);
            customersInRangeElement.textContent = uniqueCustomers;
            profitInRangeElement.textContent = formatCurrency(estimatedProfit);
        }

        function updateSummaryKPIs() {
            totalCustomersKPIElement.textContent = customersData.length;
            totalProductsKPIElement.textContent = productItemsData.length;
        }

        function updateCustomerTable() {
            const tbody = document.getElementById('customer-table-body');
            tbody.innerHTML = '';
            customersData.forEach((customer) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = customer.name;
                row.insertCell().textContent = customer.phoneNumber || 'N/A';
                row.insertCell().textContent = formatDate(customer.lastContact);
                row.insertCell().textContent = formatDate(customer.nextFollowup);
                row.insertCell().textContent = customer.status;
                row.insertCell().textContent = customer.purchaseCount || 0;
                row.insertCell().textContent = customer.loyaltyPoints || 0;
                row.insertCell().textContent = customer.tier || 'Th√†nh vi√™n';
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${customer.uuid}">S·ª≠a</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${customer.uuid}">X√≥a</button>
                `;
            });
            localStorage.setItem('customersData', JSON.stringify(customersData));
            attachTableEventListeners(tbody, 'customer');
            updateSummaryKPIs();
        }

        function updateFoodInventoryTable() {
            const tbody = document.getElementById('food-inventory-table-body');
            tbody.innerHTML = '';
            const lowStockThreshold = parseFloat(lowStockThresholdInput.value) || 0;
            const minDaysBeforeExpiryWarning = parseFloat(minDaysBeforeExpiryWarningInput.value) || 0;
            const today = new Date();
            today.setHours(0,0,0,0);

            foodInventoryData.forEach((item) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                let hasWarning = false;

                // Check for low stock based on threshold
                if (item.quantity <= lowStockThreshold) {
                    row.classList.add('low-stock-alert');
                    hasWarning = true;
                }

                // Check for low stock based on 7-day KPI target
                const productItem = productItemsData.find(p => p.name.toLowerCase() === item.name.toLowerCase());
                if (productItem && productItem.dailyTargetQuantity) {
                    const requiredFor7Days = productItem.dailyTargetQuantity * 7;
                    if (item.quantity < requiredFor7Days) {
                         if (!hasWarning) row.classList.add('low-stock-alert'); // Don't overwrite if already low
                         hasWarning = true;
                    }
                }


                // Check for expiry date
                let daysUntilExpiry = 'N/A';
                if (item.expiryDate) {
                    const expiryDate = new Date(item.expiryDate);
                    expiryDate.setHours(0,0,0,0);
                    const diffTime = expiryDate - today;
                    daysUntilExpiry = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (daysUntilExpiry <= minDaysBeforeExpiryWarning) {
                        row.classList.add('expiry-warning');
                        hasWarning = true;
                    }
                }

                row.insertCell().textContent = item.name;
                row.insertCell().textContent = `${item.quantity} ${item.unit}`;
                row.insertCell().textContent = item.unit; // Display unit in a separate column
                row.insertCell().textContent = item.expiryDate ? formatDate(item.expiryDate) + (daysUntilExpiry !== 'N/A' ? ` (${daysUntilExpiry} ng√†y)` : '') : 'N/A';
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${item.uuid}">S·ª≠a</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${item.uuid}">X√≥a</button>
                `;
            });
            localStorage.setItem('foodInventoryData', JSON.stringify(foodInventoryData));
            attachTableEventListeners(tbody, 'foodInventory');
        }

        function updatePurchaseHistoryTable() {
            const tbody = document.getElementById('purchase-history-table-body');
            tbody.innerHTML = '';
            purchaseHistoryData.forEach((purchase) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = purchase.itemName;
                row.insertCell().textContent = `${purchase.quantity} ${purchase.unit}`;
                row.insertCell().textContent = formatCurrency(purchase.purchasePrice);
                row.insertCell().textContent = formatCurrency(purchase.totalCost);
                row.insertCell().textContent = formatDate(purchase.date);
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${purchase.uuid}">S·ª≠a</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${purchase.uuid}">X√≥a</button>
                `;
            });
            localStorage.setItem('purchaseHistoryData', JSON.stringify(purchaseHistoryData));
            attachTableEventListeners(tbody, 'purchaseHistory');
        }

        function updateOtherExpenseTable() {
            const tbody = document.getElementById('other-expense-table-body');
            tbody.innerHTML = '';
            otherExpensesData.forEach((expense) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = expense.description;
                row.insertCell().textContent = formatCurrency(expense.amount);
                row.insertCell().textContent = formatDate(expense.date);
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${expense.uuid}">S·ª≠a</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${expense.uuid}">X√≥a</button>
                `;
            });
            localStorage.setItem('otherExpensesData', JSON.stringify(otherExpensesData));
            attachTableEventListeners(tbody, 'otherExpense');
        }

        function updateSalesTable() {
            const tbody = document.getElementById('sales-table-body');
            tbody.innerHTML = '';
            salesData.forEach((sale) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = formatDate(sale.date);
                row.insertCell().textContent = sale.itemName;
                row.insertCell().textContent = sale.quantity;
                row.insertCell().textContent = formatCurrency(sale.originalPrice || sale.price); // Display original price if discount applied
                row.insertCell().textContent = formatCurrency(sale.price);
                row.insertCell().textContent = sale.discountApplied ? `${sale.discountApplied}%` : '0%';
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${sale.uuid}">S·ª≠a</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${sale.uuid}">X√≥a</button>
                `;
            });
            localStorage.setItem('salesData', JSON.stringify(salesData));
            attachTableEventListeners(tbody, 'sale');
        }

        function updateProductItemsTable() {
            const tbody = document.getElementById('product-items-table-body');
            tbody.innerHTML = '';
            productItemsData.forEach((item) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.defaultUnit;
                row.insertCell().textContent = formatCurrency(item.defaultSellingPrice || 0);
                row.insertCell().textContent = item.shelfLifeDays || 'N/A';
                row.insertCell().textContent = `${item.dailyTargetQuantity || 'N/A'} ${item.dailyTargetUnit || ''}`;
                row.insertCell().textContent = item.dailyTargetUnit || 'N/A';
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${item.uuid}">S·ª≠a</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${item.uuid}">X√≥a</button>
                `;
            });
            localStorage.setItem('productItemsData', JSON.stringify(productItemsData));
            attachTableEventListeners(tbody, 'productItem');
            updateSummaryKPIs();
        }

        function updatePromotionsTable() {
            const tbody = document.getElementById('promotions-table-body');
            tbody.innerHTML = '';
            const today = new Date().toISOString().slice(0, 10);

            promotionsData.forEach((promo) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                const isActive = promo.startDate <= today && promo.endDate >= today;
                row.insertCell().textContent = promo.name;
                row.insertCell().textContent = `${promo.discountPercentage}%`;
                row.insertCell().textContent = formatDate(promo.startDate);
                row.insertCell().textContent = formatDate(promo.endDate);
                row.insertCell().textContent = isActive ? 'Active' : 'Inactive';
                row.insertCell().classList.add(isActive ? 'text-green-600' : 'text-red-600');

                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${promo.uuid}">S·ª≠a</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${promo.uuid}">X√≥a</button>
                `;
            });
            localStorage.setItem('promotionsData', JSON.stringify(promotionsData));
            attachTableEventListeners(tbody, 'promotion');
        }

        function updateProductDatalist() {
            const datalist = document.getElementById('product-names-list');
            datalist.innerHTML = '';
            productItemsData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                datalist.appendChild(option);
            });
        }

        function updateAllTables() {
            updateCustomerTable();
            updateFoodInventoryTable();
            updatePurchaseHistoryTable();
            updateOtherExpenseTable();
            updateSalesTable();
            updateProductItemsTable();
            updatePromotionsTable();
        }

        function updateDailyKpiTable() {
            const tbody = document.getElementById('daily-kpi-table-body');
            tbody.innerHTML = '';
            const todayStr = new Date().toISOString().slice(0, 10);
            const kpiTargetPercentage = parseFloat(kpiTargetPercentageInput.value) / 100 || 0.8;

            productItemsData.forEach(item => {
                if (!item.dailyTargetQuantity || item.dailyTargetQuantity <= 0) return;

                const actualSoldToday = salesData
                    .filter(sale => sale.date === todayStr && sale.itemName.toLowerCase() === item.name.toLowerCase())
                    .reduce((sum, sale) => sum + sale.quantity, 0);

                const kpiAchievement = (actualSoldToday / item.dailyTargetQuantity) * 100;
                const status = kpiAchievement >= (kpiTargetPercentage * 100) ? 'ƒê·∫°t ch·ªâ ti√™u' : 'Ch∆∞a ƒë·∫°t';

                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.classList.add(status === 'ƒê·∫°t ch·ªâ ti√™u' ? 'kpi-met' : 'kpi-not-met');

                row.insertCell().textContent = item.name;
                row.insertCell().textContent = `${item.dailyTargetQuantity} ${item.dailyTargetUnit || ''}`;
                row.insertCell().textContent = `${actualSoldToday} ${item.dailyTargetUnit || ''}`;
                row.insertCell().textContent = `${kpiAchievement.toFixed(2)}%`;
                row.insertCell().textContent = status;
            });
        }

        function updateCharts() {
            if (dailyIncomeChartInstance) dailyIncomeChartInstance.destroy();
            if (profitByFoodChartInstance) profitByFoodChartInstance.destroy();
            if (monthlyFinancialChartInstance) monthlyFinancialChartInstance.destroy();
            if (profitByCustomerChartInstance) profitByCustomerChartInstance.destroy();

            drawDailyIncomeChart();
            drawProfitByFoodChart();
            drawMonthlyFinancialChart();
            drawProfitByCustomerChart();
        }

        function wrapLabels(label, index, labels) {
            const MAX_CHAR_PER_LINE = 16;
            if (label && label.length > MAX_CHAR_PER_LINE) {
                const words = label.split(' ');
                let lines = [];
                let currentLine = '';
                words.forEach(word => {
                    if ((currentLine + word).length <= MAX_CHAR_PER_LINE) {
                        currentLine += (currentLine === '' ? '' : ' ') + word;
                    } else {
                        lines.push(currentLine);
                        currentLine = word;
                    }
                });
                lines.push(currentLine);
                return lines;
            }
            return label;
        }

        function drawDailyIncomeChart() {
            const ctx = document.getElementById('dailyIncomeChart').getContext('2d');
            const last7Days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d.toISOString().slice(0, 10);
            });

            const incomeByDay = last7Days.map(date => {
                return salesData.filter(sale => sale.date === date)
                                .reduce((sum, sale) => sum + sale.price, 0);
            });

            dailyIncomeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => formatDate(d)),
                    datasets: [{
                        label: 'Revenue (VND)',
                        data: incomeByDay,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (VND)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }

        function drawProfitByFoodChart() {
            const ctx = document.getElementById('profitByFoodChart').getContext('2d');

            const foodSales = {};
            salesData.forEach(sale => {
                foodSales[sale.itemName] = (foodSales[sale.itemName] || 0) + sale.price;
            });

            const foodPurchaseCosts = {};
            purchaseHistoryData.forEach(purchase => {
                foodPurchaseCosts[purchase.itemName] = (foodPurchaseCosts[purchase.itemName] || 0) + purchase.totalCost;
            });

            const foodProfit = {};
            const allFoodItems = new Set([...Object.keys(foodSales), ...Object.keys(foodPurchaseCosts)]);
            allFoodItems.forEach(item => {
                const salesRevenue = foodSales[item] || 0;
                const purchaseCost = foodPurchaseCosts[item] || 0;
                foodProfit[item] = salesRevenue - purchaseCost;
            });

            const sortedFoodProfit = Object.entries(foodProfit).sort(([,a],[,b]) => b - a).slice(0, 5);
            const labels = sortedFoodProfit.map(entry => entry[0]);
            const data = sortedFoodProfit.map(entry => entry[1]);

            profitByFoodChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Profit (VND)',
                        data: data,
                        backgroundColor: '#FFC107',
                        borderColor: '#FFB300',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Profit (VND)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Food Item'
                            },
                            ticks: {
                                callback: wrapLabels
                            }
                        }
                    }
                }
            });
        }

        function drawMonthlyFinancialChart() {
            const ctx = document.getElementById('monthlyFinancialChart').getContext('2d');

            const monthlyData = {};

            // Filter data based on date range for accurate monthly charts
            const start = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const end = endDateFilter.value ? new Date(endDateFilter.value) : null;

            let relevantSales = salesData;
            let relevantOtherExpenses = otherExpensesData;
            let relevantPurchases = purchaseHistoryData;

            if (start && end) {
                relevantSales = salesData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= start && saleDate <= end;
                });
                relevantOtherExpenses = otherExpensesData.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });
                relevantPurchases = purchaseHistoryData.filter(purchase => {
                    const purchaseDate = new Date(purchase.date);
                    return purchaseDate >= start && purchaseDate <= end;
                });
            } else if (start) {
                relevantSales = salesData.filter(sale => new Date(sale.date) >= start);
                relevantOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) >= start);
                relevantPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) >= start);
            } else if (end) {
                relevantSales = salesData.filter(sale => new Date(sale.date) <= end);
                relevantOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) <= end);
                relevantPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) <= end);
            }


            relevantSales.forEach(sale => {
                const month = sale.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { income: 0, expenses: 0, purchaseCosts: 0 };
                monthlyData[month].income += sale.price;
            });

            relevantOtherExpenses.forEach(expense => {
                const month = expense.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { income: 0, expenses: 0, purchaseCosts: 0 };
                monthlyData[month].expenses += expense.amount;
            });

            relevantPurchases.forEach(purchase => {
                const month = purchase.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { income: 0, expenses: 0, purchaseCosts: 0 };
                monthlyData[month].purchaseCosts += purchase.totalCost;
            });


            const sortedMonths = Object.keys(monthlyData).sort();
            const monthlyIncomes = sortedMonths.map(month => monthlyData[month].income);
            const monthlyTotalCosts = sortedMonths.map(month => monthlyData[month].expenses + monthlyData[month].purchaseCosts);
            const monthlyProfits = sortedMonths.map(month => monthlyData[month].income - monthlyTotalCosts[sortedMonths.indexOf(month)]);

            monthlyFinancialChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [
                        {
                            label: 'Monthly Revenue (VND)',
                            data: monthlyIncomes,
                            borderColor: '#42A5F5',
                            backgroundColor: 'rgba(66, 165, 245, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Monthly Expenses (VND)',
                            data: monthlyTotalCosts,
                            borderColor: '#EF5350',
                            backgroundColor: 'rgba(239, 83, 80, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Monthly Profit (VND)',
                            data: monthlyProfits,
                            borderColor: '#66BB6A',
                            backgroundColor: 'rgba(102, 187, 106, 0.2)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (VND)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        function drawProfitByCustomerChart() {
            const ctx = document.getElementById('profitByCustomerChart').getContext('2d');

            const customerProfit = {};

            // Filter data based on date range for accurate customer charts
            const start = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const end = endDateFilter.value ? new Date(endDateFilter.value) : null;

            let relevantSales = salesData;
            if (start && end) {
                relevantSales = salesData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= start && saleDate <= end;
                });
            } else if (start) {
                relevantSales = salesData.filter(sale => new Date(sale.date) >= start);
            } else if (end) {
                relevantSales = salesData.filter(sale => new Date(sale.date) <= end);
            }


            relevantSales.forEach(sale => {
                if (sale.customerPhone) {
                    const customer = customersData.find(c => c.phoneNumber === sale.customerPhone);
                    if (customer) {
                        customerProfit[customer.name] = (customerProfit[customer.name] || 0) + sale.price;
                        // For a more accurate profit by customer, we would also need to deduct the cost of goods sold for each sale.
                        // For simplicity in this client-side app, we're using revenue here.
                        // If 'productItemsData' contained a 'costPrice' per item, we could do:
                        // const product = productItemsData.find(p => p.name.toLowerCase() === sale.itemName.toLowerCase());
                        // if (product) {
                        //     customerProfit[customer.name] -= (product.costPrice * sale.quantity);
                        // }
                    }
                }
            });

            const sortedCustomerProfit = Object.entries(customerProfit).sort(([,a],[,b]) => b - a).slice(0, 5);
            const labels = sortedCustomerProfit.map(entry => entry[0]);
            const data = sortedCustomerProfit.map(entry => entry[1]);

            profitByCustomerChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Revenue by Customer (VND)', // Using revenue as a proxy for profit
                        data: data,
                        backgroundColor: '#9C27B0',
                        borderColor: '#8E24AA',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Revenue (VND)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Customer'
                            },
                            ticks: {
                                callback: wrapLabels
                            }
                        }
                    }
                }
            });
        }


        function initializeApp() {
            const today = new Date().toISOString().slice(0, 10);
            startDateFilter.value = today;
            endDateFilter.value = today;

            // Load theme preference
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.getElementById('current-theme').textContent = 'T·ªëi üåë';
            } else {
                document.body.classList.remove('dark-mode');
                document.getElementById('current-theme').textContent = 'S√°ng ‚òÄÔ∏è';
            }

            showSection('section-tongquan');
            calculateSummaryForDateRange();
            updateAllTables();
            updateProductDatalist();
            updateCharts();
            updateSummaryKPIs();
        }

        // Helper function to convert array of objects to CSV string
        function convertToCsv(arr, headers = null) {
            if (!arr.length) return '';
            
            const BOM = "\uFEFF"; // Byte Order Mark for UTF-8

            const finalHeaders = headers || Object.keys(arr[0]);
            const headerRow = finalHeaders.map(h => {
                if (typeof h === 'object' && h.label) return `"${h.label.replace(/"/g, '""')}"`;
                return `"${String(h).replace(/"/g, '""')}"`;
            }).join(',');

            const rows = arr.map(row => finalHeaders.map(key => {
                const actualKey = (typeof key === 'object' && key.key) ? key.key : key;
                let value = row[actualKey];

                if (['date', 'lastContact', 'nextFollowup', 'startDate', 'endDate', 'expiryDate'].includes(actualKey)) {
                    value = formatDate(value);
                }
                else if (actualKey === 'type') {
                    value = value === 'mua_thuc_pham' ? 'Food Purchase' : 'Other Variable Expense';
                }
                else if (['amount', 'price', 'quantity', 'purchasePrice', 'totalCost', 'defaultSellingPrice', 'shelfLifeDays', 'dailyTargetQuantity', 'discountPercentage', 'originalPrice', 'purchaseCount', 'loyaltyPoints'].includes(actualKey)) {
                    // For numbers, keep as raw number for CSV, let Excel format if needed
                    value = value !== undefined && value !== null ? parseFloat(value) : '';
                }
                else if (actualKey === 'status' && typeof value === 'boolean') {
                    value = value ? 'Active' : 'Inactive';
                }


                if (typeof value === 'string' && value.includes(',')) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return String(value);
            }).join(','));
            return BOM + [headerRow, ...rows].join('\n'); // Prepend BOM
        }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function attachTableEventListeners(tbody, dataType) {
            tbody.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const uuid = event.target.dataset.uuid;
                    editItem(dataType, uuid);
                });
            });

            tbody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async (event) => { // Use async here
                    const uuid = event.target.dataset.uuid;
                    const confirmed = await showCustomModal('X√°c nh·∫≠n x√≥a', 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a m·ª•c n√†y kh√¥ng?', 'confirm');
                    if (confirmed) {
                        deleteItem(dataType, uuid);
                    }
                });
            });

            const table = tbody.closest('table');
            if (table) {
                const headers = table.querySelectorAll('th[data-sort-key]');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const sortKey = header.dataset.sortKey;
                        sortTable(dataType, sortKey);
                    });
                });
            }
        }

        let sortDirections = {};

        function sortTable(dataType, sortKey) {
            let dataArray;
            let updateTableFunc;

            switch (dataType) {
                case 'customer':
                    dataArray = customersData;
                    updateTableFunc = updateCustomerTable;
                    break;
                case 'foodInventory':
                    dataArray = foodInventoryData;
                    updateTableFunc = updateFoodInventoryTable;
                    break;
                case 'otherExpense':
                    dataArray = otherExpensesData;
                    updateTableFunc = updateOtherExpenseTable;
                    break;
                case 'sale':
                    dataArray = salesData;
                    updateTableFunc = updateSalesTable;
                    break;
                case 'productItem':
                    dataArray = productItemsData;
                    updateTableFunc = updateProductItemsTable;
                    break;
                case 'purchaseHistory':
                    dataArray = purchaseHistoryData;
                    updateTableFunc = updatePurchaseHistoryTable;
                    break;
                case 'promotion':
                    dataArray = promotionsData;
                    updateTableFunc = updatePromotionsTable;
                    break;
                default:
                    return;
            }

            const currentDirection = sortDirections[`${dataType}-${sortKey}`] === 'asc' ? 'desc' : 'asc';

            dataArray.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                if (sortKey.includes('date') || sortKey.includes('Contact') || sortKey.includes('Followup') || sortKey.includes('startDate') || sortKey.includes('endDate') || sortKey.includes('expiryDate')) {
                    valA = new Date(valA);
                    valB = new Date(valB);
                } else if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return currentDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentDirection === 'asc' ? 1 : -1;
                return 0;
            });

            sortDirections[`${dataType}-${sortKey}`] = currentDirection;
            updateTableFunc();
        }

        function findItemByUUID(dataArray, uuid) {
            return dataArray.find(item => item.uuid === uuid);
        }

        function findIndexByUUID(dataArray, uuid) {
            return dataArray.findIndex(item => item.uuid === uuid);
        }


        function editItem(dataType, uuid) {
            let dataArray;
            let formElements;
            let addBtn;
            let editingUUIDField;

            switch (dataType) {
                case 'customer':
                    dataArray = customersData;
                    formElements = {
                        name: document.getElementById('customer-name'),
                        phoneNumber: document.getElementById('customer-phone'),
                        lastContact: document.getElementById('customer-last-contact'),
                        nextFollowup: document.getElementById('customer-next-followup'),
                        status: document.getElementById('customer-status'),
                        tier: document.getElementById('customer-tier')
                    };
                    addBtn = document.getElementById('add-customer-btn');
                    editingUUIDField = 'editingCustomerUUID';
                    break;
                case 'foodInventory':
                    dataArray = foodInventoryData;
                    formElements = {
                        name: document.getElementById('food-item-name'),
                        quantity: document.getElementById('food-item-quantity'),
                        unit: document.getElementById('food-item-unit')
                    };
                    addBtn = document.getElementById('add-food-item-btn');
                    editingUUIDField = 'editingFoodInventoryUUID';
                    break;
                case 'otherExpense':
                    dataArray = otherExpensesData;
                    formElements = {
                        description: document.getElementById('other-expense-description'),
                        amount: document.getElementById('other-expense-amount'),
                        date: document.getElementById('other-expense-date')
                    };
                    addBtn = document.getElementById('add-other-expense-btn');
                    editingUUIDField = 'editingOtherExpenseUUID';
                    break;
                case 'purchaseHistory':
                    dataArray = purchaseHistoryData;
                    formElements = {
                        itemName: document.getElementById('purchase-item-name'),
                        quantity: document.getElementById('purchase-quantity'),
                        unit: document.getElementById('purchase-unit'),
                        purchasePrice: document.getElementById('purchase-price-per-unit'),
                        date: document.getElementById('purchase-date')
                    };
                    addBtn = document.getElementById('add-purchase-btn');
                    editingUUIDField = 'editingPurchaseHistoryUUID';
                    break;
                case 'sale':
                    dataArray = salesData;
                    formElements = {
                        itemName: document.getElementById('sale-item-name'),
                        quantity: document.getElementById('sale-quantity'),
                        price: document.getElementById('sale-price'),
                        date: document.getElementById('sale-date'),
                        customerPhone: document.getElementById('sale-customer-phone')
                    };
                    addBtn = document.getElementById('add-sale-btn');
                    editingUUIDField = 'editingSaleUUID';
                    break;
                case 'productItem':
                    dataArray = productItemsData;
                    formElements = {
                        name: document.getElementById('product-item-name'),
                        defaultUnit: document.getElementById('product-item-default-unit'),
                        defaultSellingPrice: document.getElementById('product-item-default-selling-price'),
                        shelfLifeDays: document.getElementById('product-item-shelf-life-days'),
                        dailyTargetQuantity: document.getElementById('product-item-daily-target-quantity'),
                        dailyTargetUnit: document.getElementById('product-item-daily-target-unit')
                    };
                    addBtn = document.getElementById('add-product-item-btn');
                    editingUUIDField = 'editingProductItemUUID';
                    break;
                case 'promotion':
                    dataArray = promotionsData;
                    formElements = {
                        name: document.getElementById('promo-name'),
                        discountPercentage: document.getElementById('promo-discount-percentage'),
                        startDate: document.getElementById('promo-start-date'),
                        endDate: document.getElementById('promo-end-date')
                    };
                    addBtn = document.getElementById('add-promo-btn');
                    editingUUIDField = 'editingPromoUUID';
                    break;
                default:
                    return;
            }

            const item = findItemByUUID(dataArray, uuid);
            if (item) {
                for (const key in formElements) {
                    if (formElements[key]) {
                        formElements[key].value = item[key];
                    }
                }
                addBtn.textContent = 'C·∫≠p nh·∫≠t';
                window[editingUUIDField] = uuid;
            }
        }

        async function deleteItem(dataType, uuid) {
            let dataArray;
            let updateTableFunc;
            let calculateSummaryNeeded = false;
            let updateChartsNeeded = false;

            switch (dataType) {
                case 'customer':
                    dataArray = customersData;
                    updateTableFunc = updateCustomerTable;
                    calculateSummaryNeeded = true;
                    break;
                case 'foodInventory':
                    dataArray = foodInventoryData;
                    updateTableFunc = updateFoodInventoryTable;
                    break;
                case 'otherExpense':
                    dataArray = otherExpensesData;
                    updateTableFunc = updateOtherExpenseTable;
                    calculateSummaryNeeded = true;
                    updateChartsNeeded = true;
                    break;
                case 'purchaseHistory':
                    dataArray = purchaseHistoryData;
                    updateTableFunc = updatePurchaseHistoryTable;
                    calculateSummaryNeeded = true;
                    updateChartsNeeded = true;
                    // When a purchase is deleted, decrease inventory
                    const deletedPurchase = findItemByUUID(purchaseHistoryData, uuid);
                    if (deletedPurchase) {
                        const inventoryItem = findItemByName(foodInventoryData, deletedPurchase.itemName);
                        if (inventoryItem) {
                            inventoryItem.quantity = (inventoryItem.quantity || 0) - deletedPurchase.quantity;
                        }
                    }
                    updateFoodInventoryTable();
                    break;
                case 'sale':
                    dataArray = salesData;
                    updateTableFunc = updateSalesTable;
                    calculateSummaryNeeded = true;
                    updateChartsNeeded = true;
                    // When a sale is deleted, return quantity to inventory
                    const deletedSale = findItemByUUID(salesData, uuid);
                    if (deletedSale) {
                        const inventoryItem = findItemByName(foodInventoryData, deletedSale.itemName);
                        if (inventoryItem) {
                            inventoryItem.quantity = (inventoryItem.quantity || 0) + deletedSale.quantity;
                        }
                         // Decrement customer's purchase count and loyalty points
                        if (deletedSale.customerPhone) {
                            const customer = customersData.find(c => c.phoneNumber === deletedSale.customerPhone);
                            if (customer) {
                                customer.purchaseCount = (customer.purchaseCount || 0) - 1;
                                customer.loyaltyPoints = (customer.loyaltyPoints || 0) - LOYALTY_POINTS_PER_PURCHASE;
                                updateCustomerTable();
                            }
                        }
                    }
                    updateFoodInventoryTable();
                    break;
                case 'productItem':
                    dataArray = productItemsData;
                    updateTableFunc = updateProductItemsTable;
                    break;
                case 'promotion':
                    dataArray = promotionsData;
                    updateTableFunc = updatePromotionsTable;
                    break;
                default:
                    return;
            }

            const itemIndex = findIndexByUUID(dataArray, uuid);
            if (itemIndex > -1) {
                dataArray.splice(itemIndex, 1);
                updateTableFunc();
                calculateSummaryForDateRange();
                if (calculateSummaryNeeded) updateSummaryKPIs();
                if (updateChartsNeeded) updateCharts();
                updateProductDatalist();
                showToast('M·ª•c ƒë√£ ƒë∆∞·ª£c x√≥a th√†nh c√¥ng!', 'success');
            } else {
                 showToast('Kh√¥ng t√¨m th·∫•y m·ª•c ƒë·ªÉ x√≥a.', 'error');
            }
        }

        function findItemByName(array, name) {
            return array.find(item => item.name.toLowerCase() === name.toLowerCase());
        }


        document.getElementById('add-customer-btn').addEventListener('click', async () => {
            const name = document.getElementById('customer-name').value.trim();
            const phoneNumber = document.getElementById('customer-phone').value.trim();
            const lastContact = document.getElementById('customer-last-contact').value;
            const nextFollowup = document.getElementById('customer-next-followup').value;
            const status = document.getElementById('customer-status').value;
            const tier = document.getElementById('customer-tier').value;

            if (name && phoneNumber && lastContact && nextFollowup) {
                if (editingCustomerUUID) {
                    const customer = findItemByUUID(customersData, editingCustomerUUID);
                    if (customer) {
                        customer.name = name;
                        customer.phoneNumber = phoneNumber;
                        customer.lastContact = lastContact;
                        customer.nextFollowup = nextFollowup;
                        customer.status = status;
                        customer.tier = tier;
                        showToast('Th√¥ng tin kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');
                    }
                    editingCustomerUUID = null;
                    document.getElementById('add-customer-btn').textContent = 'Th√™m kh√°ch h√†ng';
                } else {
                    if (customersData.some(c => c.phoneNumber === phoneNumber)) {
                        await showCustomModal('L·ªói', 'Kh√°ch h√†ng v·ªõi s·ªë ƒëi·ªán tho·∫°i n√†y ƒë√£ t·ªìn t·∫°i!', 'alert');
                        return;
                    }
                    customersData.push({ uuid: crypto.randomUUID(), name, phoneNumber, lastContact, nextFollowup, status, purchaseCount: 0, loyaltyPoints: 0, tier });
                    showToast('Kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c th√™m!', 'success');
                }
                updateCustomerTable();
                calculateSummaryForDateRange();
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-phone').value = '';
                document.getElementById('customer-last-contact').value = '';
                document.getElementById('customer-next-followup').value = '';
                document.getElementById('customer-tier').value = 'Th√†nh vi√™n';
            } else {
                await showCustomModal('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng.', 'alert');
            }
        });

        document.getElementById('add-food-item-btn').addEventListener('click', async () => {
            const name = document.getElementById('food-item-name').value.trim();
            const quantity = parseFloat(document.getElementById('food-item-quantity').value);
            const unit = document.getElementById('food-item-unit').value.trim();

            if (name && !isNaN(quantity) && unit) {
                if (editingFoodInventoryUUID) {
                    const foodItem = findItemByUUID(foodInventoryData, editingFoodInventoryUUID);
                    if (foodItem) {
                        foodItem.name = name;
                        foodItem.quantity = quantity;
                        foodItem.unit = unit;
                        showToast('T·ªìn kho th·ª±c ph·∫©m ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');
                    }
                    editingFoodInventoryUUID = null;
                    document.getElementById('add-food-item-btn').textContent = 'Th√™m/C·∫≠p nh·∫≠t t·ªìn kho';
                } else {
                    // Automatically add to product items if it doesn't exist
                    if (!productItemsData.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                        productItemsData.push({ uuid: crypto.randomUUID(), name: name, defaultUnit: unit, defaultSellingPrice: 0, shelfLifeDays: 0, dailyTargetQuantity: 0, dailyTargetUnit: '' });
                        updateProductItemsTable();
                        updateProductDatalist();
                    }
                    foodInventoryData.push({ uuid: crypto.randomUUID(), name, quantity, unit, expiryDate: '' }); // Expiry set on purchase
                    showToast('T·ªìn kho th·ª±c ph·∫©m ƒë√£ ƒë∆∞·ª£c th√™m!', 'success');
                }
                updateFoodInventoryTable();
                document.getElementById('food-item-name').value = '';
                document.getElementById('food-item-quantity').value = '';
                document.getElementById('food-item-unit').value = '';
                updateCharts();
            } else {
                await showCustomModal('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin t·ªìn kho th·ª±c ph·∫©m.', 'alert');
            }
        });

        document.getElementById('add-purchase-btn').addEventListener('click', async () => {
            const itemName = document.getElementById('purchase-item-name').value.trim();
            const quantity = parseFloat(document.getElementById('purchase-quantity').value);
            const unit = document.getElementById('purchase-unit').value.trim();
            const purchasePrice = parseFloat(document.getElementById('purchase-price-per-unit').value);
            const date = document.getElementById('purchase-date').value;

            if (itemName && !isNaN(quantity) && unit && !isNaN(purchasePrice) && date) {
                const totalCost = quantity * purchasePrice;
                const productItemInfo = productItemsData.find(p => p.name.toLowerCase() === itemName.toLowerCase());
                
                let expiryDate = '';
                if (productItemInfo && productItemInfo.shelfLifeDays) {
                    const purchaseDateObj = new Date(date);
                    purchaseDateObj.setDate(purchaseDateObj.getDate() + productItemInfo.shelfLifeDays);
                    expiryDate = purchaseDateObj.toISOString().slice(0, 10);
                }

                const purchase = { uuid: crypto.randomUUID(), itemName, quantity, unit, purchasePrice, date, totalCost, expiryDate };

                if (editingPurchaseHistoryUUID) {
                    const existingPurchase = findItemByUUID(purchaseHistoryData, editingPurchaseHistoryUUID);
                    if (existingPurchase) {
                        // Revert old inventory change
                        const oldFoodItem = findItemByName(foodInventoryData, existingPurchase.itemName);
                        if (oldFoodItem) oldFoodItem.quantity -= existingPurchase.quantity;

                        // Apply new data
                        Object.assign(existingPurchase, purchase);
                        showToast('Giao d·ªãch mua h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');
                    }
                    editingPurchaseHistoryUUID = null;
                    document.getElementById('add-purchase-btn').textContent = 'Th√™m Giao d·ªãch Mua';
                } else {
                    purchaseHistoryData.push(purchase);
                    showToast('Giao d·ªãch mua h√†ng ƒë√£ ƒë∆∞·ª£c th√™m!', 'success');
                }

                // Update food inventory: Find by name, then update quantity and expiry date
                let foodItem = foodInventoryData.find(item => item.name.toLowerCase() === itemName.toLowerCase());
                if (foodItem) {
                    foodItem.quantity += quantity;
                    // Only update expiry date if the new purchase date results in a later expiry
                    if (!foodItem.expiryDate || new Date(expiryDate) > new Date(foodItem.expiryDate)) {
                         foodItem.expiryDate = expiryDate;
                    }
                } else {
                    // If item doesn't exist in inventory, add it
                    foodInventoryData.push({ uuid: crypto.randomUUID(), name: itemName, quantity: quantity, unit: unit, expiryDate: expiryDate });
                }
                updateFoodInventoryTable();
                updatePurchaseHistoryTable();
                calculateSummaryForDateRange();
                updateCharts();
                document.getElementById('purchase-item-name').value = '';
                document.getElementById('purchase-quantity').value = '';
                document.getElementById('purchase-unit').value = '';
                document.getElementById('purchase-price-per-unit').value = '';
                document.getElementById('purchase-date').value = '';
            } else {
                await showCustomModal('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao d·ªãch mua h√†ng.', 'alert');
            }
        });


        document.getElementById('add-other-expense-btn').addEventListener('click', async () => {
            const description = document.getElementById('other-expense-description').value.trim();
            const amount = parseFloat(document.getElementById('other-expense-amount').value);
            const date = document.getElementById('other-expense-date').value;

            if (description && !isNaN(amount) && date) {
                if (editingOtherExpenseUUID) {
                    const expense = findItemByUUID(otherExpensesData, editingOtherExpenseUUID);
                    if (expense) {
                        expense.description = description;
                        expense.amount = amount;
                        expense.date = date;
                        showToast('Bi·∫øn ph√≠ kh√°c ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');
                    }
                    editingOtherExpenseUUID = null;
                    document.getElementById('add-other-expense-btn').textContent = 'Th√™m Bi·∫øn ph√≠';
                } else {
                    otherExpensesData.push({ uuid: crypto.randomUUID(), description, amount, date });
                    showToast('Bi·∫øn ph√≠ kh√°c ƒë√£ ƒë∆∞·ª£c th√™m!', 'success');
                }
                updateOtherExpenseTable();
                calculateSummaryForDateRange();
                updateCharts();
                document.getElementById('other-expense-description').value = '';
                document.getElementById('other-expense-amount').value = '';
                document.getElementById('other-expense-date').value = '';
            } else {
                await showCustomModal('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin bi·∫øn ph√≠ kh√°c.', 'alert');
            }
        });

        document.getElementById('add-sale-btn').addEventListener('click', async () => {
            const itemName = document.getElementById('sale-item-name').value.trim();
            const quantity = parseFloat(document.getElementById('sale-quantity').value);
            const originalPrice = parseFloat(document.getElementById('sale-price').value);
            const date = document.getElementById('sale-date').value;
            const customerPhone = document.getElementById('sale-customer-phone').value.trim();
            let finalPrice = originalPrice;
            let discountApplied = 0;

            if (itemName && !isNaN(quantity) && !isNaN(originalPrice) && date) {
                // Check inventory before sale
                let foodItemInInventory = foodInventoryData.find(item => item.name.toLowerCase() === itemName.toLowerCase());

                if (!foodItemInInventory) {
                    await showCustomModal('L·ªói', 'Kh√¥ng t√¨m th·∫•y m·∫∑t h√†ng trong kho. Vui l√≤ng th√™m v√†o "Th·ª±c ph·∫©m & Kho" tr∆∞·ªõc.', 'alert');
                    return;
                }
                
                let availableQuantity = foodItemInInventory.quantity;
                if (editingSaleUUID) {
                    const existingSale = findItemByUUID(salesData, editingSaleUUID);
                    if (existingSale && existingSale.itemName.toLowerCase() === itemName.toLowerCase()) {
                        availableQuantity += existingSale.quantity; // Add back the quantity of the original sale
                    }
                }

                if (availableQuantity < quantity) {
                    await showCustomModal('L·ªói', `Kh√¥ng ƒë·ªß h√†ng t·ªìn kho cho ${itemName}. C√≥ s·∫µn: ${foodItemInInventory.quantity} ${foodItemInInventory.unit}.`, 'alert');
                    return;
                }

                let customer = null;
                if (customerPhone) {
                    customer = customersData.find(c => c.phoneNumber === customerPhone);
                    if (customer && (customer.purchaseCount || 0) >= MIN_LOYALTY_PURCHASES) {
                        const today = new Date().toISOString().slice(0, 10);
                        const activePromo = promotionsData.find(promo => 
                            promo.startDate <= today && promo.endDate >= today
                        );
                        if (activePromo) {
                            discountApplied = activePromo.discountPercentage;
                            finalPrice = originalPrice * (1 - (discountApplied / 100));
                            document.getElementById('discount-applied-text').textContent = `ƒê√£ √°p d·ª•ng gi·∫£m gi√°: ${discountApplied}%`;
                        } else {
                            document.getElementById('discount-applied-text').textContent = 'Kh√¥ng c√≥ khuy·∫øn m√£i ƒëang ho·∫°t ƒë·ªông.';
                        }
                    } else {
                        document.getElementById('discount-applied-text').textContent = 'Kh√°ch h√†ng ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán gi·∫£m gi√° (t·ªëi thi·ªÉu 3 l∆∞·ª£t mua).';
                    }
                } else {
                    document.getElementById('discount-applied-text').textContent = 'Ch∆∞a nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.';
                }

                const sale = { uuid: crypto.randomUUID(), itemName, quantity, originalPrice, price: finalPrice, date, customerPhone, discountApplied };

                if (editingSaleUUID) {
                    const existingSale = findItemByUUID(salesData, editingSaleUUID);
                    if (existingSale) {
                        // Restore old quantity to inventory
                        const oldFoodItem = foodInventoryData.find(item => item.name.toLowerCase() === existingSale.itemName.toLowerCase());
                        if (oldFoodItem) {
                            oldFoodItem.quantity += existingSale.quantity;
                        }

                        // Revert old customer loyalty points if applicable
                        if (existingSale.customerPhone) {
                            const oldCustomer = customersData.find(c => c.phoneNumber === existingSale.customerPhone);
                            if (oldCustomer) {
                                oldCustomer.purchaseCount = (oldCustomer.purchaseCount || 0) - 1;
                                oldCustomer.loyaltyPoints = (oldCustomer.loyaltyPoints || 0) - LOYALTY_POINTS_PER_PURCHASE;
                            }
                        }

                        // Apply new data
                        Object.assign(existingSale, sale);
                        foodItemInInventory.quantity -= quantity; // Deduct new quantity
                        showToast('Giao d·ªãch b√°n h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');

                        // Update new customer loyalty points if applicable
                        if (customer) {
                            customer.purchaseCount = (customer.purchaseCount || 0) + 1;
                            customer.loyaltyPoints = (customer.loyaltyPoints || 0) + LOYALTY_POINTS_PER_PURCHASE;
                        }
                    }
                    editingSaleUUID = null;
                    document.getElementById('add-sale-btn').textContent = 'Th√™m giao d·ªãch';
                } else {
                    salesData.push(sale);
                    foodItemInInventory.quantity -= quantity; // Deduct from inventory
                    showToast('Giao d·ªãch b√°n h√†ng ƒë√£ ƒë∆∞·ª£c th√™m!', 'success');

                    // Update customer's purchase count and loyalty points
                    if (customer) {
                        customer.purchaseCount = (customer.purchaseCount || 0) + 1;
                        customer.loyaltyPoints = (customer.loyaltyPoints || 0) + LOYALTY_POINTS_PER_PURCHASE;
                    }
                }
                updateFoodInventoryTable(); // Update inventory table after sale/edit
                updateSalesTable();
                updateCustomerTable(); // Update customer table for loyalty points
                calculateSummaryForDateRange();
                updateCharts();
                document.getElementById('sale-item-name').value = '';
                document.getElementById('sale-quantity').value = '';
                document.getElementById('sale-price').value = '';
                document.getElementById('sale-date').value = '';
                document.getElementById('sale-customer-phone').value = '';
                document.getElementById('discount-applied-text').textContent = 'Ch∆∞a √°p d·ª•ng gi·∫£m gi√°';
            } else {
                await showCustomModal('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin giao d·ªãch b√°n h√†ng.', 'alert');
            }
        });

        document.getElementById('add-product-item-btn').addEventListener('click', async () => {
            const name = document.getElementById('product-item-name').value.trim();
            const defaultUnit = document.getElementById('product-item-default-unit').value.trim();
            const defaultSellingPrice = parseFloat(document.getElementById('product-item-default-selling-price').value);
            const shelfLifeDays = parseFloat(document.getElementById('product-item-shelf-life-days').value);
            const dailyTargetQuantity = parseFloat(document.getElementById('product-item-daily-target-quantity').value);
            const dailyTargetUnit = document.getElementById('product-item-daily-target-unit').value.trim();

            if (name) {
                if (editingProductItemUUID) {
                    const productItem = findItemByUUID(productItemsData, editingProductItemUUID);
                    if (productItem) {
                        productItem.name = name;
                        productItem.defaultUnit = defaultUnit;
                        productItem.defaultSellingPrice = isNaN(defaultSellingPrice) ? 0 : defaultSellingPrice;
                        productItem.shelfLifeDays = isNaN(shelfLifeDays) ? 0 : shelfLifeDays;
                        productItem.dailyTargetQuantity = isNaN(dailyTargetQuantity) ? 0 : dailyTargetQuantity;
                        productItem.dailyTargetUnit = dailyTargetUnit;
                        showToast('M·∫∑t h√†ng ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');
                    }
                    editingProductItemUUID = null;
                    document.getElementById('add-product-item-btn').textContent = 'Th√™m M·∫∑t h√†ng';
                } else {
                    if (productItemsData.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                        await showCustomModal('L·ªói', 'M·∫∑t h√†ng n√†y ƒë√£ t·ªìn t·∫°i!', 'alert');
                        return;
                    }
                    productItemsData.push({ 
                        uuid: crypto.randomUUID(), 
                        name, 
                        defaultUnit, 
                        defaultSellingPrice: isNaN(defaultSellingPrice) ? 0 : defaultSellingPrice,
                        shelfLifeDays: isNaN(shelfLifeDays) ? 0 : shelfLifeDays,
                        dailyTargetQuantity: isNaN(dailyTargetQuantity) ? 0 : dailyTargetQuantity,
                        dailyTargetUnit: dailyTargetUnit
                    });
                    showToast('M·∫∑t h√†ng ƒë√£ ƒë∆∞·ª£c th√™m!', 'success');
                }
                updateProductItemsTable();
                updateProductDatalist();
                document.getElementById('product-item-name').value = '';
                document.getElementById('product-item-default-unit').value = '';
                document.getElementById('product-item-default-selling-price').value = '';
                document.getElementById('product-item-shelf-life-days').value = '';
                document.getElementById('product-item-daily-target-quantity').value = '';
                document.getElementById('product-item-daily-target-unit').value = '';
                updateCharts();
                updateDailyKpiTable();
            } else {
                await showCustomModal('L·ªói', 'Vui l√≤ng ƒëi·ªÅn t√™n m·∫∑t h√†ng.', 'alert');
            }
        });

        document.getElementById('add-promo-btn').addEventListener('click', async () => {
            const name = document.getElementById('promo-name').value.trim();
            const discountPercentage = parseFloat(document.getElementById('promo-discount-percentage').value);
            const startDate = document.getElementById('promo-start-date').value;
            const endDate = document.getElementById('promo-end-date').value;

            if (name && !isNaN(discountPercentage) && startDate && endDate) {
                if (discountPercentage < 0 || discountPercentage > 100) {
                    await showCustomModal('L·ªói', 'Ph·∫ßn trƒÉm gi·∫£m gi√° ph·∫£i t·ª´ 0 ƒë·∫øn 100.', 'alert');
                    return;
                }
                if (startDate > endDate) {
                    await showCustomModal('L·ªói', 'Ng√†y b·∫Øt ƒë·∫ßu kh√¥ng th·ªÉ sau ng√†y k·∫øt th√∫c.', 'alert');
                    return;
                }

                const promo = { uuid: crypto.randomUUID(), name, discountPercentage, startDate, endDate };
                if (editingPromoUUID) {
                    const existingPromo = findItemByUUID(promotionsData, editingPromoUUID);
                    if (existingPromo) {
                        Object.assign(existingPromo, promo);
                        showToast('Khuy·∫øn m√£i ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!', 'success');
                    }
                    editingPromoUUID = null;
                    document.getElementById('add-promo-btn').textContent = 'Th√™m Khuy·∫øn m√£i';
                } else {
                    promotionsData.push(promo);
                    showToast('Khuy·∫øn m√£i ƒë√£ ƒë∆∞·ª£c th√™m!', 'success');
                }
                updatePromotionsTable();
                document.getElementById('promo-name').value = '';
                document.getElementById('promo-discount-percentage').value = '';
                document.getElementById('promo-start-date').value = '';
                document.getElementById('promo-end-date').value = '';
            } else {
                await showCustomModal('L·ªói', 'Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin khuy·∫øn m√£i.', 'alert');
            }
        });


        document.getElementById('export-all-data-json-btn').addEventListener('click', () => {
            const allData = {
                salesData: salesData,
                otherExpensesData: otherExpensesData,
                customersData: customersData,
                foodInventoryData: foodInventoryData,
                productItemsData: productItemsData,
                purchaseHistoryData: purchaseHistoryData,
                promotionsData: promotionsData
            };
            const jsonString = JSON.stringify(allData, null, 2);
            downloadFile(jsonString, 'business_data.json', 'application/json');
            showToast('ƒê√£ xu·∫•t t·∫•t c·∫£ d·ªØ li·ªáu th√†nh JSON!', 'info');
        });

        document.getElementById('import-data-btn').addEventListener('click', () => {
            document.getElementById('import-data-file').click();
        });

        document.getElementById('import-data-file').addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async (e) => { // Use async here
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.salesData) salesData = importedData.salesData;
                    if (importedData.otherExpensesData) otherExpensesData = importedData.otherExpensesData;
                    if (importedData.customersData) customersData = importedData.customersData;
                    if (importedData.foodInventoryData) foodInventoryData = importedData.foodInventoryData;
                    if (importedData.productItemsData) productItemsData = importedData.productItemsData;
                    if (importedData.purchaseHistoryData) purchaseHistoryData = importedData.purchaseHistoryData;
                    if (importedData.promotionsData) promotionsData = importedData.promotionsData;


                    localStorage.setItem('salesData', JSON.stringify(salesData));
                    localStorage.setItem('otherExpensesData', JSON.stringify(otherExpensesData));
                    localStorage.setItem('customersData', JSON.stringify(customersData));
                    localStorage.setItem('foodInventoryData', JSON.stringify(foodInventoryData));
                    localStorage.setItem('productItemsData', JSON.stringify(productItemsData));
                    localStorage.setItem('purchaseHistoryData', JSON.stringify(purchaseHistoryData));
                    localStorage.setItem('promotionsData', JSON.stringify(promotionsData));


                    initializeApp();
                    showToast('D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c nh·∫≠p th√†nh c√¥ng!', 'success');
                } catch (error) {
                    await showCustomModal('L·ªói', 'L·ªói khi ƒë·ªçc t·ªáp JSON. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng t·ªáp.', 'error');
                    console.error('Error importing data:', error);
                    showToast('L·ªói khi nh·∫≠p d·ªØ li·ªáu!', 'error');
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        document.getElementById('export-summary-csv-btn').addEventListener('click', () => {
            const start = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const end = endDateFilter.value ? new Date(endDateFilter.value) : null;

            let filteredSales = salesData;
            let filteredOtherExpenses = otherExpensesData;
            let filteredPurchases = purchaseHistoryData;
            let filteredCustomers = customersData;

            if (start && end) {
                filteredSales = salesData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= start && saleDate <= end;
                });
                filteredOtherExpenses = otherExpensesData.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });
                filteredPurchases = purchaseHistoryData.filter(purchase => {
                    const purchaseDate = new Date(purchase.date);
                    return purchaseDate >= start && purchaseDate <= end;
                });
                filteredCustomers = customersData.filter(customer => {
                    const lastContactDate = new Date(customer.lastContact);
                    return lastContactDate >= start && lastContactDate <= end;
                });
            } else if (start && !end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) >= start);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) >= start);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) >= start);
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) >= start);
            } else if (!start && end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) <= end);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) <= end);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) <= end);
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) <= end);
            }

            const totalIncome = filteredSales.reduce((sum, sale) => sum + sale.price, 0);
            const totalOtherExpense = filteredOtherExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalPurchaseCost = filteredPurchases.reduce((sum, purchase) => sum + purchase.totalCost, 0);
            const estimatedProfit = totalIncome - totalOtherExpense - totalPurchaseCost;
            const uniqueCustomers = new Set(filteredCustomers.map(c => c.name)).size;

            const summaryData = [
                {
                    'Metric': 'Total Revenue',
                    'Value': totalIncome
                },
                {
                    'Metric': 'Customers Interacted',
                    'Value': uniqueCustomers
                },
                {
                    'Metric': 'Estimated Profit',
                    'Value': estimatedProfit
                },
                {
                    'Metric': 'Total Customers (Overall)',
                    'Value': customersData.length
                },
                {
                    'Metric': 'Total Product Items (Overall)',
                    'Value': productItemsData.length
                }
            ];

            if (start && end) {
                summaryData.unshift({ 'Metric': 'Date Range', 'Value': `${formatDate(start.toISOString().slice(0,10))} - ${formatDate(end.toISOString().slice(0,10))}` });
            } else if (start) {
                summaryData.unshift({ 'Metric': 'Date Range', 'Value': `From ${formatDate(start.toISOString().slice(0,10))}` });
            } else if (end) {
                summaryData.unshift({ 'Metric': 'Date Range', 'Value': `Up to ${formatDate(end.toISOString().slice(0,10))}` });
            }

            const headers = [
                { key: 'Metric', label: 'Metric' },
                { key: 'Value', label: 'Value' }
            ];
            const csv = convertToCsv(summaryData, headers);
            downloadFile(csv, 'overall_summary.csv', 'text/csv;charset=utf-8;');
            showToast('ƒê√£ xu·∫•t b√°o c√°o t·ªïng quan CSV!', 'info');
        });


        document.getElementById('export-customers-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Customer Name' },
                { key: 'phoneNumber', label: 'Phone Number' },
                { key: 'lastContact', label: 'Last Contact Date' },
                { key: 'nextFollowup', label: 'Next Followup Date' },
                { key: 'status', label: 'Status' },
                { key: 'purchaseCount', label: 'Purchase Count' },
                { key: 'loyaltyPoints', label: 'Loyalty Points' },
                { key: 'tier', label: 'Tier' }
            ];
            const csv = convertToCsv(customersData, headers);
            downloadFile(csv, 'customers.csv', 'text/csv;charset=utf-8;');
            showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu kh√°ch h√†ng CSV!', 'info');
        });

        document.getElementById('export-food-inventory-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Food Item Name' },
                { key: 'quantity', label: 'Quantity' },
                { key: 'unit', label: 'Unit' },
                { key: 'expiryDate', label: 'Expiry Date' }
            ];
            const csv = convertToCsv(foodInventoryData, headers);
            downloadFile(csv, 'food_inventory.csv', 'text/csv;charset=utf-8;');
            showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu t·ªìn kho th·ª±c ph·∫©m CSV!', 'info');
        });

        document.getElementById('export-purchase-history-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'itemName', label: 'Item Name' },
                { key: 'quantity', label: 'Quantity' },
                { key: 'unit', label: 'Unit' },
                { key: 'purchasePrice', label: 'Unit Purchase Price' },
                { key: 'totalCost', label: 'Total Cost' },
                { key: 'date', label: 'Date' },
                { key: 'expiryDate', label: 'Expiry Date' }
            ];
            const csv = convertToCsv(purchaseHistoryData, headers);
            downloadFile(csv, 'purchase_history.csv', 'text/csv;charset=utf-8;');
            showToast('ƒê√£ xu·∫•t l·ªãch s·ª≠ mua h√†ng CSV!', 'info');
        });

        document.getElementById('export-other-expenses-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'description', label: 'Description' },
                { key: 'amount', label: 'Amount (VND)' },
                { key: 'date', label: 'Date' }
            ];
            const csv = convertToCsv(otherExpensesData, headers);
            downloadFile(csv, 'other_expenses.csv', 'text/csv;charset=utf-8;');
            showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu bi·∫øn ph√≠ kh√°c CSV!', 'info');
        });

        document.getElementById('export-sales-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'date', label: 'Date' },
                { key: 'itemName', label: 'Product/Service Name' },
                { key: 'quantity', label: 'Quantity' },
                { key: 'originalPrice', label: 'Original Revenue (VND)' },
                { key: 'price', label: 'Final Revenue (VND)' },
                { key: 'discountApplied', label: 'Discount Applied (%)' },
                { key: 'customerPhone', label: 'Customer Phone' }
            ];
            const csv = convertToCsv(salesData, headers);
            downloadFile(csv, 'sales.csv', 'text/csv;charset=utf-8;');
            showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu doanh thu CSV!', 'info');
        });

        document.getElementById('export-product-items-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Item Name' },
                { key: 'defaultUnit', label: 'Default Unit' },
                { key: 'defaultSellingPrice', label: 'Default Selling Price (VND)' },
                { key: 'shelfLifeDays', label: 'Shelf Life (Days)' },
                { key: 'dailyTargetQuantity', label: 'Daily Target Quantity' },
                { key: 'dailyTargetUnit', label: 'Daily Target Unit' }
            ];
            const csv = convertToCsv(productItemsData, headers);
            downloadFile(csv, 'product_items.csv', 'text/csv;charset=utf-8;');
            showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu m·∫∑t h√†ng CSV!', 'info');
        });

        document.getElementById('export-promotions-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Promotion Name' },
                { key: 'discountPercentage', label: 'Discount Percentage' },
                { key: 'startDate', label: 'Start Date' },
                { key: 'endDate', label: 'End Date' }
            ];
            const csv = convertToCsv(promotionsData, headers);
            downloadFile(csv, 'promotions.csv', 'text/csv;charset=utf-8;');
            showToast('ƒê√£ xu·∫•t d·ªØ li·ªáu khuy·∫øn m√£i CSV!', 'info');
        });


        // Event Listeners for Navigation
        navSectionButtons.forEach(item => { // Changed to use navSectionButtons
            item.addEventListener('click', () => {
                const sectionId = `section-${item.id.replace('nav-', '')}`;
                showSection(sectionId);
            });
        });

        // Event listeners for date filters and low stock threshold
        startDateFilter.addEventListener('change', () => {
            calculateSummaryForDateRange();
            updateCharts(); // Update charts when date range changes
        });
        endDateFilter.addEventListener('change', () => {
            calculateSummaryForDateRange();
            updateCharts(); // Update charts when date range changes
        });
        lowStockThresholdInput.addEventListener('change', updateFoodInventoryTable);
        minDaysBeforeExpiryWarningInput.addEventListener('change', updateFoodInventoryTable);
        kpiTargetPercentageInput.addEventListener('change', updateDailyKpiTable);


        document.getElementById('update-kpi-targets-btn').addEventListener('click', async () => {
            const kpiTargetPercentage = parseFloat(kpiTargetPercentageInput.value) / 100 || 0.8;
            const todayStr = new Date().toISOString().slice(0, 10);
            let updatedCount = 0;

            productItemsData.forEach(item => {
                if (!item.dailyTargetQuantity || item.dailyTargetQuantity <= 0) return;

                const actualSoldToday = salesData
                    .filter(sale => sale.date === todayStr && sale.itemName.toLowerCase() === item.name.toLowerCase())
                    .reduce((sum, sale) => sum + sale.quantity, 0);

                const kpiAchievement = (actualSoldToday / item.dailyTargetQuantity);

                if (kpiAchievement < kpiTargetPercentage) {
                    // Increase target by a small percentage, e.g., 5%
                    item.dailyTargetQuantity = Math.ceil(item.dailyTargetQuantity * 1.05);
                    updatedCount++;
                }
            });
            updateProductItemsTable(); // Refresh the table where product item targets are shown
            updateDailyKpiTable(); // Recalculate and display KPIs
            if (updatedCount > 0) {
                showToast(`ƒê√£ c·∫≠p nh·∫≠t ch·ªâ ti√™u KPI cho ${updatedCount} m·∫∑t h√†ng cho ng√†y ti·∫øp theo!`, 'success');
            } else {
                showToast('T·∫•t c·∫£ m·∫∑t h√†ng ƒë·ªÅu ƒë·∫°t ch·ªâ ti√™u KPI ho·∫∑c kh√¥ng c√≥ ch·ªâ ti√™u.', 'info');
            }
        });

         document.getElementById('sale-customer-phone').addEventListener('input', () => {
            const customerPhone = document.getElementById('sale-customer-phone').value.trim();
            const discountTextElement = document.getElementById('discount-applied-text');

            if (customerPhone) {
                const customer = customersData.find(c => c.phoneNumber === customerPhone);
                if (customer && (customer.purchaseCount || 0) >= MIN_LOYALTY_PURCHASES) {
                    const today = new Date().toISOString().slice(0, 10);
                    const activePromo = promotionsData.find(promo => 
                        promo.startDate <= today && promo.endDate >= today
                    );
                    if (activePromo) {
                        discountTextElement.textContent = `ƒê√£ √°p d·ª•ng gi·∫£m gi√°: ${activePromo.discountPercentage}%`;
                    } else {
                        discountTextElement.textContent = 'Kh√¥ng c√≥ khuy·∫øn m√£i ƒëang ho·∫°t ƒë·ªông.';
                    }
                } else {
                    discountTextElement.textContent = `Kh√°ch h√†ng ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán gi·∫£m gi√° (t·ªëi thi·ªÉu ${MIN_LOYALTY_PURCHASES} l∆∞·ª£t mua).`;
                }
            } else {
                discountTextElement.textContent = 'Ch∆∞a nh·∫≠p s·ªë ƒëi·ªán tho·∫°i.';
            }
        });

        // Theme Toggle Logic
        document.getElementById('theme-toggle').addEventListener('click', () => {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            const currentThemeText = document.getElementById('current-theme');
            if (isDarkMode) {
                localStorage.setItem('theme', 'dark');
                currentThemeText.textContent = 'T·ªëi üåë';
            } else {
                localStorage.setItem('theme', 'light');
                currentThemeText.textContent = 'S√°ng ‚òÄÔ∏è';
            }
            updateCharts(); // Redraw charts to adjust colors if needed (Chart.js usually handles this, but good to ensure)
        });

        // Toggle Chart Visibility Logic
        document.querySelectorAll('.toggle-chart-visibility').forEach(button => {
            button.addEventListener('click', (event) => {
                const targetId = event.target.dataset.target;
                const targetCard = document.getElementById(targetId);
                if (targetCard) {
                    const isHidden = targetCard.classList.toggle('hidden');
                    event.target.textContent = isHidden ? 'Hi·ªán' : '·∫®n';
                    // Re-render charts if they become visible, to ensure proper sizing
                    if (!isHidden && targetCard.querySelector('canvas')) {
                        updateCharts(); // Re-initialize all charts to ensure correct rendering
                    }
                }
            });
        });


        initializeApp();
    </script>
</body>
</html>
