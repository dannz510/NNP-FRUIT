<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ứng Dụng Theo Dõi Dữ Liệu Kinh Doanh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F7F4;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .nav-item.active {
            background-color: #4CAF50;
            color: white;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .low-stock-alert {
            background-color: #ffe0b2; /* Light orange */
            color: #e65100; /* Darker orange */
            font-weight: 500;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">
    <!-- Chosen Palette: Calm Harmony -->
    <!-- Application Structure Plan: Ứng dụng được thiết kế theo cấu trúc bảng điều khiển (dashboard) với thanh điều hướng bên trái và khu vực nội dung chính bên phải. Cấu trúc này được chọn để nhóm các loại dữ liệu khác nhau (tổng quan, khách hàng, thực phẩm, tài chính, mặt hàng, quản lý dữ liệu) một cách logic, giúp người dùng dễ dàng chuyển đổi giữa các phần và tập trung vào từng loại thông tin cụ thể. Mỗi phần có các chỉ số, biểu đồ và bảng dữ liệu riêng, cùng với các tương tác như thêm, chỉnh sửa, xóa, xuất/nhập, sắp xếp bảng và sử dụng datalist cho các trường nhập liệu. Bộ lọc ngày tháng trên Tổng quan và cảnh báo tồn kho thấp là các điểm nhấn chuyên nghiệp. CSV được xuất ra với tiêu đề tiếng Anh để tránh lỗi font và dễ dàng sử dụng hơn. Lời lỗ được tính toán dựa trên dữ liệu mua hàng và bán hàng. -->
    <!-- Visualization & Content Choices:
    - Tổng quan:
        - Mục tiêu: Hiển thị tổng quan nhanh về hiệu suất theo ngày hoặc theo khoảng thời gian tùy chọn.
        - Viz/Presentation: Các chỉ số KPI lớn (thu nhập, khách hàng, lợi nhuận, tổng khách hàng, tổng mặt hàng). Biểu đồ đường (Chart.js) cho xu hướng thu nhập 7 ngày. Biểu đồ cột (Chart.js) cho lợi nhuận theo loại thực phẩm (top 5).
        - Tương tác: Lọc theo khoảng thời gian cho KPIs, chỉ hiển thị biểu đồ xu hướng.
        - Lý do: Cung cấp cái nhìn tổng thể linh hoạt, giúp người dùng nhanh chóng nắm bắt tình hình kinh doanh.
        - Thư viện/Phương pháp: Chart.js (Canvas), HTML/CSS (Tailwind), Vanilla JS (lọc ngày).
    - Khách hàng:
        - Mục tiêu: Quản lý và theo dõi thông tin tương tác với khách hàng.
        - Viz/Presentation: Bảng dữ liệu (HTML table). Form nhập liệu đơn giản.
        - Tương tác: Thêm khách hàng mới, cập nhật trạng thái theo dõi, xuất CSV (tiếng Anh), chỉnh sửa, xóa, sắp xếp cột.
        - Lý do: Định dạng bảng là hiệu quả nhất để xem và quản lý dữ liệu bản ghi riêng lẻ, với khả năng chỉnh sửa và sắp xếp tăng cường tính chuyên nghiệp.
        - Thư viện/Phương pháp: HTML/CSS (Tailwind), Vanilla JS.
    - Thực phẩm & Kho:
        - Mục tiêu: Theo dõi tồn kho thực phẩm, quản lý chi phí mua hàng và biến phí.
        - Viz/Presentation: Ba bảng riêng biệt: "Tồn kho thực phẩm", "Lịch sử Mua hàng" và "Biến phí khác". Các trường nhập liệu sử dụng datalist cho tên thực phẩm. Ngưỡng tồn kho thấp có thể cấu hình.
        - Tương tác: Thêm/cập nhật/xóa các mục, xem lịch sử mua hàng, xuất CSV (tiếng Anh), chỉnh sửa, sắp xếp cột, cảnh báo tồn kho thấp trực quan.
        - Lý do: Giúp người dùng dễ dàng theo dõi chi tiết về vật tư và chi phí vận hành, với cảnh báo sớm cho các mặt hàng sắp hết. Tính năng mua hàng riêng biệt hỗ trợ tính toán lời lỗ chính xác hơn.
        - Thư viện/Phương pháp: HTML/CSS (Tailwind), Vanilla JS.
    - Tài chính:
        - Mục tiêu: Cung cấp cái nhìn chi tiết về doanh thu, chi phí và lợi nhuận.
        - Viz/Presentation: Bảng "Doanh thu chi tiết" và biểu đồ đường (Chart.js) để minh họa xu hướng doanh thu và lợi nhuận hàng tháng. Datalist cho tên sản phẩm/dịch vụ.
        - Tương tác: Thêm/chỉnh sửa/xóa giao dịch, xem dữ liệu tổng hợp, xuất CSV (tiếng Anh), sắp xếp cột.
        - Lý do: Kết hợp dữ liệu chi tiết với biểu đồ xu hướng giúp người dùng phân tích hiệu quả tài chính.
        - Thư viện/Phương pháp: Chart.js (Canvas), HTML/CSS (Tailwind), Vanilla JS.
    - Quản lý Mặt hàng:
        - Mục tiêu: Tạo và quản lý danh sách các mặt hàng/sản phẩm có sẵn tại cửa hàng.
        - Viz/Presentation: Bảng dữ liệu. Form nhập liệu.
        - Tương tác: Thêm mặt hàng mới, chỉnh sửa, xóa mặt hàng, sắp xếp cột.
        - Lý do: Cung cấp nguồn dữ liệu chuẩn, tăng tính nhất quán và tiện lợi khi nhập liệu, đặc biệt với datalist.
        - Thư viện/Phương pháp: HTML/CSS (Tailwind), Vanilla JS.
    - Quản lý Dữ liệu:
        - Mục tiêu: Cung cấp các công cụ để sao lưu và khôi phục dữ liệu người dùng, bao gồm cả xuất báo cáo tổng quan.
        - Viz/Presentation: Nút (buttons) cho chức năng xuất dữ liệu (JSON tổng hợp), và một input file + nút để nhập dữ liệu (JSON tổng hợp). Nút xuất báo cáo tổng quan CSV.
        - Tương tác: Nhấp vào nút để tải xuống file; chọn file để tải lên và cập nhật dữ liệu.
        - Lý do: Đáp ứng nhu cầu sao lưu và chia sẻ dữ liệu dễ dàng cho người dùng cuối cùng, cùng với khả năng tạo báo cáo nhanh.
        - Thư viện/Phương pháp: HTML/CSS (Tailwind), Vanilla JS (JSON.stringify, Blob, FileReader).
    - Giao diện người dùng (UI):
        - Mục tiêu: Đảm bảo trải nghiệm người dùng trực quan, dễ sử dụng, và hiển thị đẹp mắt trên mọi thiết bị.
        - Phương pháp trình bày: Bố cục đáp ứng (Tailwind CSS Flexbox/Grid), thanh điều hướng bên trái, khu vực nội dung chính. Các nút, dropdown, datalist, sắp xếp bảng cho tương tác.
        - Tương tác: Chuyển đổi giữa các phần, nhập/sửa/xóa dữ liệu.
        - Lý do: Cấu trúc SPA rõ ràng giúp người dùng tập trung vào từng phần dữ liệu mà không bị phân tâm.
        - Thư viện/Phương pháp: HTML/CSS (Tailwind), Vanilla JS.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->

    <!-- Thanh Điều Hướng Bên Trái -->
    <nav class="w-full md:w-64 bg-white p-6 shadow-lg rounded-xl m-4 flex-shrink-0">
        <div class="text-xl font-bold text-gray-800 mb-6">Quản lý Kinh doanh</div>
        <ul class="space-y-2">
            <li>
                <button id="nav-tongquan" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700 active">
                    Tổng quan
                </button>
            </li>
            <li>
                <button id="nav-khachhang" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Khách hàng
                </button>
            </li>
            <li>
                <button id="nav-thucphamkho" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Thực phẩm & Kho
                </button>
            </li>
            <li>
                <button id="nav-taichinh" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Tài chính
                </button>
            </li>
            <li>
                <button id="nav-quanlymathang" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Quản lý Mặt hàng
                </button>
            </li>
            <li>
                <button id="nav-quanlydulieu" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Quản lý Dữ liệu
                </button>
            </li>
        </ul>
    </nav>

    <!-- Khu Vực Nội Dung Chính -->
    <main class="flex-grow p-4 md:p-8">
        <!-- Tổng quan Section -->
        <section id="section-tongquan" class="content-section active bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Tổng quan</h2>
            <p class="text-gray-600 mb-6">Phần này cung cấp một cái nhìn tổng thể về hiệu suất kinh doanh của bạn, bao gồm các chỉ số chính và xu hướng quan trọng. Bạn có thể chọn khoảng thời gian để xem các chỉ số.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="start-date-filter" class="block text-sm font-medium text-gray-700">Từ ngày</label>
                    <input type="date" id="start-date-filter" class="mt-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                </div>
                <div>
                    <label for="end-date-filter" class="block text-sm font-medium text-gray-700">Đến ngày</label>
                    <input type="date" id="end-date-filter" class="mt-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Tổng thu nhập</div>
                    <div id="total-income-range" class="text-3xl font-bold text-blue-600">0 VNĐ</div>
                </div>
                <div class="bg-green-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Khách hàng tương tác</div>
                    <div id="customers-in-range" class="text-3xl font-bold text-green-600">0</div>
                </div>
                <div class="bg-red-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Lợi nhuận ước tính</div>
                    <div id="profit-in-range" class="text-3xl font-bold text-red-600">0 VNĐ</div>
                </div>
                 <div class="bg-purple-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Tổng số khách hàng</div>
                    <div id="total-customers-kpi" class="text-3xl font-bold text-purple-600">0</div>
                </div>
                <div class="bg-yellow-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Tổng số mặt hàng</div>
                    <div id="total-products-kpi" class="text-3xl font-bold text-yellow-600">0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Xu hướng Thu nhập (7 ngày qua)</h3>
                    <div class="chart-container">
                        <canvas id="dailyIncomeChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Lợi nhuận theo Thực phẩm (Top 5)</h3>
                    <div class="chart-container">
                        <canvas id="profitByFoodChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Khách hàng Section -->
        <section id="section-khachhang" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Khách hàng</h2>
            <p class="text-gray-600 mb-6">Theo dõi thông tin và lịch sử tương tác với khách hàng của bạn để đảm bảo việc theo dõi hiệu quả.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm khách hàng mới / Lịch theo dõi</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="customer-name" placeholder="Tên khách hàng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="date" id="customer-last-contact" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="date" id="customer-next-followup" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <select id="customer-status" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 mb-4">
                    <option value="Đang theo dõi">Đang theo dõi</option>
                    <option value="Đã liên hệ">Đã liên hệ</option>
                    <option value="Đã hoàn thành">Đã hoàn thành</option>
                    <option value="Tạm dừng">Tạm dừng</option>
                </select>
                <button id="add-customer-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm khách hàng</button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">Tên Khách hàng &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="lastContact">Ngày tương tác cuối &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="nextFollowup">Ngày theo dõi tiếp &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="status">Trạng thái &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="customer-table-body">
                        <!-- Customer data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-customers-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Khách hàng</button>
            </div>
        </section>

        <!-- Thực phẩm & Kho Section -->
        <section id="section-thucphamkho" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Thực phẩm & Kho</h2>
            <p class="text-gray-600 mb-6">Giám sát tồn kho thực phẩm, theo dõi chi phí mua hàng và quản lý các biến phí liên quan đến vận hành.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Tồn kho thực phẩm -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tồn kho thực phẩm</h3>
                    <div class="mb-4">
                        <label for="low-stock-threshold" class="block text-sm font-medium text-gray-700 mb-1">Ngưỡng tồn kho thấp:</label>
                        <input type="number" id="low-stock-threshold" value="10" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 w-full">
                    </div>
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <input type="text" id="food-item-name" list="product-names-list" placeholder="Tên thực phẩm" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <datalist id="product-names-list"></datalist>
                        <div class="flex gap-2">
                            <input type="number" id="food-item-quantity" placeholder="Số lượng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                            <input type="text" id="food-item-unit" placeholder="Đơn vị (kg, lít, cái...)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                        </div>
                    </div>
                    <button id="add-food-item-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm/Cập nhật tồn kho</button>
                    <div class="overflow-x-auto mt-4 rounded-lg shadow-md">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">Tên Thực phẩm &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="quantity">Số lượng &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="unit">Đơn vị &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="food-inventory-table-body">
                                <!-- Food inventory data will be inserted here -->
                            </tbody>
                        </table>
                        <button id="export-food-inventory-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Tồn kho</button>
                    </div>
                </div>

                <!-- Mua hàng & Biến phí -->
                <div class="grid grid-cols-1 gap-6">
                    <!-- Thêm Giao dịch Mua hàng -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm Giao dịch Mua hàng</h3>
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <input type="text" id="purchase-item-name" list="product-names-list" placeholder="Tên mặt hàng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="purchase-quantity" placeholder="Số lượng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="text" id="purchase-unit" placeholder="Đơn vị (kg, lít, cái...)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="purchase-price-per-unit" placeholder="Giá mua mỗi đơn vị (VNĐ)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="date" id="purchase-date" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <button id="add-purchase-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm Giao dịch Mua</button>
                        <div class="overflow-x-auto mt-4 rounded-lg shadow-md">
                            <h3 class="text-md font-semibold text-gray-800 mb-2 p-2">Lịch sử Mua hàng</h3>
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead>
                                    <tr>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="itemName">Mặt hàng &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="quantity">SL &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="purchasePrice">Giá/Đơn vị &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="totalCost">Tổng chi phí &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="date">Ngày &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="purchase-history-table-body">
                                    <!-- Purchase history data will be inserted here -->
                                </tbody>
                            </table>
                            <button id="export-purchase-history-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Lịch sử Mua hàng</button>
                        </div>
                    </div>

                    <!-- Biến phí khác -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm Biến phí khác</h3>
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <input type="text" id="other-expense-description" placeholder="Mô tả (ví dụ: Tiền điện, Tiếp thị)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="other-expense-amount" placeholder="Số tiền (VNĐ)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="date" id="other-expense-date" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <button id="add-other-expense-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm Biến phí</button>
                        <div class="overflow-x-auto mt-4 rounded-lg shadow-md">
                             <h3 class="text-md font-semibold text-gray-800 mb-2 p-2">Lịch sử Biến phí khác</h3>
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead>
                                    <tr>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="description">Mô tả &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="amount">Số tiền (VNĐ) &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="date">Ngày &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="other-expense-table-body">
                                    <!-- Other expense data will be inserted here -->
                                </tbody>
                            </table>
                             <button id="export-other-expenses-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Biến phí khác</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tài chính Section -->
        <section id="section-taichinh" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Tài chính</h2>
            <p class="text-gray-600 mb-6">Phân tích chi tiết doanh thu, chi phí và lợi nhuận của bạn để đưa ra các quyết định tài chính sáng suốt.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm giao dịch bán hàng</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="sale-item-name" list="product-names-list" placeholder="Tên sản phẩm/dịch vụ" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="sale-quantity" placeholder="Số lượng bán" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="sale-price" placeholder="Doanh thu (VNĐ)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <input type="date" id="sale-date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 mb-4">
                <button id="add-sale-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm giao dịch</button>
            </div>

            <div class="overflow-x-auto mb-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-2 p-2">Doanh thu chi tiết</h3>
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="date">Ngày &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="itemName">Sản phẩm/Dịch vụ &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="quantity">Số lượng &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="price">Doanh thu (VNĐ) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body">
                        <!-- Sales data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-sales-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Doanh thu</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Xu hướng Doanh thu & Lợi nhuận hàng tháng</h3>
                    <div class="chart-container">
                        <canvas id="monthlyFinancialChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quản lý Mặt hàng Section -->
        <section id="section-quanlymathang" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Mặt hàng</h2>
            <p class="text-gray-600 mb-6">Định nghĩa và quản lý danh sách các mặt hàng/sản phẩm có sẵn trong cửa hàng của bạn. Danh sách này sẽ được sử dụng để nhập liệu trong các phần khác.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm Mặt hàng mới</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="product-item-name" placeholder="Tên mặt hàng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="product-item-default-unit" placeholder="Đơn vị mặc định (ví dụ: kg, lít, cái)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <button id="add-product-item-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm Mặt hàng</button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">Tên Mặt hàng &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="defaultUnit">Đơn vị mặc định &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="product-items-table-body">
                        <!-- Product items data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-product-items-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Mặt hàng</button>
            </div>
        </section>

        <!-- Quản lý Dữ liệu Section -->
        <section id="section-quanlydulieu" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Dữ liệu</h2>
            <p class="text-gray-600 mb-6">Sử dụng các công cụ dưới đây để sao lưu hoặc khôi phục dữ liệu kinh doanh của bạn. Dữ liệu được lưu trữ dưới định dạng JSON.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Xuất / Nhập Toàn Bộ Dữ liệu</h3>
                <button id="export-all-data-json-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 ease-in-out w-full mb-4">
                    Xuất Tất Cả Dữ liệu (JSON)
                </button>
                 <button id="export-summary-csv-btn" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition duration-200 ease-in-out w-full mb-4">
                    Export Overall Summary (CSV)
                </button>
                <input type="file" id="import-data-file" accept=".json" class="hidden">
                <button id="import-data-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition duration-200 ease-in-out w-full">
                    Nhập Dữ liệu Từ File (JSON)
                </button>
            </div>
        </section>
    </main>

    <script>
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');

        const totalIncomeRangeElement = document.getElementById('total-income-range');
        const customersInRangeElement = document.getElementById('customers-in-range');
        const profitInRangeElement = document.getElementById('profit-in-range');
        const totalCustomersKPIElement = document.getElementById('total-customers-kpi');
        const totalProductsKPIElement = document.getElementById('total-products-kpi');

        const startDateFilter = document.getElementById('start-date-filter');
        const endDateFilter = document.getElementById('end-date-filter');
        const lowStockThresholdInput = document.getElementById('low-stock-threshold');

        let salesData = JSON.parse(localStorage.getItem('salesData')) || [];
        let otherExpensesData = JSON.parse(localStorage.getItem('otherExpensesData')) || []; // Renamed from expensesData
        let customersData = JSON.parse(localStorage.getItem('customersData')) || [];
        let foodInventoryData = JSON.parse(localStorage.getItem('foodInventoryData')) || [];
        let productItemsData = JSON.parse(localStorage.getItem('productItemsData')) || [];
        let purchaseHistoryData = JSON.parse(localStorage.getItem('purchaseHistoryData')) || []; // New: Purchase History

        let dailyIncomeChartInstance;
        let profitByFoodChartInstance;
        let monthlyFinancialChartInstance;

        let editingCustomerIndex = -1;
        let editingFoodInventoryIndex = -1;
        let editingOtherExpenseIndex = -1; // Updated
        let editingSaleIndex = -1;
        let editingProductItemIndex = -1;
        let editingPurchaseHistoryIndex = -1; // New

        function showSection(sectionId) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            document.getElementById(sectionId).classList.add('active');

            navItems.forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`nav-${sectionId.replace('section-', '')}`).classList.add('active');

            updateAllTables();
            updateProductDatalist();
            updateCharts();
            updateSummaryKPIs();
            if (sectionId === 'section-tongquan') {
                const today = new Date().toISOString().slice(0, 10);
                if (!startDateFilter.value) startDateFilter.value = today;
                if (!endDateFilter.value) endDateFilter.value = today;
                calculateSummaryForDateRange();
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${day}/${month}/${year}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'VND' }).format(amount); // Changed to en-US locale for consistency
        }

        function calculateSummaryForDateRange() {
            const start = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const end = endDateFilter.value ? new Date(endDateFilter.value) : null;

            let filteredSales = salesData;
            let filteredOtherExpenses = otherExpensesData;
            let filteredPurchases = purchaseHistoryData; // New
            let filteredCustomers = customersData;

            if (start && end) {
                filteredSales = salesData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= start && saleDate <= end;
                });
                filteredOtherExpenses = otherExpensesData.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });
                filteredPurchases = purchaseHistoryData.filter(purchase => { // New
                    const purchaseDate = new Date(purchase.date);
                    return purchaseDate >= start && purchaseDate <= end;
                });
                filteredCustomers = customersData.filter(customer => {
                    const lastContactDate = new Date(customer.lastContact);
                    return lastContactDate >= start && lastContactDate <= end;
                });
            } else if (start && !end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) >= start);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) >= start);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) >= start); // New
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) >= start);
            } else if (!start && end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) <= end);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) <= end);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) <= end); // New
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) <= end);
            }

            const totalIncome = filteredSales.reduce((sum, sale) => sum + sale.price, 0);
            const totalOtherExpense = filteredOtherExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalPurchaseCost = filteredPurchases.reduce((sum, purchase) => sum + purchase.totalCost, 0); // New
            const estimatedProfit = totalIncome - totalOtherExpense - totalPurchaseCost; // Updated Profit Calc

            const uniqueCustomers = new Set(filteredCustomers.map(c => c.name)).size;

            totalIncomeRangeElement.textContent = formatCurrency(totalIncome);
            customersInRangeElement.textContent = uniqueCustomers;
            profitInRangeElement.textContent = formatCurrency(estimatedProfit);
        }

        function updateSummaryKPIs() {
            totalCustomersKPIElement.textContent = customersData.length;
            totalProductsKPIElement.textContent = productItemsData.length;
        }

        function updateCustomerTable() {
            const tbody = document.getElementById('customer-table-body');
            tbody.innerHTML = '';
            customersData.forEach((customer, index) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = customer.name;
                row.insertCell().textContent = formatDate(customer.lastContact);
                row.insertCell().textContent = formatDate(customer.nextFollowup);
                row.insertCell().textContent = customer.status;
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-index="${index}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-index="${index}">Xóa</button>
                `;
            });
            localStorage.setItem('customersData', JSON.stringify(customersData));
            attachTableEventListeners(tbody, 'customer');
            updateSummaryKPIs();
        }

        function updateFoodInventoryTable() {
            const tbody = document.getElementById('food-inventory-table-body');
            tbody.innerHTML = '';
            const lowStockThreshold = parseFloat(lowStockThresholdInput.value) || 0;

            foodInventoryData.forEach((item, index) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                if (item.quantity <= lowStockThreshold) {
                    row.classList.add('low-stock-alert');
                }
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.quantity;
                row.insertCell().textContent = item.unit;
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-index="${index}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-index="${index}">Xóa</button>
                `;
            });
            localStorage.setItem('foodInventoryData', JSON.stringify(foodInventoryData));
            attachTableEventListeners(tbody, 'foodInventory');
        }

        function updatePurchaseHistoryTable() { // New function
            const tbody = document.getElementById('purchase-history-table-body');
            tbody.innerHTML = '';
            purchaseHistoryData.forEach((purchase, index) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = purchase.itemName;
                row.insertCell().textContent = purchase.quantity + ' ' + purchase.unit;
                row.insertCell().textContent = formatCurrency(purchase.purchasePrice);
                row.insertCell().textContent = formatCurrency(purchase.totalCost);
                row.insertCell().textContent = formatDate(purchase.date);
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-index="${index}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-index="${index}">Xóa</button>
                `;
            });
            localStorage.setItem('purchaseHistoryData', JSON.stringify(purchaseHistoryData));
            attachTableEventListeners(tbody, 'purchaseHistory');
        }

        function updateOtherExpenseTable() { // Renamed from updateExpenseTable
            const tbody = document.getElementById('other-expense-table-body');
            tbody.innerHTML = '';
            otherExpensesData.forEach((expense, index) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = expense.description;
                row.insertCell().textContent = formatCurrency(expense.amount);
                row.insertCell().textContent = formatDate(expense.date);
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-index="${index}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-index="${index}">Xóa</button>
                `;
            });
            localStorage.setItem('otherExpensesData', JSON.stringify(otherExpensesData));
            attachTableEventListeners(tbody, 'otherExpense');
        }

        function updateSalesTable() {
            const tbody = document.getElementById('sales-table-body');
            tbody.innerHTML = '';
            salesData.forEach((sale, index) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = formatDate(sale.date);
                row.insertCell().textContent = sale.itemName;
                row.insertCell().textContent = sale.quantity;
                row.insertCell().textContent = formatCurrency(sale.price);
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-index="${index}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-index="${index}">Xóa</button>
                `;
            });
            localStorage.setItem('salesData', JSON.stringify(salesData));
            attachTableEventListeners(tbody, 'sale');
        }

        function updateProductItemsTable() {
            const tbody = document.getElementById('product-items-table-body');
            tbody.innerHTML = '';
            productItemsData.forEach((item, index) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.defaultUnit;
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-index="${index}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-index="${index}">Xóa</button>
                `;
            });
            localStorage.setItem('productItemsData', JSON.stringify(productItemsData));
            attachTableEventListeners(tbody, 'productItem');
            updateSummaryKPIs();
        }

        function updateProductDatalist() {
            const datalist = document.getElementById('product-names-list');
            datalist.innerHTML = '';
            productItemsData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                datalist.appendChild(option);
            });
        }

        function updateAllTables() {
            updateCustomerTable();
            updateFoodInventoryTable();
            updatePurchaseHistoryTable(); // New
            updateOtherExpenseTable(); // Updated
            updateSalesTable();
            updateProductItemsTable();
        }

        function updateCharts() {
            if (dailyIncomeChartInstance) dailyIncomeChartInstance.destroy();
            if (profitByFoodChartInstance) profitByFoodChartInstance.destroy();
            if (monthlyFinancialChartInstance) monthlyFinancialChartInstance.destroy();

            drawDailyIncomeChart();
            drawProfitByFoodChart();
            drawMonthlyFinancialChart();
        }

        function wrapLabels(label, index, labels) {
            const MAX_CHAR_PER_LINE = 16;
            if (label && label.length > MAX_CHAR_PER_LINE) {
                const words = label.split(' ');
                let lines = [];
                let currentLine = '';
                words.forEach(word => {
                    if ((currentLine + word).length <= MAX_CHAR_PER_LINE) {
                        currentLine += (currentLine === '' ? '' : ' ') + word;
                    } else {
                        lines.push(currentLine);
                        currentLine = word;
                    }
                });
                lines.push(currentLine);
                return lines;
            }
            return label;
        }

        function drawDailyIncomeChart() {
            const ctx = document.getElementById('dailyIncomeChart').getContext('2d');
            const last7Days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d.toISOString().slice(0, 10);
            });

            const incomeByDay = last7Days.map(date => {
                return salesData.filter(sale => sale.date === date)
                                .reduce((sum, sale) => sum + sale.price, 0);
            });

            dailyIncomeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => formatDate(d)),
                    datasets: [{
                        label: 'Revenue (VND)', // English label
                        data: incomeByDay,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (VND)' // English label
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date' // English label
                            }
                        }
                    }
                }
            });
        }

        function drawProfitByFoodChart() {
            const ctx = document.getElementById('profitByFoodChart').getContext('2d');

            const foodSales = {};
            salesData.forEach(sale => {
                foodSales[sale.itemName] = (foodSales[sale.itemName] || 0) + sale.price;
            });

            const foodPurchaseCosts = {}; // New
            purchaseHistoryData.forEach(purchase => { // New
                foodPurchaseCosts[purchase.itemName] = (foodPurchaseCosts[purchase.itemName] || 0) + purchase.totalCost;
            });

            const foodProfit = {};
            // Iterate over all unique food items from sales and purchases
            const allFoodItems = new Set([...Object.keys(foodSales), ...Object.keys(foodPurchaseCosts)]);
            allFoodItems.forEach(item => {
                const salesRevenue = foodSales[item] || 0;
                const purchaseCost = foodPurchaseCosts[item] || 0;
                foodProfit[item] = salesRevenue - purchaseCost;
            });

            const sortedFoodProfit = Object.entries(foodProfit).sort(([,a],[,b]) => b - a).slice(0, 5);
            const labels = sortedFoodProfit.map(entry => entry[0]);
            const data = sortedFoodProfit.map(entry => entry[1]);

            profitByFoodChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Profit (VND)', // English label
                        data: data,
                        backgroundColor: '#FFC107',
                        borderColor: '#FFB300',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Profit (VND)' // English label
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Food Item' // English label
                            },
                            ticks: {
                                callback: wrapLabels
                            }
                        }
                    }
                }
            });
        }

        function drawMonthlyFinancialChart() {
            const ctx = document.getElementById('monthlyFinancialChart').getContext('2d');

            const monthlyData = {};

            salesData.forEach(sale => {
                const month = sale.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { income: 0, expenses: 0, purchaseCosts: 0 };
                monthlyData[month].income += sale.price;
            });

            otherExpensesData.forEach(expense => { // Updated
                const month = expense.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { income: 0, expenses: 0, purchaseCosts: 0 };
                monthlyData[month].expenses += expense.amount;
            });

            purchaseHistoryData.forEach(purchase => { // New
                const month = purchase.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { income: 0, expenses: 0, purchaseCosts: 0 };
                monthlyData[month].purchaseCosts += purchase.totalCost;
            });


            const sortedMonths = Object.keys(monthlyData).sort();
            const monthlyIncomes = sortedMonths.map(month => monthlyData[month].income);
            const monthlyTotalCosts = sortedMonths.map(month => monthlyData[month].expenses + monthlyData[month].purchaseCosts); // Updated
            const monthlyProfits = sortedMonths.map(month => monthlyData[month].income - monthlyTotalCosts[sortedMonths.indexOf(month)]); // Updated

            monthlyFinancialChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [
                        {
                            label: 'Monthly Revenue (VND)', // English label
                            data: monthlyIncomes,
                            borderColor: '#42A5F5',
                            backgroundColor: 'rgba(66, 165, 245, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Monthly Expenses (VND)', // English label
                            data: monthlyTotalCosts, // Updated
                            borderColor: '#EF5350',
                            backgroundColor: 'rgba(239, 83, 80, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Monthly Profit (VND)', // English label
                            data: monthlyProfits,
                            borderColor: '#66BB6A',
                            backgroundColor: 'rgba(102, 187, 106, 0.2)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (VND)' // English label
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month' // English label
                            }
                        }
                    }
                }
            });
        }

        function initializeApp() {
            const today = new Date().toISOString().slice(0, 10);
            startDateFilter.value = today;
            endDateFilter.value = today;

            showSection('section-tongquan');
            calculateSummaryForDateRange();
            updateAllTables();
            updateProductDatalist();
            updateCharts();
            updateSummaryKPIs();
        }

        // Helper function to convert array of objects to CSV string
        function convertToCsv(arr, headers = null) {
            if (!arr.length) return '';
            const finalHeaders = headers || Object.keys(arr[0]); // Use provided headers or infer
            const headerRow = finalHeaders.map(h => {
                if (typeof h === 'object' && h.label) return `"${h.label.replace(/"/g, '""')}"`;
                return `"${String(h).replace(/"/g, '""')}"`;
            }).join(',');

            const rows = arr.map(row => finalHeaders.map(key => {
                const actualKey = (typeof key === 'object' && key.key) ? key.key : key;
                let value = row[actualKey];

                // Special formatting for dates
                if (['date', 'lastContact', 'nextFollowup'].includes(actualKey)) {
                    value = formatDate(value);
                }
                // Special formatting for expense type
                else if (actualKey === 'type') {
                    value = value === 'mua_thuc_pham' ? 'Food Purchase' : 'Other Variable Expense'; // English value
                }
                // Special formatting for currency or numbers (keep as raw number for CSV, let Excel format)
                else if (['amount', 'price', 'quantity', 'purchasePrice', 'totalCost'].includes(actualKey)) {
                    value = parseFloat(value); // Ensure it's a number
                }

                if (typeof value === 'string' && value.includes(',')) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return String(value); // Convert all values to string for CSV
            }).join(','));
            return [headerRow, ...rows].join('\n');
        }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function attachTableEventListeners(tbody, dataType) {
            tbody.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const index = parseInt(event.target.dataset.index);
                    editItem(dataType, index);
                });
            });

            tbody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const index = parseInt(event.target.dataset.index);
                    deleteItem(dataType, index);
                });
            });

            const table = tbody.closest('table');
            if (table) {
                const headers = table.querySelectorAll('th[data-sort-key]');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const sortKey = header.dataset.sortKey;
                        sortTable(dataType, sortKey);
                    });
                });
            }
        }

        let sortDirections = {};

        function sortTable(dataType, sortKey) {
            let dataArray;
            let updateTableFunc;

            switch (dataType) {
                case 'customer':
                    dataArray = customersData;
                    updateTableFunc = updateCustomerTable;
                    break;
                case 'foodInventory':
                    dataArray = foodInventoryData;
                    updateTableFunc = updateFoodInventoryTable;
                    break;
                case 'otherExpense': // Updated
                    dataArray = otherExpensesData;
                    updateTableFunc = updateOtherExpenseTable;
                    break;
                case 'sale':
                    dataArray = salesData;
                    updateTableFunc = updateSalesTable;
                    break;
                case 'productItem':
                    dataArray = productItemsData;
                    updateTableFunc = updateProductItemsTable;
                    break;
                case 'purchaseHistory': // New
                    dataArray = purchaseHistoryData;
                    updateTableFunc = updatePurchaseHistoryTable;
                    break;
                default:
                    return;
            }

            const currentDirection = sortDirections[`${dataType}-${sortKey}`] === 'asc' ? 'desc' : 'asc';

            dataArray.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                if (sortKey.includes('date') || sortKey.includes('Contact') || sortKey.includes('Followup')) {
                    valA = new Date(valA);
                    valB = new Date(valB);
                } else if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return currentDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentDirection === 'asc' ? 1 : -1;
                return 0;
            });

            sortDirections[`${dataType}-${sortKey}`] = currentDirection;
            updateTableFunc();
        }


        function editItem(dataType, index) {
            let dataArray;
            let formElements;
            let addBtn;

            switch (dataType) {
                case 'customer':
                    dataArray = customersData;
                    formElements = {
                        name: document.getElementById('customer-name'),
                        lastContact: document.getElementById('customer-last-contact'),
                        nextFollowup: document.getElementById('customer-next-followup'),
                        status: document.getElementById('customer-status')
                    };
                    addBtn = document.getElementById('add-customer-btn');
                    editingCustomerIndex = index;
                    break;
                case 'foodInventory':
                    dataArray = foodInventoryData;
                    formElements = {
                        name: document.getElementById('food-item-name'),
                        quantity: document.getElementById('food-item-quantity'),
                        unit: document.getElementById('food-item-unit')
                    };
                    addBtn = document.getElementById('add-food-item-btn');
                    editingFoodInventoryIndex = index;
                    break;
                case 'otherExpense': // Updated
                    dataArray = otherExpensesData;
                    formElements = {
                        description: document.getElementById('other-expense-description'),
                        amount: document.getElementById('other-expense-amount'),
                        date: document.getElementById('other-expense-date')
                    };
                    addBtn = document.getElementById('add-other-expense-btn');
                    editingOtherExpenseIndex = index;
                    break;
                case 'purchaseHistory': // New
                    dataArray = purchaseHistoryData;
                    formElements = {
                        itemName: document.getElementById('purchase-item-name'),
                        quantity: document.getElementById('purchase-quantity'),
                        unit: document.getElementById('purchase-unit'),
                        purchasePrice: document.getElementById('purchase-price-per-unit'),
                        date: document.getElementById('purchase-date')
                    };
                    addBtn = document.getElementById('add-purchase-btn');
                    editingPurchaseHistoryIndex = index;
                    break;
                case 'sale':
                    dataArray = salesData;
                    formElements = {
                        itemName: document.getElementById('sale-item-name'),
                        quantity: document.getElementById('sale-quantity'),
                        price: document.getElementById('sale-price'),
                        date: document.getElementById('sale-date')
                    };
                    addBtn = document.getElementById('add-sale-btn');
                    editingSaleIndex = index;
                    break;
                case 'productItem':
                    dataArray = productItemsData;
                    formElements = {
                        name: document.getElementById('product-item-name'),
                        defaultUnit: document.getElementById('product-item-default-unit')
                    };
                    addBtn = document.getElementById('add-product-item-btn');
                    editingProductItemIndex = index;
                    break;
                default:
                    return;
            }

            const item = dataArray[index];
            if (item) {
                for (const key in formElements) {
                    if (formElements[key]) {
                        formElements[key].value = item[key];
                    }
                }
                addBtn.textContent = 'Cập nhật';
            }
        }

        function deleteItem(dataType, index) {
            if (!confirm('Bạn có chắc chắn muốn xóa mục này?')) return;

            let dataArray;
            let updateTableFunc;
            let calculateSummaryNeeded = false;
            let updateChartsNeeded = false;

            switch (dataType) {
                case 'customer':
                    dataArray = customersData;
                    updateTableFunc = updateCustomerTable;
                    calculateSummaryNeeded = true;
                    break;
                case 'foodInventory':
                    dataArray = foodInventoryData;
                    updateTableFunc = updateFoodInventoryTable;
                    break;
                case 'otherExpense': // Updated
                    dataArray = otherExpensesData;
                    updateTableFunc = updateOtherExpenseTable;
                    calculateSummaryNeeded = true;
                    updateChartsNeeded = true;
                    break;
                case 'purchaseHistory': // New
                    dataArray = purchaseHistoryData;
                    updateTableFunc = updatePurchaseHistoryTable;
                    calculateSummaryNeeded = true; // Affects profit
                    updateChartsNeeded = true; // Affects profit charts
                    break;
                case 'sale':
                    dataArray = salesData;
                    updateTableFunc = updateSalesTable;
                    calculateSummaryNeeded = true;
                    updateChartsNeeded = true;
                    break;
                case 'productItem':
                    dataArray = productItemsData;
                    updateTableFunc = updateProductItemsTable;
                    break;
                default:
                    return;
            }

            if (dataArray && index >= 0 && index < dataArray.length) {
                dataArray.splice(index, 1);
                updateTableFunc();
                calculateSummaryForDateRange();
                if (calculateSummaryNeeded) updateSummaryKPIs();
                if (updateChartsNeeded) updateCharts();
                updateProductDatalist();
                alert('Mục đã được xóa thành công!');
            }
        }

        document.getElementById('add-customer-btn').addEventListener('click', () => {
            const name = document.getElementById('customer-name').value.trim();
            const lastContact = document.getElementById('customer-last-contact').value;
            const nextFollowup = document.getElementById('customer-next-followup').value;
            const status = document.getElementById('customer-status').value;

            if (name && lastContact && nextFollowup) {
                const customer = { name, lastContact, nextFollowup, status };
                if (editingCustomerIndex > -1) {
                    customersData[editingCustomerIndex] = customer;
                    editingCustomerIndex = -1;
                    document.getElementById('add-customer-btn').textContent = 'Thêm khách hàng';
                    alert('Customer info updated successfully!');
                } else {
                    customersData.push(customer);
                    alert('Customer added successfully!');
                }
                updateCustomerTable();
                calculateSummaryForDateRange();
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-last-contact').value = '';
                document.getElementById('customer-next-followup').value = '';
            } else {
                alert('Please fill in all customer information.');
            }
        });

        document.getElementById('add-food-item-btn').addEventListener('click', () => {
            const name = document.getElementById('food-item-name').value.trim();
            const quantity = parseFloat(document.getElementById('food-item-quantity').value);
            const unit = document.getElementById('food-item-unit').value.trim();

            if (name && !isNaN(quantity) && unit) {
                const foodItem = { name, quantity, unit };
                if (editingFoodInventoryIndex > -1) {
                    foodInventoryData[editingFoodInventoryIndex] = foodItem;
                    editingFoodInventoryIndex = -1;
                    document.getElementById('add-food-item-btn').textContent = 'Thêm/Cập nhật tồn kho';
                    alert('Food inventory updated successfully!');
                } else {
                    if (!productItemsData.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                        productItemsData.push({ name: name, defaultUnit: unit });
                        updateProductItemsTable();
                        updateProductDatalist();
                    }
                    foodInventoryData.push(foodItem);
                    alert('Food inventory added successfully!');
                }
                updateFoodInventoryTable();
                document.getElementById('food-item-name').value = '';
                document.getElementById('food-item-quantity').value = '';
                document.getElementById('food-item-unit').value = '';
                updateCharts();
            } else {
                alert('Please fill in all food inventory information.');
            }
        });

        document.getElementById('add-purchase-btn').addEventListener('click', () => { // New event listener
            const itemName = document.getElementById('purchase-item-name').value.trim();
            const quantity = parseFloat(document.getElementById('purchase-quantity').value);
            const unit = document.getElementById('purchase-unit').value.trim();
            const purchasePrice = parseFloat(document.getElementById('purchase-price-per-unit').value);
            const date = document.getElementById('purchase-date').value;

            if (itemName && !isNaN(quantity) && unit && !isNaN(purchasePrice) && date) {
                const totalCost = quantity * purchasePrice;
                const purchase = { itemName, quantity, unit, purchasePrice, date, totalCost };

                if (editingPurchaseHistoryIndex > -1) {
                    purchaseHistoryData[editingPurchaseHistoryIndex] = purchase;
                    editingPurchaseHistoryIndex = -1;
                    document.getElementById('add-purchase-btn').textContent = 'Thêm Giao dịch Mua';
                    alert('Purchase transaction updated successfully!');
                } else {
                    if (!productItemsData.some(item => item.name.toLowerCase() === itemName.toLowerCase())) {
                        productItemsData.push({ name: itemName, defaultUnit: unit });
                        updateProductItemsTable();
                        updateProductDatalist();
                    }
                    purchaseHistoryData.push(purchase);
                    // Also update food inventory (simple add for now)
                    const existingFoodItemIndex = foodInventoryData.findIndex(item => item.name.toLowerCase() === itemName.toLowerCase());
                    if (existingFoodItemIndex > -1) {
                        foodInventoryData[existingFoodItemIndex].quantity += quantity;
                    } else {
                        foodInventoryData.push({ name: itemName, quantity: quantity, unit: unit });
                    }
                    updateFoodInventoryTable();
                    alert('Purchase transaction added successfully!');
                }
                updatePurchaseHistoryTable();
                calculateSummaryForDateRange();
                updateCharts();
                document.getElementById('purchase-item-name').value = '';
                document.getElementById('purchase-quantity').value = '';
                document.getElementById('purchase-unit').value = '';
                document.getElementById('purchase-price-per-unit').value = '';
                document.getElementById('purchase-date').value = '';
            } else {
                alert('Please fill in all purchase transaction information.');
            }
        });


        document.getElementById('add-other-expense-btn').addEventListener('click', () => { // Updated
            const description = document.getElementById('other-expense-description').value.trim();
            const amount = parseFloat(document.getElementById('other-expense-amount').value);
            const date = document.getElementById('other-expense-date').value;

            if (description && !isNaN(amount) && date) {
                const expense = { description, amount, date };
                if (editingOtherExpenseIndex > -1) {
                    otherExpensesData[editingOtherExpenseIndex] = expense;
                    editingOtherExpenseIndex = -1;
                    document.getElementById('add-other-expense-btn').textContent = 'Thêm Biến phí';
                    alert('Other expense updated successfully!');
                } else {
                    otherExpensesData.push(expense);
                    alert('Other expense added successfully!');
                }
                updateOtherExpenseTable();
                calculateSummaryForDateRange();
                updateCharts();
                document.getElementById('other-expense-description').value = '';
                document.getElementById('other-expense-amount').value = '';
                document.getElementById('other-expense-date').value = '';
            } else {
                alert('Please fill in all other expense information.');
            }
        });

        document.getElementById('add-sale-btn').addEventListener('click', () => {
            const itemName = document.getElementById('sale-item-name').value.trim();
            const quantity = parseFloat(document.getElementById('sale-quantity').value);
            const price = parseFloat(document.getElementById('sale-price').value);
            const date = document.getElementById('sale-date').value;

            if (itemName && !isNaN(quantity) && !isNaN(price) && date) {
                const sale = { itemName, quantity, price, date };
                if (editingSaleIndex > -1) {
                    salesData[editingSaleIndex] = sale;
                    editingSaleIndex = -1;
                    document.getElementById('add-sale-btn').textContent = 'Thêm giao dịch';
                    alert('Sales transaction updated successfully!');
                } else {
                    if (!productItemsData.some(item => item.name.toLowerCase() === itemName.toLowerCase())) {
                        productItemsData.push({ name: itemName, defaultUnit: '' });
                        updateProductItemsTable();
                        updateProductDatalist();
                    }
                    salesData.push(sale);
                    alert('Sales transaction added successfully!');
                }
                updateSalesTable();
                calculateSummaryForDateRange();
                updateCharts();
                document.getElementById('sale-item-name').value = '';
                document.getElementById('sale-quantity').value = '';
                document.getElementById('sale-price').value = '';
                document.getElementById('sale-date').value = '';
            } else {
                alert('Please fill in all sales transaction information.');
            }
        });

        document.getElementById('add-product-item-btn').addEventListener('click', () => {
            const name = document.getElementById('product-item-name').value.trim();
            const defaultUnit = document.getElementById('product-item-default-unit').value.trim();

            if (name) {
                const productItem = { name, defaultUnit };
                if (editingProductItemIndex > -1) {
                    productItemsData[editingProductItemIndex] = productItem;
                    editingProductItemIndex = -1;
                    document.getElementById('add-product-item-btn').textContent = 'Thêm Mặt hàng';
                    alert('Product item updated successfully!');
                } else {
                    if (productItemsData.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                        alert('This product item already exists!');
                        return;
                    }
                    productItemsData.push(productItem);
                    alert('Product item added successfully!');
                }
                updateProductItemsTable();
                updateProductDatalist();
                document.getElementById('product-item-name').value = '';
                document.getElementById('product-item-default-unit').value = '';
                updateCharts();
            } else {
                alert('Please fill in the product item name.');
            }
        });

        document.getElementById('export-all-data-json-btn').addEventListener('click', () => {
            const allData = {
                salesData: salesData,
                otherExpensesData: otherExpensesData, // Updated
                customersData: customersData,
                foodInventoryData: foodInventoryData,
                productItemsData: productItemsData,
                purchaseHistoryData: purchaseHistoryData // New
            };
            const jsonString = JSON.stringify(allData, null, 2);
            downloadFile(jsonString, 'business_data.json', 'application/json');
        });

        document.getElementById('import-data-btn').addEventListener('click', () => {
            document.getElementById('import-data-file').click();
        });

        document.getElementById('import-data-file').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.salesData) salesData = importedData.salesData;
                    if (importedData.otherExpensesData) otherExpensesData = importedData.otherExpensesData; // Updated
                    if (importedData.customersData) customersData = importedData.customersData;
                    if (importedData.foodInventoryData) foodInventoryData = importedData.foodInventoryData;
                    if (importedData.productItemsData) productItemsData = importedData.productItemsData;
                    if (importedData.purchaseHistoryData) purchaseHistoryData = importedData.purchaseHistoryData; // New

                    localStorage.setItem('salesData', JSON.stringify(salesData));
                    localStorage.setItem('otherExpensesData', JSON.stringify(otherExpensesData)); // Updated
                    localStorage.setItem('customersData', JSON.stringify(customersData));
                    localStorage.setItem('foodInventoryData', JSON.stringify(foodInventoryData));
                    localStorage.setItem('productItemsData', JSON.stringify(productItemsData));
                    localStorage.setItem('purchaseHistoryData', JSON.stringify(purchaseHistoryData)); // New

                    initializeApp();
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error reading JSON file. Please check file format.');
                    console.error('Error importing data:', error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        document.getElementById('export-summary-csv-btn').addEventListener('click', () => { // New export button for summary
            const start = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const end = endDateFilter.value ? new Date(endDateFilter.value) : null;

            let filteredSales = salesData;
            let filteredOtherExpenses = otherExpensesData;
            let filteredPurchases = purchaseHistoryData;
            let filteredCustomers = customersData;

            if (start && end) {
                filteredSales = salesData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= start && saleDate <= end;
                });
                filteredOtherExpenses = otherExpensesData.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });
                filteredPurchases = purchaseHistoryData.filter(purchase => {
                    const purchaseDate = new Date(purchase.date);
                    return purchaseDate >= start && purchaseDate <= end;
                });
                filteredCustomers = customersData.filter(customer => {
                    const lastContactDate = new Date(customer.lastContact);
                    return lastContactDate >= start && lastContactDate <= end;
                });
            } else if (start && !end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) >= start);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) >= start);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) >= start);
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) >= start);
            } else if (!start && end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) <= end);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) <= end);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) <= end);
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) <= end);
            }

            const totalIncome = filteredSales.reduce((sum, sale) => sum + sale.price, 0);
            const totalOtherExpense = filteredOtherExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalPurchaseCost = filteredPurchases.reduce((sum, purchase) => sum + purchase.totalCost, 0);
            const estimatedProfit = totalIncome - totalOtherExpense - totalPurchaseCost;
            const uniqueCustomers = new Set(filteredCustomers.map(c => c.name)).size;

            const summaryData = [
                {
                    'Metric': 'Total Revenue',
                    'Value': totalIncome
                },
                {
                    'Metric': 'Customers Interacted',
                    'Value': uniqueCustomers
                },
                {
                    'Metric': 'Estimated Profit',
                    'Value': estimatedProfit
                },
                {
                    'Metric': 'Total Customers (Overall)',
                    'Value': customersData.length
                },
                {
                    'Metric': 'Total Product Items (Overall)',
                    'Value': productItemsData.length
                }
            ];

            if (start && end) {
                summaryData.unshift({ 'Metric': 'Date Range', 'Value': `${formatDate(start.toISOString().slice(0,10))} - ${formatDate(end.toISOString().slice(0,10))}` });
            } else if (start) {
                summaryData.unshift({ 'Metric': 'Date Range', 'Value': `From ${formatDate(start.toISOString().slice(0,10))}` });
            } else if (end) {
                summaryData.unshift({ 'Metric': 'Date Range', 'Value': `Up to ${formatDate(end.toISOString().slice(0,10))}` });
            }

            const headers = [
                { key: 'Metric', label: 'Metric' },
                { key: 'Value', label: 'Value' }
            ];
            const csv = convertToCsv(summaryData, headers);
            downloadFile(csv, 'overall_summary.csv', 'text/csv;charset=utf-8;');
        });


        document.getElementById('export-customers-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Customer Name' },
                { key: 'lastContact', label: 'Last Contact Date' },
                { key: 'nextFollowup', label: 'Next Followup Date' },
                { key: 'status', label: 'Status' }
            ];
            const csv = convertToCsv(customersData, headers);
            downloadFile(csv, 'customers.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-food-inventory-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Food Item Name' },
                { key: 'quantity', label: 'Quantity' },
                { key: 'unit', label: 'Unit' }
            ];
            const csv = convertToCsv(foodInventoryData, headers);
            downloadFile(csv, 'food_inventory.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-purchase-history-csv-btn').addEventListener('click', () => { // New CSV export
            const headers = [
                { key: 'itemName', label: 'Item Name' },
                { key: 'quantity', label: 'Quantity' },
                { key: 'unit', label: 'Unit' },
                { key: 'purchasePrice', label: 'Unit Purchase Price' },
                { key: 'totalCost', label: 'Total Cost' },
                { key: 'date', label: 'Date' }
            ];
            const csv = convertToCsv(purchaseHistoryData, headers);
            downloadFile(csv, 'purchase_history.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-other-expenses-csv-btn').addEventListener('click', () => { // Updated
            const headers = [
                { key: 'description', label: 'Description' },
                { key: 'amount', label: 'Amount (VND)' },
                { key: 'date', label: 'Date' }
            ];
            const csv = convertToCsv(otherExpensesData, headers);
            downloadFile(csv, 'other_expenses.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-sales-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'date', label: 'Date' },
                { key: 'itemName', label: 'Product/Service Name' },
                { key: 'quantity', label: 'Quantity' },
                { key: 'price', label: 'Revenue (VND)' }
            ];
            const csv = convertToCsv(salesData, headers);
            downloadFile(csv, 'sales.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-product-items-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Item Name' },
                { key: 'defaultUnit', label: 'Default Unit' }
            ];
            const csv = convertToCsv(productItemsData, headers);
            downloadFile(csv, 'product_items.csv', 'text/csv;charset=utf-8;');
        });


        // Event Listeners for Navigation
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const sectionId = `section-${item.id.replace('nav-', '')}`;
                showSection(sectionId);
            });
        });

        // Event listeners for date filters and low stock threshold
        startDateFilter.addEventListener('change', calculateSummaryForDateRange);
        endDateFilter.addEventListener('change', calculateSummaryForDateRange);
        lowStockThresholdInput.addEventListener('change', updateFoodInventoryTable);

        initializeApp();
    </script>
</body>
</html>