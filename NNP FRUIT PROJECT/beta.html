<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NNP FRUIT ANALYSIS</title>
    <link rel="icon" type="image/x-icon" href="NNP.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F8F7F4;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .nav-item.active {
            background-color: #4CAF50;
            color: white;
        }
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid #e0e0e0;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        .low-stock-alert {
            background-color: #ffe0b2; /* Light orange */
            color: #e65100; /* Darker orange */
            font-weight: 500;
        }
        .expiry-warning {
            background-color: #ffccbc; /* Light red-orange */
            color: #d84315; /* Darker red-orange */
            font-weight: 500;
        }
        .kpi-not-met {
            background-color: #ffcdd2; /* Light red */
            color: #c62828; /* Darker red */
            font-weight: 500;
        }
        .kpi-met {
            background-color: #c8e6c9; /* Light green */
            color: #2e7d32; /* Darker green */
            font-weight: 500;
        }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen">
    <!-- Thanh Điều Hướng Bên Trái -->
    <nav class="w-full md:w-64 bg-white p-6 shadow-lg rounded-xl m-4 flex-shrink-0">
        <div class="text-xl font-bold text-gray-800 mb-6">Quản lý Kinh doanh</div>
        <ul class="space-y-2">
            <li>
                <button id="nav-tongquan" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700 active">
                    Tổng quan
                </button>
            </li>
            <li>
                <button id="nav-khachhang" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Khách hàng
                </button>
            </li>
            <li>
                <button id="nav-thucphamkho" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Thực phẩm & Kho
                </button>
            </li>
            <li>
                <button id="nav-taichinh" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Tài chính
                </button>
            </li>
            <li>
                <button id="nav-quanlymathang" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Quản lý Mặt hàng
                </button>
            </li>
            <li>
                <button id="nav-quanlykhuyenmai" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Quản lý Khuyến mãi
                </button>
            </li>
            <li>
                <button id="nav-quanlydulieu" class="nav-item w-full text-left p-3 rounded-lg hover:bg-gray-100 transition duration-200 ease-in-out font-medium text-gray-700">
                    Quản lý Dữ liệu
                </button>
            </li>
        </ul>
    </nav>

    <!-- Khu Vực Nội Dung Chính -->
    <main class="flex-grow p-4 md:p-8">
        <!-- Tổng quan Section -->
        <section id="section-tongquan" class="content-section active bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Tổng quan</h2>
            <p class="text-gray-600 mb-6">Phần này cung cấp một cái nhìn tổng thể về hiệu suất kinh doanh của bạn, bao gồm các chỉ số chính và xu hướng quan trọng. Bạn có thể chọn khoảng thời gian để xem các chỉ số.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="start-date-filter" class="block text-sm font-medium text-gray-700">Từ ngày</label>
                    <input type="date" id="start-date-filter" class="mt-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                </div>
                <div>
                    <label for="end-date-filter" class="block text-sm font-medium text-gray-700">Đến ngày</label>
                    <input type="date" id="end-date-filter" class="mt-1 p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Tổng thu nhập</div>
                    <div id="total-income-range" class="text-3xl font-bold text-blue-600">0 VNĐ</div>
                </div>
                <div class="bg-green-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Khách hàng tương tác</div>
                    <div id="customers-in-range" class="text-3xl font-bold text-green-600">0</div>
                </div>
                <div class="bg-red-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Lợi nhuận ước tính</div>
                    <div id="profit-in-range" class="text-3xl font-bold text-red-600">0 VNĐ</div>
                </div>
                 <div class="bg-purple-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Tổng số khách hàng</div>
                    <div id="total-customers-kpi" class="text-3xl font-bold text-purple-600">0</div>
                </div>
                <div class="bg-yellow-50 p-6 rounded-lg shadow-md flex flex-col items-center">
                    <div class="text-sm font-medium text-gray-500 mb-2">Tổng số mặt hàng</div>
                    <div id="total-products-kpi" class="text-3xl font-bold text-yellow-600">0</div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Xu hướng Thu nhập (7 ngày qua)</h3>
                    <div class="chart-container">
                        <canvas id="dailyIncomeChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Lợi nhuận theo Thực phẩm (Top 5)</h3>
                    <div class="chart-container">
                        <canvas id="profitByFoodChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Hiệu suất KPI hàng ngày</h3>
                <div class="mb-4">
                    <label for="kpi-target-percentage" class="block text-sm font-medium text-gray-700 mb-1">Ngưỡng đạt chỉ tiêu KPI (%):</label>
                    <input type="number" id="kpi-target-percentage" value="80" min="0" max="100" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 w-full md:w-1/2">
                </div>
                <div class="overflow-x-auto rounded-lg shadow-md">
                    <table class="min-w-full bg-white rounded-lg overflow-hidden">
                        <thead>
                            <tr>
                                <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg">Mặt hàng</th>
                                <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider">Mục tiêu hàng ngày</th>
                                <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider">Thực bán hôm nay</th>
                                <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider">KPI (%)</th>
                                <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Trạng thái</th>
                            </tr>
                        </thead>
                        <tbody id="daily-kpi-table-body">
                            <!-- Daily KPI data will be inserted here -->
                        </tbody>
                    </table>
                </div>
                <button id="update-kpi-targets-btn" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 ease-in-out w-full">Cập nhật chỉ tiêu KPI cho ngày tiếp theo</button>
            </div>
        </section>

        <!-- Khách hàng Section -->
        <section id="section-khachhang" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Khách hàng</h2>
            <p class="text-gray-600 mb-6">Theo dõi thông tin và lịch sử tương tác với khách hàng của bạn để đảm bảo việc theo dõi hiệu quả.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm khách hàng mới / Lịch theo dõi</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="customer-name" placeholder="Tên khách hàng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="customer-phone" placeholder="Số điện thoại" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="date" id="customer-last-contact" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="date" id="customer-next-followup" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <select id="customer-status" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="Đang theo dõi">Đang theo dõi</option>
                        <option value="Đã liên hệ">Đã liên hệ</option>
                        <option value="Đã hoàn thành">Đã hoàn thành</option>
                        <option value="Tạm dừng">Tạm dừng</option>
                    </select>
                </div>
                <button id="add-customer-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm khách hàng</button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">Tên Khách hàng &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="phoneNumber">Số điện thoại &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="lastContact">Ngày tương tác cuối &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="nextFollowup">Ngày theo dõi tiếp &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="status">Trạng thái &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="purchaseCount">Lượt mua &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="loyaltyPoints">Điểm tích lũy &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="customer-table-body">
                        <!-- Customer data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-customers-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Khách hàng</button>
            </div>
        </section>

        <!-- Thực phẩm & Kho Section -->
        <section id="section-thucphamkho" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Thực phẩm & Kho</h2>
            <p class="text-gray-600 mb-6">Giám sát tồn kho thực phẩm, theo dõi chi phí mua hàng và quản lý các biến phí liên quan đến vận hành.</p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- Tồn kho thực phẩm -->
                <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                    <h3 class="text-lg font-semibold text-gray-700 mb-3">Tồn kho thực phẩm</h3>
                    <div class="mb-4">
                        <label for="low-stock-threshold" class="block text-sm font-medium text-gray-700 mb-1">Ngưỡng tồn kho thấp:</label>
                        <input type="number" id="low-stock-threshold" value="10" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 w-full">
                    </div>
                     <div class="mb-4">
                        <label for="min-days-before-expiry-warning" class="block text-sm font-medium text-gray-700 mb-1">Cảnh báo hết hạn (Ngày):</label>
                        <input type="number" id="min-days-before-expiry-warning" value="14" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-orange-500 w-full">
                    </div>
                    <div class="grid grid-cols-1 gap-4 mb-4">
                        <input type="text" id="food-item-name" list="product-names-list" placeholder="Tên thực phẩm" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <datalist id="product-names-list"></datalist>
                        <div class="flex gap-2">
                            <input type="number" id="food-item-quantity" placeholder="Số lượng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                            <input type="text" id="food-item-unit" placeholder="Đơn vị (kg, lít, cái...)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 w-full">
                        </div>
                    </div>
                    <button id="add-food-item-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm/Cập nhật tồn kho</button>
                    <div class="overflow-x-auto mt-4 rounded-lg shadow-md">
                        <table class="min-w-full bg-white rounded-lg overflow-hidden">
                            <thead>
                                <tr>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">Tên Thực phẩm &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="quantity">Số lượng &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="unit">Đơn vị &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="expiryDate">Ngày hết hạn &#x25B2;&#x25BC;</th>
                                    <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                                </tr>
                            </thead>
                            <tbody id="food-inventory-table-body">
                                <!-- Food inventory data will be inserted here -->
                            </tbody>
                        </table>
                        <button id="export-food-inventory-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Tồn kho</button>
                    </div>
                </div>

                <!-- Mua hàng & Biến phí -->
                <div class="grid grid-cols-1 gap-6">
                    <!-- Thêm Giao dịch Mua hàng -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm Giao dịch Mua hàng</h3>
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <input type="text" id="purchase-item-name" list="product-names-list" placeholder="Tên mặt hàng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="purchase-quantity" placeholder="Số lượng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="text" id="purchase-unit" placeholder="Đơn vị (kg, lít, cái...)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="purchase-price-per-unit" placeholder="Giá mua mỗi đơn vị (VNĐ)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="date" id="purchase-date" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <button id="add-purchase-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm Giao dịch Mua</button>
                        <div class="overflow-x-auto mt-4 rounded-lg shadow-md">
                            <h3 class="text-md font-semibold text-gray-800 mb-2 p-2">Lịch sử Mua hàng</h3>
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead>
                                    <tr>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="itemName">Mặt hàng &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="quantity">SL &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="purchasePrice">Giá/Đơn vị &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="totalCost">Tổng chi phí &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="date">Ngày &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="purchase-history-table-body">
                                    <!-- Purchase history data will be inserted here -->
                                </tbody>
                            </table>
                            <button id="export-purchase-history-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Lịch sử Mua hàng</button>
                        </div>
                    </div>

                    <!-- Biến phí khác -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm">
                        <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm Biến phí khác</h3>
                        <div class="grid grid-cols-1 gap-4 mb-4">
                            <input type="text" id="other-expense-description" placeholder="Mô tả (ví dụ: Tiền điện, Tiếp thị)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="number" id="other-expense-amount" placeholder="Số tiền (VNĐ)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                            <input type="date" id="other-expense-date" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        </div>
                        <button id="add-other-expense-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm Biến phí</button>
                        <div class="overflow-x-auto mt-4 rounded-lg shadow-md">
                             <h3 class="text-md font-semibold text-gray-800 mb-2 p-2">Lịch sử Biến phí khác</h3>
                            <table class="min-w-full bg-white rounded-lg overflow-hidden">
                                <thead>
                                    <tr>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="description">Mô tả &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="amount">Số tiền (VNĐ) &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="date">Ngày &#x25B2;&#x25BC;</th>
                                        <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody id="other-expense-table-body">
                                    <!-- Other expense data will be inserted here -->
                                </tbody>
                            </table>
                             <button id="export-other-expenses-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Biến phí khác</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tài chính Section -->
        <section id="section-taichinh" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Tài chính</h2>
            <p class="text-gray-600 mb-6">Phân tích chi tiết doanh thu, chi phí và lợi nhuận của bạn để đưa ra các quyết định tài chính sáng suốt.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm giao dịch bán hàng</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <input type="text" id="sale-item-name" list="product-names-list" placeholder="Tên sản phẩm/dịch vụ" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="sale-quantity" placeholder="Số lượng bán" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="sale-price" placeholder="Doanh thu (VNĐ)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                     <input type="text" id="sale-customer-phone" placeholder="SĐT khách hàng (để giảm giá)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                     <span id="discount-applied-text" class="p-2 text-sm text-blue-700 bg-blue-100 rounded-md flex items-center justify-center">Chưa áp dụng giảm giá</span>
                </div>
                <input type="date" id="sale-date" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500 mb-4">
                <button id="add-sale-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm giao dịch</button>
            </div>

            <div class="overflow-x-auto mb-6 rounded-lg shadow-md">
                <h3 class="text-lg font-semibold text-gray-800 mb-2 p-2">Doanh thu chi tiết</h3>
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="date">Ngày &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="itemName">Sản phẩm/Dịch vụ &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="quantity">Số lượng &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="originalPrice">Giá gốc (VNĐ) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="price">Giá bán (VNĐ) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="discountApplied">Giảm giá (%) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body">
                        <!-- Sales data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-sales-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Doanh thu</button>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
                <div class="bg-white p-4 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Xu hướng Doanh thu & Lợi nhuận hàng tháng</h3>
                    <div class="chart-container">
                        <canvas id="monthlyFinancialChart"></canvas>
                    </div>
                </div>
            </div>
        </section>

        <!-- Quản lý Mặt hàng Section -->
        <section id="section-quanlymathang" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Mặt hàng</h2>
            <p class="text-gray-600 mb-6">Định nghĩa và quản lý danh sách các mặt hàng/sản phẩm có sẵn trong cửa hàng của bạn. Danh sách này sẽ được sử dụng để nhập liệu trong các phần khác.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm Mặt hàng mới</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="product-item-name" placeholder="Tên mặt hàng" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="product-item-default-unit" placeholder="Đơn vị mặc định (ví dụ: kg, lít, cái)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="product-item-default-selling-price" placeholder="Giá bán mặc định (VNĐ)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="product-item-shelf-life-days" placeholder="Thời gian bảo quản (Ngày)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="number" id="product-item-daily-target-quantity" placeholder="SL mục tiêu hàng ngày" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <input type="text" id="product-item-daily-target-unit" placeholder="Đơn vị mục tiêu (kg, lít...)" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                </div>
                <button id="add-product-item-btn" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition duration-200 ease-in-out w-full">Thêm Mặt hàng</button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">Tên Mặt hàng &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="defaultUnit">Đơn vị mặc định &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="defaultSellingPrice">Giá bán mặc định &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="shelfLifeDays">Thời gian bảo quản (Ngày) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="dailyTargetQuantity">SL mục tiêu hàng ngày &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="dailyTargetUnit">Đơn vị mục tiêu &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="product-items-table-body">
                        <!-- Product items data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-product-items-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Mặt hàng</button>
            </div>
        </section>

        <!-- Quản lý Khuyến mãi Section -->
        <section id="section-quanlykhuyenmai" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Khuyến mãi</h2>
            <p class="text-gray-600 mb-6">Tạo và quản lý các chương trình khuyến mãi, giảm giá cho khách hàng thân thiết.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Thêm Khuyến mãi mới</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <input type="text" id="promo-name" placeholder="Tên khuyến mãi" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="number" id="promo-discount-percentage" placeholder="Giảm giá (%)" min="0" max="100" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="date" id="promo-start-date" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="date" id="promo-end-date" class="p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <button id="add-promo-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 ease-in-out w-full">Thêm Khuyến mãi</button>
            </div>

            <div class="overflow-x-auto rounded-lg shadow-md">
                <table class="min-w-full bg-white rounded-lg overflow-hidden">
                    <thead>
                        <tr>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tl-lg cursor-pointer" data-sort-key="name">Tên Khuyến mãi &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="discountPercentage">Giảm giá (%) &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="startDate">Ngày bắt đầu &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider cursor-pointer" data-sort-key="endDate">Ngày kết thúc &#x25B2;&#x25BC;</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider rounded-tr-lg">Trạng thái</th>
                            <th class="py-3 px-4 bg-gray-200 text-gray-700 font-semibold text-sm uppercase tracking-wider">Hành động</th>
                        </tr>
                    </thead>
                    <tbody id="promotions-table-body">
                        <!-- Promotions data will be inserted here -->
                    </tbody>
                </table>
                <button id="export-promotions-csv-btn" class="mt-4 bg-gray-700 text-white px-4 py-2 rounded-lg hover:bg-gray-800 transition duration-200 ease-in-out w-full">Xuất CSV Khuyến mãi</button>
            </div>
        </section>

        <!-- Quản lý Dữ liệu Section -->
        <section id="section-quanlydulieu" class="content-section hidden bg-white p-6 shadow-lg rounded-xl mb-6">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Quản lý Dữ liệu</h2>
            <p class="text-gray-600 mb-6">Sử dụng các công cụ dưới đây để sao lưu hoặc khôi phục dữ liệu kinh doanh của bạn. Dữ liệu được lưu trữ dưới định dạng JSON.</p>

            <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-sm">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">Xuất / Nhập Toàn Bộ Dữ liệu</h3>
                <button id="export-all-data-json-btn" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition duration-200 ease-in-out w-full mb-4">
                    Xuất Tất Cả Dữ liệu (JSON)
                </button>
                 <button id="export-summary-csv-btn" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition duration-200 ease-in-out w-full mb-4">
                    Export Overall Summary (CSV)
                </button>
                <input type="file" id="import-data-file" accept=".json" class="hidden">
                <button id="import-data-btn" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition duration-200 ease-in-out w-full">
                    Nhập Dữ liệu Từ File (JSON)
                </button>
            </div>
        </section>
    </main>

    <script>
        const navItems = document.querySelectorAll('.nav-item');
        const contentSections = document.querySelectorAll('.content-section');

        const totalIncomeRangeElement = document.getElementById('total-income-range');
        const customersInRangeElement = document.getElementById('customers-in-range');
        const profitInRangeElement = document.getElementById('profit-in-range');
        const totalCustomersKPIElement = document.getElementById('total-customers-kpi');
        const totalProductsKPIElement = document.getElementById('total-products-kpi');

        const startDateFilter = document.getElementById('start-date-filter');
        const endDateFilter = document.getElementById('end-date-filter');
        const lowStockThresholdInput = document.getElementById('low-stock-threshold');
        const minDaysBeforeExpiryWarningInput = document.getElementById('min-days-before-expiry-warning');
        const kpiTargetPercentageInput = document.getElementById('kpi-target-percentage');

        let salesData = JSON.parse(localStorage.getItem('salesData')) || [];
        let otherExpensesData = JSON.parse(localStorage.getItem('otherExpensesData')) || [];
        let customersData = JSON.parse(localStorage.getItem('customersData')) || [];
        let foodInventoryData = JSON.parse(localStorage.getItem('foodInventoryData')) || [];
        let productItemsData = JSON.parse(localStorage.getItem('productItemsData')) || [];
        let purchaseHistoryData = JSON.parse(localStorage.getItem('purchaseHistoryData')) || [];
        let promotionsData = JSON.parse(localStorage.getItem('promotionsData')) || [];

        let dailyIncomeChartInstance;
        let profitByFoodChartInstance;
        let monthlyFinancialChartInstance;

        let editingCustomerUUID = null;
        let editingFoodInventoryUUID = null;
        let editingOtherExpenseUUID = null;
        let editingSaleUUID = null;
        let editingProductItemUUID = null;
        let editingPurchaseHistoryUUID = null;
        let editingPromoUUID = null;

        const MIN_LOYALTY_PURCHASES = 3;
        const LOYALTY_POINTS_PER_PURCHASE = 1;


        function showSection(sectionId) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            document.getElementById(sectionId).classList.add('active');

            navItems.forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById(`nav-${sectionId.replace('section-', '')}`).classList.add('active');

            updateAllTables();
            updateProductDatalist();
            updateCharts();
            updateSummaryKPIs();
            if (sectionId === 'section-tongquan') {
                const today = new Date().toISOString().slice(0, 10);
                if (!startDateFilter.value) startDateFilter.value = today;
                if (!endDateFilter.value) endDateFilter.value = today;
                calculateSummaryForDateRange();
                updateDailyKpiTable();
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${day}/${month}/${year}`;
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'VND' }).format(amount);
        }

        function calculateSummaryForDateRange() {
            const start = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const end = endDateFilter.value ? new Date(endDateFilter.value) : null;

            let filteredSales = salesData;
            let filteredOtherExpenses = otherExpensesData;
            let filteredPurchases = purchaseHistoryData;
            let filteredCustomers = customersData;

            if (start && end) {
                filteredSales = salesData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= start && saleDate <= end;
                });
                filteredOtherExpenses = otherExpensesData.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });
                filteredPurchases = purchaseHistoryData.filter(purchase => {
                    const purchaseDate = new Date(purchase.date);
                    return purchaseDate >= start && purchaseDate <= end;
                });
                filteredCustomers = customersData.filter(customer => {
                    const lastContactDate = new Date(customer.lastContact);
                    return lastContactDate >= start && lastContactDate <= end;
                });
            } else if (start && !end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) >= start);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) >= start);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) >= start);
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) >= start);
            } else if (!start && end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) <= end);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) <= end);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) <= end);
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) <= end);
            }


            const totalIncome = filteredSales.reduce((sum, sale) => sum + sale.price, 0);
            const totalOtherExpense = filteredOtherExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalPurchaseCost = filteredPurchases.reduce((sum, purchase) => sum + purchase.totalCost, 0);
            const estimatedProfit = totalIncome - totalOtherExpense - totalPurchaseCost;

            const uniqueCustomers = new Set(filteredCustomers.map(c => c.name)).size;

            totalIncomeRangeElement.textContent = formatCurrency(totalIncome);
            customersInRangeElement.textContent = uniqueCustomers;
            profitInRangeElement.textContent = formatCurrency(estimatedProfit);
        }

        function updateSummaryKPIs() {
            totalCustomersKPIElement.textContent = customersData.length;
            totalProductsKPIElement.textContent = productItemsData.length;
        }

        function updateCustomerTable() {
            const tbody = document.getElementById('customer-table-body');
            tbody.innerHTML = '';
            customersData.forEach((customer) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = customer.name;
                row.insertCell().textContent = customer.phoneNumber || 'N/A';
                row.insertCell().textContent = formatDate(customer.lastContact);
                row.insertCell().textContent = formatDate(customer.nextFollowup);
                row.insertCell().textContent = customer.status;
                row.insertCell().textContent = customer.purchaseCount || 0;
                row.insertCell().textContent = customer.loyaltyPoints || 0;
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${customer.uuid}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${customer.uuid}">Xóa</button>
                `;
            });
            localStorage.setItem('customersData', JSON.stringify(customersData));
            attachTableEventListeners(tbody, 'customer');
            updateSummaryKPIs();
        }

        function updateFoodInventoryTable() {
            const tbody = document.getElementById('food-inventory-table-body');
            tbody.innerHTML = '';
            const lowStockThreshold = parseFloat(lowStockThresholdInput.value) || 0;
            const minDaysBeforeExpiryWarning = parseFloat(minDaysBeforeExpiryWarningInput.value) || 0;
            const today = new Date();
            today.setHours(0,0,0,0);

            foodInventoryData.forEach((item) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                let hasWarning = false;

                // Check for low stock based on threshold
                if (item.quantity <= lowStockThreshold) {
                    row.classList.add('low-stock-alert');
                    hasWarning = true;
                }

                // Check for low stock based on 7-day KPI target
                const productItem = productItemsData.find(p => p.name.toLowerCase() === item.name.toLowerCase());
                if (productItem && productItem.dailyTargetQuantity) {
                    const requiredFor7Days = productItem.dailyTargetQuantity * 7;
                    if (item.quantity < requiredFor7Days) {
                         if (!hasWarning) row.classList.add('low-stock-alert'); // Don't overwrite if already low
                         hasWarning = true;
                    }
                }


                // Check for expiry date
                let daysUntilExpiry = 'N/A';
                if (item.expiryDate) {
                    const expiryDate = new Date(item.expiryDate);
                    expiryDate.setHours(0,0,0,0);
                    const diffTime = expiryDate - today;
                    daysUntilExpiry = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (daysUntilExpiry <= minDaysBeforeExpiryWarning) {
                        row.classList.add('expiry-warning');
                        hasWarning = true;
                    }
                }

                row.insertCell().textContent = item.name;
                row.insertCell().textContent = `${item.quantity} ${item.unit}`;
                row.insertCell().textContent = item.unit; // Display unit in a separate column
                row.insertCell().textContent = item.expiryDate ? formatDate(item.expiryDate) + (daysUntilExpiry !== 'N/A' ? ` (${daysUntilExpiry} days left)` : '') : 'N/A';
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${item.uuid}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${item.uuid}">Xóa</button>
                `;
            });
            localStorage.setItem('foodInventoryData', JSON.stringify(foodInventoryData));
            attachTableEventListeners(tbody, 'foodInventory');
        }

        function updatePurchaseHistoryTable() {
            const tbody = document.getElementById('purchase-history-table-body');
            tbody.innerHTML = '';
            purchaseHistoryData.forEach((purchase) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = purchase.itemName;
                row.insertCell().textContent = `${purchase.quantity} ${purchase.unit}`;
                row.insertCell().textContent = formatCurrency(purchase.purchasePrice);
                row.insertCell().textContent = formatCurrency(purchase.totalCost);
                row.insertCell().textContent = formatDate(purchase.date);
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${purchase.uuid}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${purchase.uuid}">Xóa</button>
                `;
            });
            localStorage.setItem('purchaseHistoryData', JSON.stringify(purchaseHistoryData));
            attachTableEventListeners(tbody, 'purchaseHistory');
        }

        function updateOtherExpenseTable() {
            const tbody = document.getElementById('other-expense-table-body');
            tbody.innerHTML = '';
            otherExpensesData.forEach((expense) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = expense.description;
                row.insertCell().textContent = formatCurrency(expense.amount);
                row.insertCell().textContent = formatDate(expense.date);
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${expense.uuid}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${expense.uuid}">Xóa</button>
                `;
            });
            localStorage.setItem('otherExpensesData', JSON.stringify(otherExpensesData));
            attachTableEventListeners(tbody, 'otherExpense');
        }

        function updateSalesTable() {
            const tbody = document.getElementById('sales-table-body');
            tbody.innerHTML = '';
            salesData.forEach((sale) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = formatDate(sale.date);
                row.insertCell().textContent = sale.itemName;
                row.insertCell().textContent = sale.quantity;
                row.insertCell().textContent = formatCurrency(sale.originalPrice || sale.price); // Display original price if discount applied
                row.insertCell().textContent = formatCurrency(sale.price);
                row.insertCell().textContent = sale.discountApplied ? `${sale.discountApplied}%` : '0%';
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${sale.uuid}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${sale.uuid}">Xóa</button>
                `;
            });
            localStorage.setItem('salesData', JSON.stringify(salesData));
            attachTableEventListeners(tbody, 'sale');
        }

        function updateProductItemsTable() {
            const tbody = document.getElementById('product-items-table-body');
            tbody.innerHTML = '';
            productItemsData.forEach((item) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.insertCell().textContent = item.name;
                row.insertCell().textContent = item.defaultUnit;
                row.insertCell().textContent = formatCurrency(item.defaultSellingPrice || 0);
                row.insertCell().textContent = item.shelfLifeDays || 'N/A';
                row.insertCell().textContent = `${item.dailyTargetQuantity || 'N/A'} ${item.dailyTargetUnit || ''}`;
                row.insertCell().textContent = item.dailyTargetUnit || 'N/A';
                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${item.uuid}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${item.uuid}">Xóa</button>
                `;
            });
            localStorage.setItem('productItemsData', JSON.stringify(productItemsData));
            attachTableEventListeners(tbody, 'productItem');
            updateSummaryKPIs();
        }

        function updatePromotionsTable() {
            const tbody = document.getElementById('promotions-table-body');
            tbody.innerHTML = '';
            const today = new Date().toISOString().slice(0, 10);

            promotionsData.forEach((promo) => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                const isActive = promo.startDate <= today && promo.endDate >= today;
                row.insertCell().textContent = promo.name;
                row.insertCell().textContent = `${promo.discountPercentage}%`;
                row.insertCell().textContent = formatDate(promo.startDate);
                row.insertCell().textContent = formatDate(promo.endDate);
                row.insertCell().textContent = isActive ? 'Active' : 'Inactive';
                row.insertCell().classList.add(isActive ? 'text-green-600' : 'text-red-600');

                const actionCell = row.insertCell();
                actionCell.innerHTML = `
                    <button class="edit-btn bg-yellow-500 text-white px-2 py-1 rounded-md text-sm hover:bg-yellow-600 mr-2" data-uuid="${promo.uuid}">Sửa</button>
                    <button class="delete-btn bg-red-500 text-white px-2 py-1 rounded-md text-sm hover:bg-red-600" data-uuid="${promo.uuid}">Xóa</button>
                `;
            });
            localStorage.setItem('promotionsData', JSON.stringify(promotionsData));
            attachTableEventListeners(tbody, 'promotion');
        }

        function updateProductDatalist() {
            const datalist = document.getElementById('product-names-list');
            datalist.innerHTML = '';
            productItemsData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.name;
                datalist.appendChild(option);
            });
        }

        function updateAllTables() {
            updateCustomerTable();
            updateFoodInventoryTable();
            updatePurchaseHistoryTable();
            updateOtherExpenseTable();
            updateSalesTable();
            updateProductItemsTable();
            updatePromotionsTable();
        }

        function updateDailyKpiTable() {
            const tbody = document.getElementById('daily-kpi-table-body');
            tbody.innerHTML = '';
            const todayStr = new Date().toISOString().slice(0, 10);
            const kpiTargetPercentage = parseFloat(kpiTargetPercentageInput.value) / 100 || 0.8;

            productItemsData.forEach(item => {
                if (!item.dailyTargetQuantity || item.dailyTargetQuantity <= 0) return;

                const actualSoldToday = salesData
                    .filter(sale => sale.date === todayStr && sale.itemName.toLowerCase() === item.name.toLowerCase())
                    .reduce((sum, sale) => sum + sale.quantity, 0);

                const kpiAchievement = (actualSoldToday / item.dailyTargetQuantity) * 100;
                const status = kpiAchievement >= (kpiTargetPercentage * 100) ? 'Đạt chỉ tiêu' : 'Chưa đạt';

                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 last:border-b-0';
                row.classList.add(status === 'Đạt chỉ tiêu' ? 'kpi-met' : 'kpi-not-met');

                row.insertCell().textContent = item.name;
                row.insertCell().textContent = `${item.dailyTargetQuantity} ${item.dailyTargetUnit || ''}`;
                row.insertCell().textContent = `${actualSoldToday} ${item.dailyTargetUnit || ''}`;
                row.insertCell().textContent = `${kpiAchievement.toFixed(2)}%`;
                row.insertCell().textContent = status;
            });
        }

        function updateCharts() {
            if (dailyIncomeChartInstance) dailyIncomeChartInstance.destroy();
            if (profitByFoodChartInstance) profitByFoodChartInstance.destroy();
            if (monthlyFinancialChartInstance) monthlyFinancialChartInstance.destroy();

            drawDailyIncomeChart();
            drawProfitByFoodChart();
            drawMonthlyFinancialChart();
        }

        function wrapLabels(label, index, labels) {
            const MAX_CHAR_PER_LINE = 16;
            if (label && label.length > MAX_CHAR_PER_LINE) {
                const words = label.split(' ');
                let lines = [];
                let currentLine = '';
                words.forEach(word => {
                    if ((currentLine + word).length <= MAX_CHAR_PER_LINE) {
                        currentLine += (currentLine === '' ? '' : ' ') + word;
                    } else {
                        lines.push(currentLine);
                        currentLine = word;
                    }
                });
                lines.push(currentLine);
                return lines;
            }
            return label;
        }

        function drawDailyIncomeChart() {
            const ctx = document.getElementById('dailyIncomeChart').getContext('2d');
            const last7Days = Array.from({ length: 7 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (6 - i));
                return d.toISOString().slice(0, 10);
            });

            const incomeByDay = last7Days.map(date => {
                return salesData.filter(sale => sale.date === date)
                                .reduce((sum, sale) => sum + sale.price, 0);
            });

            dailyIncomeChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: last7Days.map(d => formatDate(d)),
                    datasets: [{
                        label: 'Revenue (VND)',
                        data: incomeByDay,
                        borderColor: '#4CAF50',
                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                        fill: true,
                        tension: 0.3
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (VND)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }

        function drawProfitByFoodChart() {
            const ctx = document.getElementById('profitByFoodChart').getContext('2d');

            const foodSales = {};
            salesData.forEach(sale => {
                foodSales[sale.itemName] = (foodSales[sale.itemName] || 0) + sale.price;
            });

            const foodPurchaseCosts = {};
            purchaseHistoryData.forEach(purchase => {
                foodPurchaseCosts[purchase.itemName] = (foodPurchaseCosts[purchase.itemName] || 0) + purchase.totalCost;
            });

            const foodProfit = {};
            const allFoodItems = new Set([...Object.keys(foodSales), ...Object.keys(foodPurchaseCosts)]);
            allFoodItems.forEach(item => {
                const salesRevenue = foodSales[item] || 0;
                const purchaseCost = foodPurchaseCosts[item] || 0;
                foodProfit[item] = salesRevenue - purchaseCost;
            });

            const sortedFoodProfit = Object.entries(foodProfit).sort(([,a],[,b]) => b - a).slice(0, 5);
            const labels = sortedFoodProfit.map(entry => entry[0]);
            const data = sortedFoodProfit.map(entry => entry[1]);

            profitByFoodChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Profit (VND)',
                        data: data,
                        backgroundColor: '#FFC107',
                        borderColor: '#FFB300',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Profit (VND)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Food Item'
                            },
                            ticks: {
                                callback: wrapLabels
                            }
                        }
                    }
                }
            });
        }

        function drawMonthlyFinancialChart() {
            const ctx = document.getElementById('monthlyFinancialChart').getContext('2d');

            const monthlyData = {};

            salesData.forEach(sale => {
                const month = sale.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { income: 0, expenses: 0, purchaseCosts: 0 };
                monthlyData[month].income += sale.price;
            });

            otherExpensesData.forEach(expense => {
                const month = expense.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { income: 0, expenses: 0, purchaseCosts: 0 };
                monthlyData[month].expenses += expense.amount;
            });

            purchaseHistoryData.forEach(purchase => {
                const month = purchase.date.slice(0, 7);
                if (!monthlyData[month]) monthlyData[month] = { income: 0, expenses: 0, purchaseCosts: 0 };
                monthlyData[month].purchaseCosts += purchase.totalCost;
            });


            const sortedMonths = Object.keys(monthlyData).sort();
            const monthlyIncomes = sortedMonths.map(month => monthlyData[month].income);
            const monthlyTotalCosts = sortedMonths.map(month => monthlyData[month].expenses + monthlyData[month].purchaseCosts);
            const monthlyProfits = sortedMonths.map(month => monthlyData[month].income - monthlyTotalCosts[sortedMonths.indexOf(month)]);

            monthlyFinancialChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [
                        {
                            label: 'Monthly Revenue (VND)',
                            data: monthlyIncomes,
                            borderColor: '#42A5F5',
                            backgroundColor: 'rgba(66, 165, 245, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Monthly Expenses (VND)',
                            data: monthlyTotalCosts,
                            borderColor: '#EF5350',
                            backgroundColor: 'rgba(239, 83, 80, 0.2)',
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Monthly Profit (VND)',
                            data: monthlyProfits,
                            borderColor: '#66BB6A',
                            backgroundColor: 'rgba(102, 187, 106, 0.2)',
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.raw);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount (VND)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        }

        function initializeApp() {
            const today = new Date().toISOString().slice(0, 10);
            startDateFilter.value = today;
            endDateFilter.value = today;

            showSection('section-tongquan');
            calculateSummaryForDateRange();
            updateAllTables();
            updateProductDatalist();
            updateCharts();
            updateSummaryKPIs();
        }

        // Helper function to convert array of objects to CSV string
        function convertToCsv(arr, headers = null) {
            if (!arr.length) return '';
            
            const BOM = "\uFEFF"; // Byte Order Mark for UTF-8

            const finalHeaders = headers || Object.keys(arr[0]);
            const headerRow = finalHeaders.map(h => {
                if (typeof h === 'object' && h.label) return `"${h.label.replace(/"/g, '""')}"`;
                return `"${String(h).replace(/"/g, '""')}"`;
            }).join(',');

            const rows = arr.map(row => finalHeaders.map(key => {
                const actualKey = (typeof key === 'object' && key.key) ? key.key : key;
                let value = row[actualKey];

                if (['date', 'lastContact', 'nextFollowup', 'startDate', 'endDate', 'expiryDate'].includes(actualKey)) {
                    value = formatDate(value);
                }
                else if (actualKey === 'type') {
                    value = value === 'mua_thuc_pham' ? 'Food Purchase' : 'Other Variable Expense';
                }
                else if (['amount', 'price', 'quantity', 'purchasePrice', 'totalCost', 'defaultSellingPrice', 'shelfLifeDays', 'dailyTargetQuantity', 'discountPercentage', 'originalPrice', 'purchaseCount', 'loyaltyPoints'].includes(actualKey)) {
                    // For numbers, keep as raw number for CSV, let Excel format if needed
                    value = value !== undefined && value !== null ? parseFloat(value) : '';
                }
                else if (actualKey === 'status' && typeof value === 'boolean') {
                    value = value ? 'Active' : 'Inactive';
                }


                if (typeof value === 'string' && value.includes(',')) {
                    return `"${value.replace(/"/g, '""')}"`;
                }
                return String(value);
            }).join(','));
            return BOM + [headerRow, ...rows].join('\n'); // Prepend BOM
        }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function attachTableEventListeners(tbody, dataType) {
            tbody.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const uuid = event.target.dataset.uuid;
                    editItem(dataType, uuid);
                });
            });

            tbody.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const uuid = event.target.dataset.uuid;
                    deleteItem(dataType, uuid);
                });
            });

            const table = tbody.closest('table');
            if (table) {
                const headers = table.querySelectorAll('th[data-sort-key]');
                headers.forEach(header => {
                    header.addEventListener('click', () => {
                        const sortKey = header.dataset.sortKey;
                        sortTable(dataType, sortKey);
                    });
                });
            }
        }

        let sortDirections = {};

        function sortTable(dataType, sortKey) {
            let dataArray;
            let updateTableFunc;

            switch (dataType) {
                case 'customer':
                    dataArray = customersData;
                    updateTableFunc = updateCustomerTable;
                    break;
                case 'foodInventory':
                    dataArray = foodInventoryData;
                    updateTableFunc = updateFoodInventoryTable;
                    break;
                case 'otherExpense':
                    dataArray = otherExpensesData;
                    updateTableFunc = updateOtherExpenseTable;
                    break;
                case 'sale':
                    dataArray = salesData;
                    updateTableFunc = updateSalesTable;
                    break;
                case 'productItem':
                    dataArray = productItemsData;
                    updateTableFunc = updateProductItemsTable;
                    break;
                case 'purchaseHistory':
                    dataArray = purchaseHistoryData;
                    updateTableFunc = updatePurchaseHistoryTable;
                    break;
                case 'promotion':
                    dataArray = promotionsData;
                    updateTableFunc = updatePromotionsTable;
                    break;
                default:
                    return;
            }

            const currentDirection = sortDirections[`${dataType}-${sortKey}`] === 'asc' ? 'desc' : 'asc';

            dataArray.sort((a, b) => {
                let valA = a[sortKey];
                let valB = b[sortKey];

                if (sortKey.includes('date') || sortKey.includes('Contact') || sortKey.includes('Followup') || sortKey.includes('startDate') || sortKey.includes('endDate') || sortKey.includes('expiryDate')) {
                    valA = new Date(valA);
                    valB = new Date(valB);
                } else if (typeof valA === 'string') {
                    valA = valA.toLowerCase();
                    valB = valB.toLowerCase();
                }

                if (valA < valB) return currentDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentDirection === 'asc' ? 1 : -1;
                return 0;
            });

            sortDirections[`${dataType}-${sortKey}`] = currentDirection;
            updateTableFunc();
        }

        function findItemByUUID(dataArray, uuid) {
            return dataArray.find(item => item.uuid === uuid);
        }

        function findIndexByUUID(dataArray, uuid) {
            return dataArray.findIndex(item => item.uuid === uuid);
        }


        function editItem(dataType, uuid) {
            let dataArray;
            let formElements;
            let addBtn;
            let editingUUIDField;

            switch (dataType) {
                case 'customer':
                    dataArray = customersData;
                    formElements = {
                        name: document.getElementById('customer-name'),
                        phoneNumber: document.getElementById('customer-phone'),
                        lastContact: document.getElementById('customer-last-contact'),
                        nextFollowup: document.getElementById('customer-next-followup'),
                        status: document.getElementById('customer-status')
                    };
                    addBtn = document.getElementById('add-customer-btn');
                    editingUUIDField = 'editingCustomerUUID';
                    break;
                case 'foodInventory':
                    dataArray = foodInventoryData;
                    formElements = {
                        name: document.getElementById('food-item-name'),
                        quantity: document.getElementById('food-item-quantity'),
                        unit: document.getElementById('food-item-unit')
                    };
                    addBtn = document.getElementById('add-food-item-btn');
                    editingUUIDField = 'editingFoodInventoryUUID';
                    break;
                case 'otherExpense':
                    dataArray = otherExpensesData;
                    formElements = {
                        description: document.getElementById('other-expense-description'),
                        amount: document.getElementById('other-expense-amount'),
                        date: document.getElementById('other-expense-date')
                    };
                    addBtn = document.getElementById('add-other-expense-btn');
                    editingUUIDField = 'editingOtherExpenseUUID';
                    break;
                case 'purchaseHistory':
                    dataArray = purchaseHistoryData;
                    formElements = {
                        itemName: document.getElementById('purchase-item-name'),
                        quantity: document.getElementById('purchase-quantity'),
                        unit: document.getElementById('purchase-unit'),
                        purchasePrice: document.getElementById('purchase-price-per-unit'),
                        date: document.getElementById('purchase-date')
                    };
                    addBtn = document.getElementById('add-purchase-btn');
                    editingUUIDField = 'editingPurchaseHistoryUUID';
                    break;
                case 'sale':
                    dataArray = salesData;
                    formElements = {
                        itemName: document.getElementById('sale-item-name'),
                        quantity: document.getElementById('sale-quantity'),
                        price: document.getElementById('sale-price'),
                        date: document.getElementById('sale-date'),
                        customerPhone: document.getElementById('sale-customer-phone')
                    };
                    addBtn = document.getElementById('add-sale-btn');
                    editingUUIDField = 'editingSaleUUID';
                    break;
                case 'productItem':
                    dataArray = productItemsData;
                    formElements = {
                        name: document.getElementById('product-item-name'),
                        defaultUnit: document.getElementById('product-item-default-unit'),
                        defaultSellingPrice: document.getElementById('product-item-default-selling-price'),
                        shelfLifeDays: document.getElementById('product-item-shelf-life-days'),
                        dailyTargetQuantity: document.getElementById('product-item-daily-target-quantity'),
                        dailyTargetUnit: document.getElementById('product-item-daily-target-unit')
                    };
                    addBtn = document.getElementById('add-product-item-btn');
                    editingUUIDField = 'editingProductItemUUID';
                    break;
                case 'promotion':
                    dataArray = promotionsData;
                    formElements = {
                        name: document.getElementById('promo-name'),
                        discountPercentage: document.getElementById('promo-discount-percentage'),
                        startDate: document.getElementById('promo-start-date'),
                        endDate: document.getElementById('promo-end-date')
                    };
                    addBtn = document.getElementById('add-promo-btn');
                    editingUUIDField = 'editingPromoUUID';
                    break;
                default:
                    return;
            }

            const item = findItemByUUID(dataArray, uuid);
            if (item) {
                for (const key in formElements) {
                    if (formElements[key]) {
                        formElements[key].value = item[key];
                    }
                }
                addBtn.textContent = 'Update';
                window[editingUUIDField] = uuid;
            }
        }

        function deleteItem(dataType, uuid) {
            if (!confirm('Are you sure you want to delete this item?')) return;

            let dataArray;
            let updateTableFunc;
            let calculateSummaryNeeded = false;
            let updateChartsNeeded = false;

            switch (dataType) {
                case 'customer':
                    dataArray = customersData;
                    updateTableFunc = updateCustomerTable;
                    calculateSummaryNeeded = true;
                    break;
                case 'foodInventory':
                    dataArray = foodInventoryData;
                    updateTableFunc = updateFoodInventoryTable;
                    break;
                case 'otherExpense':
                    dataArray = otherExpensesData;
                    updateTableFunc = updateOtherExpenseTable;
                    calculateSummaryNeeded = true;
                    updateChartsNeeded = true;
                    break;
                case 'purchaseHistory':
                    dataArray = purchaseHistoryData;
                    updateTableFunc = updatePurchaseHistoryTable;
                    calculateSummaryNeeded = true;
                    updateChartsNeeded = true;
                    // When a purchase is deleted, decrease inventory
                    const deletedPurchase = findItemByUUID(purchaseHistoryData, uuid);
                    if (deletedPurchase) {
                        const inventoryItem = findItemByName(foodInventoryData, deletedPurchase.itemName);
                        if (inventoryItem) {
                            inventoryItem.quantity = (inventoryItem.quantity || 0) - deletedPurchase.quantity;
                        }
                    }
                    updateFoodInventoryTable();
                    break;
                case 'sale':
                    dataArray = salesData;
                    updateTableFunc = updateSalesTable;
                    calculateSummaryNeeded = true;
                    updateChartsNeeded = true;
                    // When a sale is deleted, return quantity to inventory
                    const deletedSale = findItemByUUID(salesData, uuid);
                    if (deletedSale) {
                        const inventoryItem = findItemByName(foodInventoryData, deletedSale.itemName);
                        if (inventoryItem) {
                            inventoryItem.quantity = (inventoryItem.quantity || 0) + deletedSale.quantity;
                        }
                         // Decrement customer's purchase count and loyalty points
                        if (deletedSale.customerPhone) {
                            const customer = customersData.find(c => c.phoneNumber === deletedSale.customerPhone);
                            if (customer) {
                                customer.purchaseCount = (customer.purchaseCount || 0) - 1;
                                customer.loyaltyPoints = (customer.loyaltyPoints || 0) - LOYALTY_POINTS_PER_PURCHASE;
                                updateCustomerTable();
                            }
                        }
                    }
                    updateFoodInventoryTable();
                    break;
                case 'productItem':
                    dataArray = productItemsData;
                    updateTableFunc = updateProductItemsTable;
                    break;
                case 'promotion':
                    dataArray = promotionsData;
                    updateTableFunc = updatePromotionsTable;
                    break;
                default:
                    return;
            }

            const itemIndex = findIndexByUUID(dataArray, uuid);
            if (itemIndex > -1) {
                dataArray.splice(itemIndex, 1);
                updateTableFunc();
                calculateSummaryForDateRange();
                if (calculateSummaryNeeded) updateSummaryKPIs();
                if (updateChartsNeeded) updateCharts();
                updateProductDatalist();
                alert('Item deleted successfully!');
            }
        }

        function findItemByName(array, name) {
            return array.find(item => item.name.toLowerCase() === name.toLowerCase());
        }


        document.getElementById('add-customer-btn').addEventListener('click', () => {
            const name = document.getElementById('customer-name').value.trim();
            const phoneNumber = document.getElementById('customer-phone').value.trim();
            const lastContact = document.getElementById('customer-last-contact').value;
            const nextFollowup = document.getElementById('customer-next-followup').value;
            const status = document.getElementById('customer-status').value;

            if (name && phoneNumber && lastContact && nextFollowup) {
                if (editingCustomerUUID) {
                    const customer = findItemByUUID(customersData, editingCustomerUUID);
                    if (customer) {
                        customer.name = name;
                        customer.phoneNumber = phoneNumber;
                        customer.lastContact = lastContact;
                        customer.nextFollowup = nextFollowup;
                        customer.status = status;
                        alert('Customer info updated successfully!');
                    }
                    editingCustomerUUID = null;
                    document.getElementById('add-customer-btn').textContent = 'Thêm khách hàng';
                } else {
                    if (customersData.some(c => c.phoneNumber === phoneNumber)) {
                        alert('Customer with this phone number already exists!');
                        return;
                    }
                    customersData.push({ uuid: crypto.randomUUID(), name, phoneNumber, lastContact, nextFollowup, status, purchaseCount: 0, loyaltyPoints: 0 });
                    alert('Customer added successfully!');
                }
                updateCustomerTable();
                calculateSummaryForDateRange();
                document.getElementById('customer-name').value = '';
                document.getElementById('customer-phone').value = '';
                document.getElementById('customer-last-contact').value = '';
                document.getElementById('customer-next-followup').value = '';
            } else {
                alert('Please fill in all customer information.');
            }
        });

        document.getElementById('add-food-item-btn').addEventListener('click', () => {
            const name = document.getElementById('food-item-name').value.trim();
            const quantity = parseFloat(document.getElementById('food-item-quantity').value);
            const unit = document.getElementById('food-item-unit').value.trim();

            if (name && !isNaN(quantity) && unit) {
                if (editingFoodInventoryUUID) {
                    const foodItem = findItemByUUID(foodInventoryData, editingFoodInventoryUUID);
                    if (foodItem) {
                        foodItem.name = name;
                        foodItem.quantity = quantity;
                        foodItem.unit = unit;
                        // Expiry date is typically set on purchase, not direct inventory edit, so keep as is
                        alert('Food inventory updated successfully!');
                    }
                    editingFoodInventoryUUID = null;
                    document.getElementById('add-food-item-btn').textContent = 'Thêm/Cập nhật tồn kho';
                } else {
                    if (!productItemsData.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                        productItemsData.push({ uuid: crypto.randomUUID(), name: name, defaultUnit: unit, defaultSellingPrice: 0, shelfLifeDays: 0, dailyTargetQuantity: 0, dailyTargetUnit: '' });
                        updateProductItemsTable();
                        updateProductDatalist();
                    }
                    foodInventoryData.push({ uuid: crypto.randomUUID(), name, quantity, unit, expiryDate: '' }); // Expiry set on purchase
                    alert('Food inventory added successfully!');
                }
                updateFoodInventoryTable();
                document.getElementById('food-item-name').value = '';
                document.getElementById('food-item-quantity').value = '';
                document.getElementById('food-item-unit').value = '';
                updateCharts();
            } else {
                alert('Please fill in all food inventory information.');
            }
        });

        document.getElementById('add-purchase-btn').addEventListener('click', () => {
            const itemName = document.getElementById('purchase-item-name').value.trim();
            const quantity = parseFloat(document.getElementById('purchase-quantity').value);
            const unit = document.getElementById('purchase-unit').value.trim();
            const purchasePrice = parseFloat(document.getElementById('purchase-price-per-unit').value);
            const date = document.getElementById('purchase-date').value;

            if (itemName && !isNaN(quantity) && unit && !isNaN(purchasePrice) && date) {
                const totalCost = quantity * purchasePrice;
                const productItemInfo = productItemsData.find(p => p.name.toLowerCase() === itemName.toLowerCase());
                
                let expiryDate = '';
                if (productItemInfo && productItemInfo.shelfLifeDays) {
                    const purchaseDateObj = new Date(date);
                    purchaseDateObj.setDate(purchaseDateObj.getDate() + productItemInfo.shelfLifeDays);
                    expiryDate = purchaseDateObj.toISOString().slice(0, 10);
                }

                const purchase = { uuid: crypto.randomUUID(), itemName, quantity, unit, purchasePrice, date, totalCost, expiryDate };

                if (editingPurchaseHistoryUUID) {
                    const existingPurchase = findItemByUUID(purchaseHistoryData, editingPurchaseHistoryUUID);
                    if (existingPurchase) {
                        // Revert old inventory change
                        const oldFoodItem = findItemByName(foodInventoryData, existingPurchase.itemName);
                        if (oldFoodItem) oldFoodItem.quantity -= existingPurchase.quantity;

                        // Apply new data
                        Object.assign(existingPurchase, purchase);
                        alert('Purchase transaction updated successfully!');
                    }
                    editingPurchaseHistoryUUID = null;
                    document.getElementById('add-purchase-btn').textContent = 'Thêm Giao dịch Mua';
                } else {
                    purchaseHistoryData.push(purchase);
                    alert('Purchase transaction added successfully!');
                }

                // Update food inventory: Find by name, then update quantity and expiry date
                let foodItem = foodInventoryData.find(item => item.name.toLowerCase() === itemName.toLowerCase());
                if (foodItem) {
                    foodItem.quantity += quantity;
                    foodItem.expiryDate = expiryDate; // Update expiry date with the latest purchase
                } else {
                    // If item doesn't exist in inventory, add it
                    foodInventoryData.push({ uuid: crypto.randomUUID(), name: itemName, quantity: quantity, unit: unit, expiryDate: expiryDate });
                }
                updateFoodInventoryTable();
                updatePurchaseHistoryTable();
                calculateSummaryForDateRange();
                updateCharts();
                document.getElementById('purchase-item-name').value = '';
                document.getElementById('purchase-quantity').value = '';
                document.getElementById('purchase-unit').value = '';
                document.getElementById('purchase-price-per-unit').value = '';
                document.getElementById('purchase-date').value = '';
            } else {
                alert('Please fill in all purchase transaction information.');
            }
        });


        document.getElementById('add-other-expense-btn').addEventListener('click', () => {
            const description = document.getElementById('other-expense-description').value.trim();
            const amount = parseFloat(document.getElementById('other-expense-amount').value);
            const date = document.getElementById('other-expense-date').value;

            if (description && !isNaN(amount) && date) {
                if (editingOtherExpenseUUID) {
                    const expense = findItemByUUID(otherExpensesData, editingOtherExpenseUUID);
                    if (expense) {
                        expense.description = description;
                        expense.amount = amount;
                        expense.date = date;
                        alert('Other expense updated successfully!');
                    }
                    editingOtherExpenseUUID = null;
                    document.getElementById('add-other-expense-btn').textContent = 'Thêm Biến phí';
                } else {
                    otherExpensesData.push({ uuid: crypto.randomUUID(), description, amount, date });
                    alert('Other expense added successfully!');
                }
                updateOtherExpenseTable();
                calculateSummaryForDateRange();
                updateCharts();
                document.getElementById('other-expense-description').value = '';
                document.getElementById('other-expense-amount').value = '';
                document.getElementById('other-expense-date').value = '';
            } else {
                alert('Please fill in all other expense information.');
            }
        });

        document.getElementById('add-sale-btn').addEventListener('click', () => {
            const itemName = document.getElementById('sale-item-name').value.trim();
            const quantity = parseFloat(document.getElementById('sale-quantity').value);
            const originalPrice = parseFloat(document.getElementById('sale-price').value);
            const date = document.getElementById('sale-date').value;
            const customerPhone = document.getElementById('sale-customer-phone').value.trim();
            let finalPrice = originalPrice;
            let discountApplied = 0;

            if (itemName && !isNaN(quantity) && !isNaN(originalPrice) && date) {
                // Check inventory before sale
                let foodItemInInventory = foodInventoryData.find(item => item.name.toLowerCase() === itemName.toLowerCase());

                if (!foodItemInInventory) {
                    alert('Item not found in inventory. Please add it to "Food & Inventory" first.');
                    return;
                }
                
                let availableQuantity = foodItemInInventory.quantity;
                if (editingSaleUUID) {
                    const existingSale = findItemByUUID(salesData, editingSaleUUID);
                    if (existingSale && existingSale.itemName.toLowerCase() === itemName.toLowerCase()) {
                        availableQuantity += existingSale.quantity; // Add back the quantity of the original sale
                    }
                }

                if (availableQuantity < quantity) {
                    alert(`Insufficient stock for ${itemName}. Available: ${foodItemInInventory.quantity} ${foodItemInInventory.unit}.`);
                    return;
                }

                let customer = null;
                if (customerPhone) {
                    customer = customersData.find(c => c.phoneNumber === customerPhone);
                    if (customer && (customer.purchaseCount || 0) >= MIN_LOYALTY_PURCHASES) {
                        const today = new Date().toISOString().slice(0, 10);
                        const activePromo = promotionsData.find(promo => 
                            promo.startDate <= today && promo.endDate >= today
                        );
                        if (activePromo) {
                            discountApplied = activePromo.discountPercentage;
                            finalPrice = originalPrice * (1 - (discountApplied / 100));
                            document.getElementById('discount-applied-text').textContent = `Applied Discount: ${discountApplied}%`;
                        } else {
                            document.getElementById('discount-applied-text').textContent = 'No active promotion.';
                        }
                    } else {
                        document.getElementById('discount-applied-text').textContent = 'Customer not eligible for discount yet (min 3 purchases).';
                    }
                } else {
                    document.getElementById('discount-applied-text').textContent = 'No phone number entered.';
                }

                const sale = { uuid: crypto.randomUUID(), itemName, quantity, originalPrice, price: finalPrice, date, customerPhone, discountApplied };

                if (editingSaleUUID) {
                    const existingSale = findItemByUUID(salesData, editingSaleUUID);
                    if (existingSale) {
                        // Restore old quantity to inventory
                        const oldFoodItem = foodInventoryData.find(item => item.name.toLowerCase() === existingSale.itemName.toLowerCase());
                        if (oldFoodItem) {
                            oldFoodItem.quantity += existingSale.quantity;
                        }

                        // Revert old customer loyalty points if applicable
                        if (existingSale.customerPhone) {
                            const oldCustomer = customersData.find(c => c.phoneNumber === existingSale.customerPhone);
                            if (oldCustomer) {
                                oldCustomer.purchaseCount = (oldCustomer.purchaseCount || 0) - 1;
                                oldCustomer.loyaltyPoints = (oldCustomer.loyaltyPoints || 0) - LOYALTY_POINTS_PER_PURCHASE;
                            }
                        }

                        // Apply new data
                        Object.assign(existingSale, sale);
                        foodItemInInventory.quantity -= quantity; // Deduct new quantity
                        alert('Sales transaction updated successfully!');

                        // Update new customer loyalty points if applicable
                        if (customer) {
                            customer.purchaseCount = (customer.purchaseCount || 0) + 1;
                            customer.loyaltyPoints = (customer.loyaltyPoints || 0) + LOYALTY_POINTS_PER_PURCHASE;
                        }
                    }
                    editingSaleUUID = null;
                    document.getElementById('add-sale-btn').textContent = 'Thêm giao dịch';
                } else {
                    salesData.push(sale);
                    foodItemInInventory.quantity -= quantity; // Deduct from inventory
                    alert('Sales transaction added successfully!');

                    // Update customer's purchase count and loyalty points
                    if (customer) {
                        customer.purchaseCount = (customer.purchaseCount || 0) + 1;
                        customer.loyaltyPoints = (customer.loyaltyPoints || 0) + LOYALTY_POINTS_PER_PURCHASE;
                    }
                }
                updateFoodInventoryTable(); // Update inventory table after sale/edit
                updateSalesTable();
                updateCustomerTable(); // Update customer table for loyalty points
                calculateSummaryForDateRange();
                updateCharts();
                document.getElementById('sale-item-name').value = '';
                document.getElementById('sale-quantity').value = '';
                document.getElementById('sale-price').value = '';
                document.getElementById('sale-date').value = '';
                document.getElementById('sale-customer-phone').value = '';
                document.getElementById('discount-applied-text').textContent = 'Chưa áp dụng giảm giá';
            } else {
                alert('Please fill in all sales transaction information.');
            }
        });

        document.getElementById('add-product-item-btn').addEventListener('click', () => {
            const name = document.getElementById('product-item-name').value.trim();
            const defaultUnit = document.getElementById('product-item-default-unit').value.trim();
            const defaultSellingPrice = parseFloat(document.getElementById('product-item-default-selling-price').value);
            const shelfLifeDays = parseFloat(document.getElementById('product-item-shelf-life-days').value);
            const dailyTargetQuantity = parseFloat(document.getElementById('product-item-daily-target-quantity').value);
            const dailyTargetUnit = document.getElementById('product-item-daily-target-unit').value.trim();

            if (name) {
                if (editingProductItemUUID) {
                    const productItem = findItemByUUID(productItemsData, editingProductItemUUID);
                    if (productItem) {
                        productItem.name = name;
                        productItem.defaultUnit = defaultUnit;
                        productItem.defaultSellingPrice = isNaN(defaultSellingPrice) ? 0 : defaultSellingPrice;
                        productItem.shelfLifeDays = isNaN(shelfLifeDays) ? 0 : shelfLifeDays;
                        productItem.dailyTargetQuantity = isNaN(dailyTargetQuantity) ? 0 : dailyTargetQuantity;
                        productItem.dailyTargetUnit = dailyTargetUnit;
                        alert('Product item updated successfully!');
                    }
                    editingProductItemUUID = null;
                    document.getElementById('add-product-item-btn').textContent = 'Thêm Mặt hàng';
                } else {
                    if (productItemsData.some(item => item.name.toLowerCase() === name.toLowerCase())) {
                        alert('This product item already exists!');
                        return;
                    }
                    productItemsData.push({ 
                        uuid: crypto.randomUUID(), 
                        name, 
                        defaultUnit, 
                        defaultSellingPrice: isNaN(defaultSellingPrice) ? 0 : defaultSellingPrice,
                        shelfLifeDays: isNaN(shelfLifeDays) ? 0 : shelfLifeDays,
                        dailyTargetQuantity: isNaN(dailyTargetQuantity) ? 0 : dailyTargetQuantity,
                        dailyTargetUnit: dailyTargetUnit
                    });
                    alert('Product item added successfully!');
                }
                updateProductItemsTable();
                updateProductDatalist();
                document.getElementById('product-item-name').value = '';
                document.getElementById('product-item-default-unit').value = '';
                document.getElementById('product-item-default-selling-price').value = '';
                document.getElementById('product-item-shelf-life-days').value = '';
                document.getElementById('product-item-daily-target-quantity').value = '';
                document.getElementById('product-item-daily-target-unit').value = '';
                updateCharts();
                updateDailyKpiTable();
            } else {
                alert('Please fill in the product item name.');
            }
        });

        document.getElementById('add-promo-btn').addEventListener('click', () => {
            const name = document.getElementById('promo-name').value.trim();
            const discountPercentage = parseFloat(document.getElementById('promo-discount-percentage').value);
            const startDate = document.getElementById('promo-start-date').value;
            const endDate = document.getElementById('promo-end-date').value;

            if (name && !isNaN(discountPercentage) && startDate && endDate) {
                if (discountPercentage < 0 || discountPercentage > 100) {
                    alert('Discount percentage must be between 0 and 100.');
                    return;
                }
                if (startDate > endDate) {
                    alert('Start date cannot be after end date.');
                    return;
                }

                const promo = { uuid: crypto.randomUUID(), name, discountPercentage, startDate, endDate };
                if (editingPromoUUID) {
                    const existingPromo = findItemByUUID(promotionsData, editingPromoUUID);
                    if (existingPromo) {
                        Object.assign(existingPromo, promo);
                        alert('Promotion updated successfully!');
                    }
                    editingPromoUUID = null;
                    document.getElementById('add-promo-btn').textContent = 'Thêm Khuyến mãi';
                } else {
                    promotionsData.push(promo);
                    alert('Promotion added successfully!');
                }
                updatePromotionsTable();
                document.getElementById('promo-name').value = '';
                document.getElementById('promo-discount-percentage').value = '';
                document.getElementById('promo-start-date').value = '';
                document.getElementById('promo-end-date').value = '';
            } else {
                alert('Please fill in all promotion details.');
            }
        });


        document.getElementById('export-all-data-json-btn').addEventListener('click', () => {
            const allData = {
                salesData: salesData,
                otherExpensesData: otherExpensesData,
                customersData: customersData,
                foodInventoryData: foodInventoryData,
                productItemsData: productItemsData,
                purchaseHistoryData: purchaseHistoryData,
                promotionsData: promotionsData
            };
            const jsonString = JSON.stringify(allData, null, 2);
            downloadFile(jsonString, 'business_data.json', 'application/json');
        });

        document.getElementById('import-data-btn').addEventListener('click', () => {
            document.getElementById('import-data-file').click();
        });

        document.getElementById('import-data-file').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.salesData) salesData = importedData.salesData;
                    if (importedData.otherExpensesData) otherExpensesData = importedData.otherExpensesData;
                    if (importedData.customersData) customersData = importedData.customersData;
                    if (importedData.foodInventoryData) foodInventoryData = importedData.foodInventoryData;
                    if (importedData.productItemsData) productItemsData = importedData.productItemsData;
                    if (importedData.purchaseHistoryData) purchaseHistoryData = importedData.purchaseHistoryData;
                    if (importedData.promotionsData) promotionsData = importedData.promotionsData;


                    localStorage.setItem('salesData', JSON.stringify(salesData));
                    localStorage.setItem('otherExpensesData', JSON.stringify(otherExpensesData));
                    localStorage.setItem('customersData', JSON.stringify(customersData));
                    localStorage.setItem('foodInventoryData', JSON.stringify(foodInventoryData));
                    localStorage.setItem('productItemsData', JSON.stringify(productItemsData));
                    localStorage.setItem('purchaseHistoryData', JSON.stringify(purchaseHistoryData));
                    localStorage.setItem('promotionsData', JSON.stringify(promotionsData));


                    initializeApp();
                    alert('Data imported successfully!');
                } catch (error) {
                    alert('Error reading JSON file. Please check file format.');
                    console.error('Error importing data:', error);
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        });

        document.getElementById('export-summary-csv-btn').addEventListener('click', () => {
            const start = startDateFilter.value ? new Date(startDateFilter.value) : null;
            const end = endDateFilter.value ? new Date(endDateFilter.value) : null;

            let filteredSales = salesData;
            let filteredOtherExpenses = otherExpensesData;
            let filteredPurchases = purchaseHistoryData;
            let filteredCustomers = customersData;

            if (start && end) {
                filteredSales = salesData.filter(sale => {
                    const saleDate = new Date(sale.date);
                    return saleDate >= start && saleDate <= end;
                });
                filteredOtherExpenses = otherExpensesData.filter(expense => {
                    const expenseDate = new Date(expense.date);
                    return expenseDate >= start && expenseDate <= end;
                });
                filteredPurchases = purchaseHistoryData.filter(purchase => {
                    const purchaseDate = new Date(purchase.date);
                    return purchaseDate >= start && purchaseDate <= end;
                });
                filteredCustomers = customersData.filter(customer => {
                    const lastContactDate = new Date(customer.lastContact);
                    return lastContactDate >= start && lastContactDate <= end;
                });
            } else if (start && !end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) >= start);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) >= start);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) >= start);
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) >= start);
            } else if (!start && end) {
                 filteredSales = salesData.filter(sale => new Date(sale.date) <= end);
                 filteredOtherExpenses = otherExpensesData.filter(expense => new Date(expense.date) <= end);
                 filteredPurchases = purchaseHistoryData.filter(purchase => new Date(purchase.date) <= end);
                 filteredCustomers = customersData.filter(customer => new Date(customer.lastContact) <= end);
            }

            const totalIncome = filteredSales.reduce((sum, sale) => sum + sale.price, 0);
            const totalOtherExpense = filteredOtherExpenses.reduce((sum, expense) => sum + expense.amount, 0);
            const totalPurchaseCost = filteredPurchases.reduce((sum, purchase) => sum + purchase.totalCost, 0);
            const estimatedProfit = totalIncome - totalOtherExpense - totalPurchaseCost;
            const uniqueCustomers = new Set(filteredCustomers.map(c => c.name)).size;

            const summaryData = [
                {
                    'Metric': 'Total Revenue',
                    'Value': totalIncome
                },
                {
                    'Metric': 'Customers Interacted',
                    'Value': uniqueCustomers
                },
                {
                    'Metric': 'Estimated Profit',
                    'Value': estimatedProfit
                },
                {
                    'Metric': 'Total Customers (Overall)',
                    'Value': customersData.length
                },
                {
                    'Metric': 'Total Product Items (Overall)',
                    'Value': productItemsData.length
                }
            ];

            if (start && end) {
                summaryData.unshift({ 'Metric': 'Date Range', 'Value': `${formatDate(start.toISOString().slice(0,10))} - ${formatDate(end.toISOString().slice(0,10))}` });
            } else if (start) {
                summaryData.unshift({ 'Metric': 'Date Range', 'Value': `From ${formatDate(start.toISOString().slice(0,10))}` });
            } else if (end) {
                summaryData.unshift({ 'Metric': 'Date Range', 'Value': `Up to ${formatDate(end.toISOString().slice(0,10))}` });
            }

            const headers = [
                { key: 'Metric', label: 'Metric' },
                { key: 'Value', label: 'Value' }
            ];
            const csv = convertToCsv(summaryData, headers);
            downloadFile(csv, 'overall_summary.csv', 'text/csv;charset=utf-8;');
        });


        document.getElementById('export-customers-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Customer Name' },
                { key: 'phoneNumber', label: 'Phone Number' },
                { key: 'lastContact', label: 'Last Contact Date' },
                { key: 'nextFollowup', label: 'Next Followup Date' },
                { key: 'status', label: 'Status' },
                { key: 'purchaseCount', label: 'Purchase Count' },
                { key: 'loyaltyPoints', label: 'Loyalty Points' }
            ];
            const csv = convertToCsv(customersData, headers);
            downloadFile(csv, 'customers.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-food-inventory-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Food Item Name' },
                { key: 'quantity', label: 'Quantity' },
                { key: 'unit', label: 'Unit' },
                { key: 'expiryDate', label: 'Expiry Date' }
            ];
            const csv = convertToCsv(foodInventoryData, headers);
            downloadFile(csv, 'food_inventory.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-purchase-history-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'itemName', label: 'Item Name' },
                { key: 'quantity', label: 'Quantity' },
                { key: 'unit', label: 'Unit' },
                { key: 'purchasePrice', label: 'Unit Purchase Price' },
                { key: 'totalCost', label: 'Total Cost' },
                { key: 'date', label: 'Date' },
                { key: 'expiryDate', label: 'Expiry Date' }
            ];
            const csv = convertToCsv(purchaseHistoryData, headers);
            downloadFile(csv, 'purchase_history.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-other-expenses-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'description', label: 'Description' },
                { key: 'amount', label: 'Amount (VND)' },
                { key: 'date', label: 'Date' }
            ];
            const csv = convertToCsv(otherExpensesData, headers);
            downloadFile(csv, 'other_expenses.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-sales-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'date', label: 'Date' },
                { key: 'itemName', label: 'Product/Service Name' },
                { key: 'quantity', label: 'Quantity' },
                { key: 'originalPrice', label: 'Original Revenue (VND)' },
                { key: 'price', label: 'Final Revenue (VND)' },
                { key: 'discountApplied', label: 'Discount Applied (%)' },
                { key: 'customerPhone', label: 'Customer Phone' }
            ];
            const csv = convertToCsv(salesData, headers);
            downloadFile(csv, 'sales.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-product-items-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Item Name' },
                { key: 'defaultUnit', label: 'Default Unit' },
                { key: 'defaultSellingPrice', label: 'Default Selling Price (VND)' },
                { key: 'shelfLifeDays', label: 'Shelf Life (Days)' },
                { key: 'dailyTargetQuantity', label: 'Daily Target Quantity' },
                { key: 'dailyTargetUnit', label: 'Daily Target Unit' }
            ];
            const csv = convertToCsv(productItemsData, headers);
            downloadFile(csv, 'product_items.csv', 'text/csv;charset=utf-8;');
        });

        document.getElementById('export-promotions-csv-btn').addEventListener('click', () => {
            const headers = [
                { key: 'name', label: 'Promotion Name' },
                { key: 'discountPercentage', label: 'Discount Percentage' },
                { key: 'startDate', label: 'Start Date' },
                { key: 'endDate', label: 'End Date' }
            ];
            const csv = convertToCsv(promotionsData, headers);
            downloadFile(csv, 'promotions.csv', 'text/csv;charset=utf-8;');
        });


        // Event Listeners for Navigation
        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const sectionId = `section-${item.id.replace('nav-', '')}`;
                showSection(sectionId);
            });
        });

        // Event listeners for date filters and low stock threshold
        startDateFilter.addEventListener('change', calculateSummaryForDateRange);
        endDateFilter.addEventListener('change', calculateSummaryForDateRange);
        lowStockThresholdInput.addEventListener('change', updateFoodInventoryTable);
        minDaysBeforeExpiryWarningInput.addEventListener('change', updateFoodInventoryTable);
        kpiTargetPercentageInput.addEventListener('change', updateDailyKpiTable);


        document.getElementById('update-kpi-targets-btn').addEventListener('click', () => {
            const kpiTargetPercentage = parseFloat(kpiTargetPercentageInput.value) / 100 || 0.8;
            const todayStr = new Date().toISOString().slice(0, 10);

            productItemsData.forEach(item => {
                if (!item.dailyTargetQuantity || item.dailyTargetQuantity <= 0) return;

                const actualSoldToday = salesData
                    .filter(sale => sale.date === todayStr && sale.itemName.toLowerCase() === item.name.toLowerCase())
                    .reduce((sum, sale) => sum + sale.quantity, 0);

                const kpiAchievement = (actualSoldToday / item.dailyTargetQuantity);

                if (kpiAchievement < kpiTargetPercentage) {
                    // Increase target by a small percentage, e.g., 5%
                    item.dailyTargetQuantity = Math.ceil(item.dailyTargetQuantity * 1.05);
                }
            });
            updateProductItemsTable(); // Refresh the table where product item targets are shown
            updateDailyKpiTable(); // Recalculate and display KPIs
            alert('Daily KPI targets updated for next day based on today\'s performance!');
        });


        initializeApp();
    </script>
</body>
</html>
